 <!-- new -->
<link rel="stylesheet" type="text/css" href="/static/css/productStyles.css">
<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Optional: Preline PIN Input styles -->
    <script src="https://cdn.tailwindcss.com"></script>
     <!-- Required: Preline PIN Input logic -->
     <script src="/static/preline.js"></script>	
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="/static/css/productStyles.css">	
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">	
    <link rel="manifest" href="/static/manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
        <meta name="theme-color" content="white">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="/static/css/progressBar.css">
    <meta property="og:image" content="/static/Bicycle.png" />
    <script src="https://js.stripe.com/v3/"></script>  <!-- new -->
    <script defer src="https://use.fontawesome.com/releases/v6.4.0/js/all.js"></script>
    <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>
    
<script>
     const phone_number ="+19193609602";
     const latitude = "35.906102724086054";
     const longitude ="-79.0669912804284";
     let  destination_label = "Levent C"; 
     let instructions = "{&#x27;dropoff_option&#x27;: &#x27;Leave at Door&#x27;, &#x27;delivery_time_preference&#x27;: &#x27;ASAP&#x27;, &#x27;apartment_number&#x27;: &#x27;&#x27;, &#x27;access_instructions&#x27;: &#x27;&#x27;, &#x27;instructions&#x27;: &#x27;Leave at door&#x27;}";
        
     console.log("latitude:", latitude);
     console.log("longitude:", longitude);
     console.log("phone_number:", phone_number);


    </script>
    
    <script>
    var jsOpenStores = [{'store_name': "Al'S Burger Shack", 'delivery_price': '2.00', 'link': 'https://alsburgershack.com/', 'link_image': 'store_logos/alsburgershack.png', 'link_type': 'website', 'apple_link': 'toasttakeout://order.toasttab.com/online/spicy9', 'android_link': 'toasttakeout://order.toasttab.com/online/spicy9', 'external_image_link': 'https://s.yimg.com/fz/api/res/1.2/Oi.Bm6AXqy1mSI2DhG_1EQ--~C/YXBwaWQ9c3JjaGRkO2g9MTAwMDtxPTgwO3c9NzUw/https://s.yimg.com/bj/02e2/02e2293ff7d14558a201ba019edfa43c.jpg', 'store_category': 'restaurant', 'store_type': 'american', 'hours_of_operation': '11AM - 9PM', 'store_latitude': 35.91131805165857, 'store_longitdue': -79.06394697095067}, {'store_name': 'Neils Deli', 'delivery_price': '2.00', 'link': 'https://nealsdeli.com/', 'link_image': 'store_logos/neilsdeli.jpeg', 'link_type': 'website', 'apple_link': 'https://apps.apple.com/us/app/local-by-toast/id1362180579', 'android_link': 'toasttakeout://order.toasttab.com/online/spicy9', 'external_image_link': 'https://s.yimg.com/fz/api/res/1.2/Oi.Bm6AXqy1mSI2DhG_1EQ--~C/YXBwaWQ9c3JjaGRkO2g9MTAwMDtxPTgwO3c9NzUw/https://s.yimg.com/bj/02e2/02e2293ff7d14558a201ba019edfa43c.jpg', 'store_category': 'restaurant', 'store_type': 'american', 'hours_of_operation': '11:30AM - 2:30PM', 'store_latitude': 35.910285766301385, 'store_longitdue': -79.07216510434458}, {'store_name': 'The Purple Bowl', 'delivery_price': '2.00', 'link': 'https://www.purplebowlch.com/', 'link_image': 'store_logos/thepurplebowl.png', 'link_type': 'website', 'apple_link': 'https://apps.apple.com/us/app/purple-bowl/id1477271617', 'android_link': 'https://play.google.com/store/apps/details?id=ca.craver.purplebowl&pcampaignid=web_share', 'external_image_link': 'https://s.yimg.com/fz/api/res/1.2/2AEUc_6JYMZ._eslCqZsQA--~C/YXBwaWQ9c3JjaGRkO2ZpPWZpbGw7aD0xODA7cT04MDt3PTE4MA--/https://s.yimg.com/bj/ce87/ce87d0041c13da20a0659ce8953e9ab3.jpg', 'store_category': 'restaurant', 'store_type': 'coffee_tea', 'hours_of_operation': '11AM - 9PM', 'store_latitude': 35.91003747366489, 'store_longitdue': -79.06380550674649}];
    console.log('here'); 
    console.log(jsOpenStores); // Unescaped HTML string

    let uncheckedStoreMarkers = [];
let storeMarkerCluster = null;





</script>

    <title>Delivery Destination</title>
    <!-- Include the Google Maps API script -->
     <style>
:root {
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;	
}
/*
button,
input,
select,
textarea {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  font-weight: 400; /* Matches Segoe UI Regular */
  letter-spacing: 0.2px; /* Slightly tighter spacing like Segoe */
//  line-height: 1.4; /* Improves vertical rhythm */
  -webkit-font-smoothing: antialiased; /* Crisper rendering on iOS */
  -webkit-appearance: none;
  appearance: none;
}

.touch-lock {
  pointer-events: none;
  touch-action: none;

  /* Visual Feedback */
  opacity: 0.6;
//  backdrop-filter: blur(2px); /* Adds depth without disrupting layout */
  transition:
    opacity 300ms ease-in-out,
 //   backdrop-filter 300ms ease-in-out;
}
.custom-cluster {
    background-color: black; /* Tomato red */
    color: white;
    font-size: 14px;
    font-weight: bold;
    padding: 5px 10px;
    border-radius: 50%;
    text-align: center;
    box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.3);
}
/*
.property {
  align-items: center;
//  background-color: #FFFFFF;
  border-radius: 50%;
  color: #263238;
  display: flex;
  font-size: 14px;
  gap: 15px;
  height: 30px;
  justify-content: center;
  padding: 4px;
  position: relative;
  transition: all 0.3s ease-out;
  width: 30px;
  top:-10px;
  left:-5px; 
}
*/
.property {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding-bottom: 25px !important;
}

.property::after {
  border-left: 9px solid transparent;
  border-right: 9px solid transparent;
  border-top: 9px solid #FFFFFF;
//  content: "";
  height: 0;
  left: 50%;
  position: absolute;
  top: 95%;
  transform: translate(-50%, 0);
  transition: all 0.3s ease-out;
  width: 0;
  z-index: 1;
}
/*
.property .icon {
  align-items: center;
  display: flex;
  justify-content: center;
  color: black;
}

*/

.property .icon svg {
//  height: 27px;
//  width: auto;
}

.property .details {
  display: none;
  flex-direction: column;
  flex: 1;
  margin-left:50px; 
}

.property .address {
  color: #9E9E9E;
  font-size: 10px;
  margin-bottom: 10px;
  margin-top: 5px;
}

.property .features {
  align-items: flex-end;
  display: flex;
  flex-direction: row;
  gap: 10px;
}

.property .features > div {
  align-items: center;
  background: #F5F5F5;
  border-radius: 5px;
  border: 1px solid #ccc;
  display: flex;
  font-size: 10px;
  gap: 5px;
  padding: 5px;
}

/* Property styles in highlighted state. */
.property.highlight {
  background-color: #FFFFFF;
  border-radius: 8px;
  box-shadow: 10px 10px 5px rgba(0, 0, 0, 0.2);
  height: 80px;
  padding: 8px 15px;
  width: auto;
}

.property.highlight::after {
  border-top: 9px solid #FFFFFF;
}

.property.highlight .details {
  display: flex;
}

.property.highlight .icon svg {
  width: 50px;
  height: 50px;
}
/* CSS to hide the image by default */
.store-logo.hidden {
  display: none;
}

/* CSS to hide the FontAwesome icon */
.icon .fa-icon.hidden {
  display: none;
}
.store-logo{
	display:block;
}
/* CSS to show the image */
.property.highlight .store-icon {
  display: block;
}
.property.highlight .fa-store {
  display: none;
}
/* CSS to hide the image when not highlighted */
.property:not(.highlight) .store-icon {
  display: none;
}


/*

        .property .icon-background {
            background-color:black;
            border:0px solid black;
            border-radius: 50% 50% 50% 0;
	    box-shadow: 0 2px 10px rgba(0, 0, 0,1); 
            width: 44px;
            height: 44px;
            position: absolute;
            transform: rotate(-45deg);
            left: 0px;
            top: -7px;		
        }
*/
	.property .icon-background{	
    width: 36px;
    height: 36px;
    background-color: rgb(255, 255, 255);
    position: absolute;
    border: 0px solid black;
    border-radius: 50% 50% 50% 0px;
    box-shadow: rgb(0, 0, 0) 0px 2px 10px;
    transform: rotate(-45deg);	
	} 
.property .icon {
    font-family: 'Font Awesome 5 Free';
    font-weight: 900;
    font-size: 18px;
    color: #0f0f0f;
    position: absolute;
}
	/*
        .property .icon {
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            font-size: 24px;
            color: white;
            position: absolute;
            top: 4px;
            left: 7px;
//            transform: rotate(-45deg);

        }
	*/

.home-marker{
//     display: flex;
//    flex-direction: column;
//    align-items: center;
//    justify-content: center;
//    padding-bottom:25px;
}



.icon-background{
    width: 36px;
    height: 36px;
    background-color: #fff;
    position: absolute;
    border: 0px solid black;
    border-radius: 50% 50% 50% 0;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 1);
    transform: rotate(-45deg);
}

.icon{

    font-family: 'Font Awesome 5 Free';
    font-weight: 900;
    font-size: 18px;
    color: #0f0f0f;
    position: absolute;

}	
/*

        .home-marker {
            position: relative;
            width: 44px;
            height: 44px;
            cursor: pointer;
	    top:-5px;
	    left:-2px;
        }

        .home-marker .icon-background {
            background-color: #007bff;
	    border:0px solid black;
            border-radius: 50% 50% 50% 0;
	    box-shadow: 0 2px 10px rgba(0, 0, 0,1); 
            width: 44px; 
            height: 44px;
            position: absolute;
            transform: rotate(-45deg);
            left: 0px;
            top: -7px;
        }

        .home-marker .icon {
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            font-size: 24px;
            color: white;
            position: absolute;
            top: 3px;
            left: 9px;
        }
*/	

        .home-marker .details {
            display: none;
            position: absolute;
            top: 50px; /* Adjust as needed */
            left: 50px; /* Adjust as needed */
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1;
            width: 200px; /* Adjust as needed */
        }

        .home-marker.highlight {
            width: auto;
            height: auto;
        }

        .home-marker.highlight .details {
            display: block;
        }	

.courier-marker {
  position: absolute;
//  transform: translate(-50%, -100%);
  pointer-events: none;
  filter: drop-shadow(0 2px 6px rgba(0, 0, 0, 0.4));
}

/* Rocking animation on outer wrapper */
.courier-rocker {
  animation: rock 1.8s infinite ease-in-out;
  transform-origin: bottom center;
  will-change: transform;
}

/* Pulse animation on inner wrapper */
.courier-pulse {
  animation: pulse 3s infinite ease-in-out;
  will-change: transform;
}

/* Your custom background shape */
.icon-background {
  background-color: #333333;
  border-radius: 50% 50% 50% 0;
  width: 30px;
  height: 30px;
  position: absolute;
  transform: rotate(-45deg);
}

/* Font Awesome icon styling */
.courier-icon {
  font-family: 'Font Awesome 5 Free';
  font-weight: 900;
  font-size: 14px;
  color: white;
  position: relative;
  text-align: center;
  line-height: 30px;
}

/* Rocking animation */
@keyframes rock {
  0%, 100% { transform: rotate(0deg); }
  25% { transform: rotate(4deg); }
  75% { transform: rotate(-4deg); }
}

/* Pulse animation */
@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}
.courier-marker .details {
    display: none;
    position: absolute;
    top: 50px; /* Adjust for visibility */
    left: 50px; /* Align properly */
    background-color: white;
    padding: 10px;
    border-radius: 5px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    z-index: 1;
    width: 200px; /* Adjust as needed */
}

.courier-marker.highlight {
    width: auto;
    height: auto;
}

.courier-marker.highlight .details {
    display: block;
}

.pulsate {
    animation: pulsate-border 2s infinite;
}

@keyframes pulsate-border {
    0% { box-shadow: 0 0 2px green; }
    50% { box-shadow: 0 0 50px green; }
    100% { box-shadow: 0 0 2px green; }
}
.courier-marker {
  position: relative;
  width: 30px;
  height: 30px;
  transform: translate(-50%, -100%);
  z-index: 10;
}

.courier-icon {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  background: radial-gradient(circle at 30% 30%, #10b981, #065f46);
  box-shadow:
    0 4px 8px rgba(0, 0, 0, 0.3),
    inset 0 2px 4px rgba(255, 255, 255, 0.2);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  border: 1px solid white;
}

:focus {
    outline: none;
}
div[style*="pointer-events: none;"][style*="border: 2px solid rgb(26, 115, 232);"] {
    border: none;
}


.order-info{
  height:100px;
  margin:0 auto; 
}
.cancelButton {
  color: #0F0F0F !important;
  font-size: 28px;
  text-shadow: 0px 0px 0px #000000;
  padding: 8px 8px;
  border-radius: 0px;
  border: 2px solid #050A0F;
  background: #FFFFFF;
  white-space:normal;
  margin-top: 0px;
}
.cancelButton:hover {
  color: white !important;
  background: black;
}

.my-header {
    position:relative;
    width: 100%;
    border:2px;
    background-color: #f0f0f0; /* Set your desired background color */
    height: 20px; /* Set your desired header height */
    z-index: 100; /* Optional: Adjust the stacking order if needed */
}
.custom-button {
//  color: white !important;
  font-size: 16px;
  text-shadow: 0px 0px 0px #000000;
  padding: 12px 62px;
  border-radius: 40px;
  border: none;
  background: #007bff;
  white-space:normal;
  transition: color 0.3s ease, background 0.3s ease;
}
.custom-button:active {
  color: black !important;
  background: white;
}
.custom-button.pressed {
  color: black !important;
  background: white;
}
.submitStores {
  position: absolute;
  right:0; 
  top:0;
  color: #0F0F0F !important;
  font-size: 64px;
  text-shadow: 0px 0px 0px #000000;
  padding: 8px 15px;
  border-radius: 0px;
  border: 0px solid #050A0F;
  background: #FFFFFF;
   transition: color 0.3s ease, background 0.3s ease;
}
.submitStores:active {
  color: white !important;
  background: black;
}
.submitStores.pressed {
  color: white !important;
  background: black;
}

#map {
  touch-action:none;
  position:relative;
  width: 100%;
  height: 100%;
  z-index: 0; /* Ensure the map is under other elements */
}	    
        }
#map:focus {
    border:5px; /* Remove the focus outline */
}
	ul {
    list-style-type: none;
    padding-left:0;
    font-size: 16px; /* Increase font size */
    font-weight: bold; /* Make the text bold */
    margin-left: 5px;
}
.checkbox-container input[type="checkbox"]:checked {
    display: none; /* Show the container when the checkbox is checked */
//    -webkit-appearance:none; 
}


/* Show the label only when checkbox is checked */
.checkbox-container input[type="checkbox"]:checked + .checkbox-remove {
    background: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 35px;
    height: 35px;
    color: #050a0f;
    font-size: 25px;
    font-weight: bold;
    display:inline-flex !important; 
}


input[type=file]::file-selector-button {
  margin-right: 20px;
  border: none;
  background: black;
  padding: 10px 20px;
  border-radius: 10px;
  color: #fff;
  cursor: pointer;
  transition: background .2s ease-in-out;
}

input[type=file]::file-selector-button:hover {
  background: white;
  color: black;
}
.overlay-container {
    position: absolute;
    min-width: 100vw;  /* ✅ Ensures full width */
    min-height: 100vh;    
    background: white;
    z-index: 999;
    display: flex;
    align-items: center; /* ✅ Keep elements centered horizontally */
    justify-content: center; /* ✅ Center everything */
    flex-direction: column; /* ✅ Stack items vertically */
}

.overlay-image {
    position: absolute; /* ✅ Ensures it stays perfectly centered */
    top: 47%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 150px;
    height: auto;
    border-radius: 28px;
}

.loading-container {
    position: absolute;
    top: calc(50% + 80px); /* ✅ Pushes spinner & text below the centered image */
    text-align: center;
    padding:20px; 
    color:white; 
}

.loading-container i {
    font-size: 40px;
    color: white;
}

#loading-text {
    font-size: 18px;
    color: white;
    margin-top: 16px;
}
.fa-spin{
font-size:30px;
animation-duration: 0.5s !important;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.loader {
  top:50%; 
  border: 0px solid black; /* Light grey */
  border-top: 0px solid black; /* Blue */
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin .25s linear infinite;
}
		
	html,body {
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;		
    display:flex;
    touch-action: none; 
    margin:0;
    padding:0;
    overflow:hidden;
    background:black;
    height:100%;
    place-items:center; 

    

}
.sortable th {
    cursor: pointer;
}

    /* Logo styles */
    .logo {
        max-width: 50px; /* Adjust the size as needed */
        display: block; /* Center the logo horizontally */
        margin: 0 auto;
    }
    .close {
	font-size:35px;
	background: #3333;
	margin-left:20px;
	color:white !important;
	border: 0px solid white;
	padding:8px 15px;
}
	.clickMerchantLabel{
        font-size:28px;
        border:0px; 
        color:black;
	font-weight:100;
	margin-left: 30px;
         margin-top: 20px;
	 display:none; 
       
	}		
	.close:active {
  color: white !important;
  background: black;
}
.close.pressed {
  color: white !important;
  background: black;
}
/*
input[type="file"]::-webkit-file-upload-button {
  color: #0F0F0F !important;
  font-size: 18px;
  text-shadow: 0px 0px 0px #000000;
  padding: 8px 8px;
  border-radius: 0px;
  border: 2px solid #050A0F;
  background: #FFFFFF;
  white-space:normal;
  transition: color 0.3s ease, background 0.3s ease;
}
*/
/* Style the header container */
.header {
 
  justify-content: space-between;
  align-items: center;
  background-color:#333;
//  padding: 20px;
  position:relative;
  z-index:1;
//  height:10px;
  width:100%;
  border-bottom:3px solid #fff;
  display:flex; 


}

/* Style the logo image */
.logo {
  width: 50px;
  height: auto;
}

/* Style the buttons */
.logout-button,
.info-button {
  padding: 5px 10px;
  font-size: 14px;
  border: none;
  cursor: pointer;
}

/* Adjust styles for individual buttons */
.logout-button {
  background-color: #ff6347; /* Red color for logout */
  color: white;
}

.info-button {
  background-color: #6495ed; /* Blue color for info */
  color: white;
}
.instructions-overlay-container {
  position: fixed;
  top: 0;
  right: -100%; /* Initially hidden */
  width: 100%;
  height: 100%;
  background-color: white; /* Semi-transparent background */
  transition: right 0.3s ease; /* Add smooth transition effect */
  z-index:9999999;
  overflow-y: auto;
}
        .image-container {
            position: relative;
            display:inline-block;
        }
        .image-container img {
                display:none;
        }
       .image-text {
display: flex;
background-color: transparent;
font-size: 24px;
text-align: center;
font-family: Roboto, sans-serif;
font-weight: 900;
color: black;
justify-content: center; /* Remove conflicting "left" */
align-items: center; /* Ensures vertical centering */
margin-left: 15px;/* Combines margin-top & margin-left */
margin-top:10px;  
 }
       .guidanceDetails{
	       padding: 17px;
    background: black;
    color: white;
    border: 0px solid;
    font-size: 18px;
    display: none;
    max-width: 400px;
    width: 400px;
    margin-left: 10px;
    margin-right: 5px;
    border-radius: 50px;
    font-weight: 600;    
}



	
        /* Blink animation */
        @keyframes blink {
            0% {
                opacity: 1;
            }
            100% {
                opacity: 0.7;
            }
  }
	#order-upload-overlay{
              display:flex !important; 
        //    overflow:scroll; 
//            position: fixed;
//            top: -100%;
//            left: 50%;
//            transform: translate(-50%, -50%);            
	      justify-content:center;            
//            height:500px;
            background-color: transparent; /* Yellow background */
            color: white; /* Dark text color */
            font-size: 18px;
            padding: 0px;
            text-align: center;
//            transition: top 0.5s ease-in-out;
//	    touch-action: pan-y; /* Allow vertical scrolling */
//            overflow-y: scroll;
//	    overflow-x: hidden; 
//            box-shadow: 8px 12px rgba(0, 0, 0, 0.1);
//	    border: 2px solid;
//	    border-radius: 10px;
        }
.order-upload-overlay2 {
	display:none; 
	background:transparent;
	color:white;
	border-radius:10px;
}

	.order-image-container {




	}


  .store-order-tracker {
    display: inline-flex;
    align-items: start;
    justify-content:space-between;
    width:95%; 
//    margin-bottom: 10px; /* Adjust spacing between store orders */
  }

  .store-order {
	  display:inline-flex;
	  align-items:center; 
	  justify-content:space-between;
  }
  .tracker-store-swiper{
	  background:none;
	  border:none;
	  flex-direction:column; 
	  margin-top:14px; 
	  gap:10px;
   	  display:flex; 
  }
  .store-order button {
    display: flex;
    align-items: center;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 16px;
    color: black; /* Customize text color */
    margin-right: 5px; /* Adjust spacing between image and text */
    gap:8px;
    flex-direction:column; 
  }

  .store-order img {
    margin-right: 5px; /* Adjust spacing between image and text */

  }

 .crosshairs {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 50px;
        height: 50px;
        margin-left: -25px;
        margin-top: -25px;
        pointer-events: none; /* Allow map interactions */
        background: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50"><circle cx="25" cy="25" r="20" stroke="black" stroke-width="2" fill="none"/><line x1="25" y1="5" x2="25" y2="45" stroke="black" stroke-width="2"/><line x1="5" y1="25" x2="45" y2="25" stroke="black" stroke-width="2"/><line x1="25" y1="15" x2="25" y2="35" stroke="black" stroke-width="1" stroke-dasharray="2,2"/><line x1="15" y1="25" x2="35" y2="25" stroke="black" stroke-width="1" stroke-dasharray="2,2"/><circle cx="25" cy="25" r="2" stroke="black" stroke-width="2" fill="black"/></svg>') no-repeat center;
      }

.child-row {
    display: none; /* Initially hidden */
}

.child-row.show {
 // display: table-row; /* Show when expanded */
    display:none; 
}
    .store-info{
	    display:flex;
            flex-direction:column; 



    }
    .checkbox-text{
   font-size:20px;
    }
.expand-button {
    position:absolute;
    top:10px;
    right:25px; 
    flex:1;
    text-align:right;
    font-size: 20px; /* Increase font size */
    cursor: pointer;
    padding: 0px; /* Add padding */
    border: none; /* Remove default border */
    background: none; /* Remove default background */
    outline: none; /* Remove default outline */
    border-radius: 5px; /* Add border radius */
    transition: transform 0.3s ease, background-color 0.3s ease;
    color:green;
}

/* Initially, the button shows a plus sign */
.expand-button::after {
//    content: "+"; /* Plus sign */
    display: inline-block;
    margin-right: 5px; /* Add some spacing */
    transition: transform 0.3s ease;
    font-size:26px;
    color:#007bff;
}

/* When expanded, rotate the plus sign to a minus sign */
.expand-button.expanded::after {
//    content: "\2713";; /* check sign */
    color:black;
    transform: rotate(360deg) scale(1.2); /* Rotate and scale */
    font-size:20px;
}
    .store-link {
            display: flex;
            align-items: center;
            width: 90%;
            background-color: rgb(255, 255, 255);
//            border: 1px solid rgb(206, 203, 208);
//            border-radius: 0px 0px 8px 8px;
            padding: 15px;
            transition: box-shadow 0.5s;
            cursor: pointer;
	    height:35px; 
    }
    .store-label {
        flex: 1;
        text-align: center;
    }
    .toast-image-container {
        width:auto;
	text-align:center;
    }
    .store-image {
	    width:50px;
	    height:50px; 
    }
    .store-logo {
        width: 50px;
        height: 50px;
    }    
.checkbox-container {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;    
    border-bottom: 0px solid rgb(206, 203, 208);
    display: flex;
    -webkit-box-align: center;
    align-items: center;
    transition: box-shadow 0.5s;
    cursor: pointer;
    position: relative;
    height:80px; 
     box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1)

}
.checkbox-container{
    transition: all 0.5s ease-in-out;
    opacity: 1;
    position: relative;
    display: inline-block;
    width: 95%;
    position: relative;
    border-top: 1px solid #eee;
    display: flex;
    -webkit-box-align: center;
    align-items: center;
    transition: box-shadow 0.5s;
    cursor: pointer;
    background: linear-gradient(to bottom, #ffffff 0%, #f7f7f7 50%, #eeeeee 100%);
    border-radius: 10px;
    margin: 16px;
    margin-bottom: 0px;
    margin-top: 15px;
}
/*
.checkbox-container: checked{
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;	
    position: relative;
    display: inline-block;
    width: 90%;
    position: relative;
//  background-color: rgb(255, 255, 255);
    border-top: 2px solid rgb(206, 203, 208);
    display: flex;
    -webkit-box-align: center;
    align-items: center;
//    padding: 15px;
    transition: box-shadow 0.5s;
    cursor: pointer;
    position: relative;
    height:125px;
    display:none;
     box-shadow: none;
     background:none;
     border:none;
     transition: height 0.5s;
     margin-top:0; 

}
*/
.sortable{
	width:100%;
}
.checkbox-container input[type="checkbox"] {
//    -webkit-appearance:none;
    background:grey;
    color:black;
    opacity: 0.5;
    position: absolute;
    width: 25px;
    height: 25px;
    cursor: pointer;
  
    display:none;
}

.checkbox-container label {
    display: flex;
    color: black;
    border-radius: 0px;
    padding-bottom: 5px;
    padding-top: 5px;
    padding-left: 5px;
    padding-right: 5px;
    cursor: pointer
    transition: all .2s;
    width:100%;
    align-items:center;
}
.checkbox-remove {
    display:none !important;
}
.checkbox-container input[type="checkbox"]:checked + label {
    transition: all .2s;
//  border:3px solid #ffffff;
//  border-radius:15px; 
}
.checkbox-container input[type="checkbox"]:unchecked + label {
//  border: 2px solid black;
    background-color: black;
    color: white;
    transition: all .2s;
}
.checkbox-price{
	flex:1;
	text-align:center;
	padding-right:10px;
}
.checkbox-container checkbox-text {
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;	
    display: inline-block;
    vertical-align: middle;
    font-size:20px;
    width:118px;
    padding-left:15px; 
}
/* Style The Dropdown Button */
.dropbtn {
font-family: 'Roboto';
    color: #fff !important;
    font-size: 30px;
    text-shadow: 0px 0px 0px #000000;
    padding: 10px 10px;
    border-radius: 0px;
    border: 0px solid rgb(206, 203, 208);
    background: #007bff;
    transition: color 0.3s ease, background 0.3s ease;
    margin-left: 0px;	
}

/* The container <div> - needed to position the dropdown content */
.dropdown {
  position: relative;
  display: none;
}

/* Dropdown Content (Hidden by Default) */
.dropdown-content {
  display: none;
  position: absolute;
  background-color: #f9f9f9;
  min-width: 160px;
  box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
  z-index: 1;
  text-align:left;
//  right:-80px;
}

/* Links inside the dropdown */
.dropdown-content a {
  color: black;
  padding: 12px 16px;
  text-decoration: none;
  display: block;
}

/* Change color of dropdown links on hover */
.dropdown-content a:hover {background-color: #f1f1f1}

/* Show the dropdown menu on hover */
.dropdown:hover .dropdown-content {
  display: block;
}

/* Change the background color of the dropdown button when the dropdown content is shown */
.dropdown:hover .dropbtn {
  background-color: #333;
  color:white !important;
}
/*
.map-container {
    position:relative;
    left: 0;
    width: 100%;
//    height: 73%;
    height:100%;
    transition: height 0.5s ease;
}
*/
.map-container {
    position: absolute;
    top: 0;
    height: auto;
    transition: height 0.5s ease;
    left: 50%;
    transform: translateX(-50%);
}



}
.info-container2{
    display:none; 
    height:auto;
    touch-action:none;
   overflow: hidden !important;
}
.info-container {
    overflow:hidden; 
    display:none; 
    position: absolute;
    bottom: 0;
    top:24px;
    left: 0;
    width: 100%;
   // height: 220px; /* Initial height */
    background-color: transparent;
    color:black;
    transition: height 0.05s ease;
    z-index: 1000;
//    text-align:center;
    justify-content:center;
    touch-action:none; 
}


.clickDirectionText {
    display: flex;
    justify-content: space-between;
    align-items: center;
//  text-align: center;
    width: 100%;
    font-size:20px;
    height:35px; 
}	

.info-container.expanded {
  //  height: 60%; /* Adjust as needed */
    display:flex;
    transform: translate(-50%,0%);
    width:100%;
    left:50%
}
.statistics-overlay {
font-family: 'Roboto';
    position: absolute;
    justify-content: space-around;
    background-color: #ffffff;
    padding: 15px;
    width: auto;
//    border: 2px solid #000;
    z-index: 2;
    display: none;
;
    justify-content: flex-end;
    right: 0;
    border-radius: 50px;
    color: black;
    margin: 25px;
    box-shadow: 0 -5px 10px #050a0f7a;

}

.attribute {
    display: flex;
    flex-direction: column;
    align-items: center; /* Center-align the text in each stat column */
    margin: 0 3px; /* Add horizontal spacing between stats */
}

.label {
    font-size: 14px; /* Adjust the font size for labels */
    color: black; /* Color for the labels */
    margin-bottom: 5px; /* Space between label and value */
}

.value {
    font-size: 16px; /* Adjust the font size for values */
    color: black; /* Color for the values */
}


#modal-container {
  display: none;
  width: 100%;
  height: 100%;
}
.notModal {
margin-top: 20px;
    background-color: #fff;
    padding-left: 30px;
    padding-right: 30px;
}

#sideNav {
    display:flex;
    background: transparent;
    transition: transform 0.3s ease;
    z-index: 1000;
    padding: 30px;
}

/* Side navigation links */
.sidenav a {
  padding: 8px 8px 8px 32px;
  text-decoration: none;
  font-size: 18px;
  color: #818181;
  display: block;
  transition: 0.3s;
}

/* When you mouse over the navigation links, change their color */
.sidenav a:hover {
  color: #f1f1f1;
}

/* Position and style the close button (top right corner) */
.sidenav .close-btn {
  position: absolute;
  top: 0;
  right: 25px;
  font-size: 36px;
  margin-left: 50px;
}
/* Target the pane wrapper with your custom class */


.custom-menu-style  .pane {
  background: rgba(18, 18, 18, 1);
  color: #f0f0f0;
  border-radius: 16px 16px 0 0;
  box-shadow: 0 -8px 30px rgba(0, 0, 0, 0.3);
  overflow: hidden;
  z-index:999999
}
.custom-menu-style .backdrop{
	z-index:999;
}

.open-btn {
border: 0px solid black;
position: absolute;
font-size: 20px;
cursor: pointer;
background: #ffffff;
color: black;
width: 50px; /* Same value as height */
height: 50px; /* Same value as width */
border-radius: 50%; /* Makes it a circle */
box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
transition: all 0.3s ease;
display: flex;
align-items: center;
justify-content: center;
margin-left:15px;
z-index:9;
left:15px;
top:20px;
box-shadow:0 2px 10px rgba(0, 0, 0,1)
}

.open-btn:hover {
    background: black;  /* Change gradient direction on hover */
    box-shadow: 0 6px 10px rgba(0, 0, 0, 0.2);  /* Deepen shadow */
    transform: scale(1.05);  /* Slightly enlarge on hover */
}

.open-btn:focus-visible {
    outline: 2px solid #a777e3;  /* Add custom outline for accessibility */
    outline-offset: 4px;  /* Space between the outline and the element */
}

.open-btn:active {
    background: white;  /* Slightly darker gradient for active state */
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);  /* Deepen shadow on active */
}
.header.searching::after { 
    display: block; /* Show the line when searching */ 
}

.header::after { 
    content: ''; 
    position: absolute; 
    bottom: 0; 
//    left: 50%; 
    left: var(--start-position);
    width: 1px; /* Adjust the width to make the line smaller */ 
    height: 4px; 
    background: #007bff; 
    animation: move 1.7s linear infinite; 
    display: none; /* Initially hidden */ 
    transform: translateX(-50%);
}
@keyframes move {
    0% {
        left:0;
	width:0px
    }
    50% {
        left: calc(100% - var(--start-position)); /* Move to the right end */
        width: 140px; /* Contract width */
    }
    100% {
        left: 100%; /* Move back to the left end */
        width: 0px; /* Expand width */
    }
}
	    
	
	    .testdrag { z-index:99999; width: 200px; height: 200px; background-color: lightblue; position: absolute; top: 50px; left: 50px; }



	    .cupertino-pane {
      margin: 20px;
      background-color: rgb(255 255 255 / 75%);
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
	   .pane {
		   background: white;
	   }
    
    /* Custom CSS to hide the close button */
	    .cupertino-pane-wrapper .destroy-button{
      display: none;
    } 
    .flex-container {
//      display: none;
      justify-content: space-between;
      background-color: white;
      border-radius: 5px;
      width:100%;
      align-items:center;
    }

/* Target the Google Maps address input */
.pac-container .pac-item {
  -webkit-appearance: none; /* Remove default iOS appearance */
  border-radius: 0; /* Remove border radius */
}

/* Target the input field itself */
input[type="text"] {
  -webkit-appearance: none; /* Remove default iOS appearance */
//border-radius: 0; /* Remove border radius */
}

        .flex-container33 {
          margin-top:20px;
  //          position: relative;
            width:100%; 
            display: flex;
            align-items: center;
	    background: transparent; 
	    justify-content: flex-start;
	  
//	    box-shadow: 0 5px 5px #050a0f9c;
            border-radius: 50px;
	    
        }
        .flex-item33 {
           -webkit-appearance: none;		
	    display: none;
	    height:50px; 
            width:280px !important;
            padding: 10px 40px 10px 20px; /* Adjust padding to make room for the icon */
            outline: none;
            font-size: 16px;
            transition: border-color 0.3s;
            border-top:1px solid #ffffff;
            border-bottom: 1px solid #ffffff;
	    border-left:none; 
	    border-right:none;
	    border-radius:none; 
            box-shadow:0 5px 0px 0 #050a0f40; 
        }
        .flex-item33:focus {
            border-color: #0056b3;
        }
        .search-icon {
	    display:none; 
            position: absolute;
            right: 5%;
            top: 50%;
            transform: translateY(-50%);
            color: #007bff;
            font-size: 20px;
        }
        .info-box {
	    z-index:99999; 
	    right:10px;
	    position:absolute;
            display: none;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.7); /* Semi-transparent black background */
            color: white;
            padding: 10px;
            border-radius: 5px;
            max-width: 270px; /* Adjust as necessary */
            margin: 20px; /* Center the info box */
        }
        .info-box .icon {
            margin-right: 10px;
        }
        .info-box .title {
            font-weight: bold;
            font-size: 18px;
	    color:white;
        }
        .info-box .address {
            font-size: 14px;
        }



	.DDAddress {
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;		
    background:transparent; 
    display:flex;
    flex-direction:column; 
    border-color: white;
    justify-content: flex-start; 
    color:black;
    height:70px; 
	}
    
	#findAddress {
    display:flex;
    justify-content:center;
    width:100%;
//    text-align:left;
    background:transparent;
    position:absolute; 
    z-index:2;
    height:100px;
	}
.cancelControl{
    display:block;
    font-size: 16px;
    background: #c62626c2;
    color: #ffffff;
    padding: 10px 15px;
    border-radius: 50px;
    border: none;
 box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);    
	}
   .addressFindDirections { 
    color:white; 
    font-size:18px;
    padding-bottom:15px; 
    text-align:left;
    margin-left:10px; 
   }
   .input-wrapper {
	   position:relative;
	   background:transparent;
	   display:none;
	   border-radius:none;
	  padding: 25px 0px 25px 0px; 
    width: 100%;
    justify-content: center !important;
    background: #4f46e5;
    margin-bottom:25px; 
   }
#addressInput:hover,   
#addressInput:focus {
  border: none;
}   

   .user-button {
    font-size: 18px;
    cursor: pointer;
    background: white;
    color: #333;
    padding: 15px 20px;
    border-radius: 50px 0 0 50px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: all 0.3sease;
    outline: none;
    border-left:1px solid #ffffff;
    border-top:1px solid #ffffff;
    border-bottom: 1px solid #ffffff;
    border-right:none; 
    height:50px; 
}
.useSearchLocation{
	display:none;
	z-index:1;
	background:transparent;
	position:absolute;
	bottom:20px;
	border:none;
	right:10px;
	gap:5px;
}
.useCancelControls{
       display:none;
        z-index:1;
        background:transparent;
        position:absolute;
        bottom:25px;
        border:none;
        right:5px;
        gap:5px;
}



.useLocation{
	    font-size: 17px;
    background: white;
    color: #007bff;
    padding: 16px 16px;
    border-radius: 50px;
    border: none;
    width: 50px;
    height: 50px;
}	

.searchLocation{
	    font-size: 17px;
    background: white;
    color: #007bff;
    padding: 16px 16px;
    border-radius: 50px;
    border: none;
    width: 50px;
    height: 50px;
}
.manual-location-off{

            font-size: 16px; 
    background: white;
    color: #007bff;
    padding: 16px 16px;
    border-radius: 50px;
    border: none;
    width: 230px;
    height: 50px;
    font-weight:600;



}


.submitStoreContent{
	position:fixed;
	width:100%;
	height:100%; 
}
#storeForm{
    max-height: calc(100vh - 190px); 

}
    .courierMarker {
//      margin-top: 20px;
//      margin-left: 30px;
      position: relative;
    }

    .pulse {
      width: 10px;
      height: 10px;
      border: 5px solid #7fd2e6;
      border-radius: 30px;
      background-color: #00a6cd;
      z-index: 10;
//      position: absolute;
    }

    .dot {
      position: absolute;
      height: 50px;
      width: 50px;
      top: -25px;
      left: -25px;
      z-index: 2;
      opacity: 0;
      border: 10px solid rgba(0, 166, 205, 1);
      background: transparent;
      border-radius: 60px;
      animation: flash 2s ease-out infinite;
    }

    @keyframes pulse {
      0% { transform: scale(0); opacity: 0.0; }
      25% { transform: scale(0); opacity: 0.1; }
      50% { transform: scale(0.1); opacity: 0.3; }
      75% { transform: scale(0.5); opacity: 0.5; }
      100% { transform: scale(1); opacity: 0.0; }
    }

    @keyframes flash {
      0% { transform: scale(0); opacity: 0.0; }
      25% { transform: scale(0); opacity: 0.1; }
      50% { transform: scale(0.1); opacity: 0.3; }
      75% { transform: scale(0.5); opacity: 0.5; }
      100% { transform: scale(1); opacity: 0.0; }
    }	    
   .upload-order-overlay2{
  padding-left: 20px;
  padding-right: 20px;
  padding-bottom: 20px;
  padding-top: 5px;


   }
.custom-pane{
    background: white;
    border-radius: 20px; /* Optional: Add rounded corners */
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); /* Optional: Add shadow */
}
.instruction-pane{
    z-index:99;
}
dropoff-method{
	margin-top:20px; 
}

.merchant-pane .draggable{
    color: black;
    padding: 5px;
    position: absolute;
    left: 0;
    right: 0;
    margin-left: auto;
    margin-right: auto;
    height: 30px;
    z-index: -1;
    top: 0;
    bottom: initial;
    background: black;
   //border-radius: 12px 12px 0 0px;
    border-radius:0; 
}
.merchant-pane .move {background: black;}


.delivery-notes {
	    width: 90%;
    font-size: 16px;
    border: 2px solid black;
    border-radius: 10px;
    height: 130px;
    padding:12px;
   }
.merchant-pane {
	transition: transform 0.8s ease-in-out !important;
}
.address-pane .draggable{
    color: transparent;
    padding: 5px;
    position: absolute;
    left: 0;
    right: 0;
    margin-left: auto;
    margin-right: auto;
    height: 30px;
    z-index: -1;
    top: 0;
    bottom: initial;
    background: white;
   border-radius: 12px 12px 0 0px;
}
.address-pane .move{background:black;}
.cupertino-pane-wrapper.custom-pane.rendered .pane {
	background:white;
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;	
}
.cupertino-pane-wrapper .move {
    margin: 0 auto;
    height: 5px;
//    background:black;
    width: 36px;
    border-radius: 4px;
}
.custom-modal .cupertino-pane-wrapper .pane {
            border-radius: 10px; /* Applying 10px border-radius all around */
        }
.Order-Upload-Button {
	    border: 4px solid #007bff;
    background: #eeeeeeb0;
    color: black;
    border-radius: 25px;
    width: 172px;
    padding-top: 55px;
    padding-bottom: 56px;
}
.Upload-Instruction-Container {
    padding-bottom: 18px;
    padding-left: 40px;
    padding-right: 40px;
    background:#007bff;
    color:white;
}
	
.uploadTitle {
    font-weight: 700;
    font-size: 29px;
    margin-bottom: 10px;
}
.uploadDetail{
font-size:18px; 
}
/* Add these styles to your CSS */
.pickup-circle,
.dropoff-circle {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    background: transparent;
//    box-shadow: 0px 4px 6px rgb(0 0 0 / 62%);
    font-size: 22px !important;
}
/*
.courier-circle{
    width: 35px;
    height: 35px;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    background: black;
    color:white;
    box-shadow: 0px 4px 6px rgb(0 0 0 / 62%);
    font-size: 19px !important;
    /* display: flex; */	
}

*/
    
.submitAddress{
	font-size:16px;
	width:60%;
	background:black;
	display:none;
	color:white;
	border-radius:10px;
	height:50px;
	font-weight:600; 
}


.vertical-line {
    width: 4px;
    background-color:black;
    height: 87px;
    margin: 10px auto;
    border-radius: 8px;
    transition: height 0.5s ease-out;
	
}
.vertical-line2 {
    width: 4px;
    background-color:black;
    height: 0px;
    margin: 10px auto;
    border-radius: 8px;
    transition: height 0.5s ease-out;

}
.vertical-line,
.vertical-line2 {
  transition: height 0.4s ease, opacity 0.4s ease;
  opacity: 1;
}

.vertical-line.collapsing,
.vertical-line2.collapsing {
  opacity: 0;
  margin: 0; 
}
.pkdrContainer{
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;	
  display: flex;
   border: 0px solid grey;
    border-radius: 15px;
    margin: 15px;
    margin-top:0px;
}
.fading-out {
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.4s ease;
}

.collapsing {
  height: 0 !important;
  opacity: 0 !important;
  transition: height 0.4s ease, opacity 0.4s ease;
}
.fading-collapse {
  padding: 0 !important; 
  height: 0 !important;
  opacity: 0 !important;
  overflow: hidden;
  transition: height 0.4s ease, opacity 0.4s ease;
}
.fading-collapse-tight {
//  display:none; 
  opacity: 0 !important;
  height: 0 !important;
  margin: 0 !important;
  overflow: hidden !important;
  transition: opacity 0.3s ease, height 0.3s ease, margin 0.3s ease;
}
.connectorColumn {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  width: 50px;
  margin-top:16px; 
}

.pkdrRows {
//  display: flex;
  flex-direction: column;
  flex: 10; /* Adjust the width of the right section */
//  padding-left:10px;
  display:none; 
}

.row12 {
  width:320px; 
  background-color: #f5f5f5;
  border-radius: 0.75rem; /* rounded-xl */
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* shadow-md */
  padding: 16px; /* p-6 */
  margin-bottom: 10px;
  transition: box-shadow 0.3s ease;
 position: relative; 
	
  transition: margin-bottom 0.5s ease-out;

}

.row12:last-child {
//  margin-bottom: 0; /* Remove margin from the last row */
    display:none; 
}
 .changeAddress { 
    -webkit-appearance:none; 
    color: black;
    border: none;
    border-radius: 50px;
    width: 80px;
    font-size: 12px;
    padding: 8px !important;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    background-color:white; 
}
.pickup-header {
  display: flex;
  justify-content: space-between;
//  align-items: flex-end;
  width: 100%;
}

.pickup-left {
  display: flex;
  align-items: center;
  gap: 6px;
}

.slide-counter {
  font-size: 14px;
  font-weight: 700;
}
.delete-store {
    font-size:22px; 
    margin-right:10px;
    color: black;
    border: none;
    border-radius: 50px;
    padding: 12px;
//    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
  }

.removePickup{
    color: black;
    border: none;
    border-radius: 50px;
    width: 60px;
    font-size: 14px;
    padding: 12px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);

}

.changeInstructions{
    color:black;
    border:none; 
    display:none; 
    border-radius: 50px;
    width: 90px;
    font-size: 12px;
    padding: 6px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    background:white; 
    outline:none;
}
changeInstructions:active {
    outline:none; 
    transform: translateY(2px) !important; /* ✅ Simulates "press down" effect */
    box-shadow: 0 1px 5px rgba(0, 0, 0, 0.3) !important; /* ✅ Reduces shadow */
}



.instructionsButton{
    background: #eee;
    color: black;
    font-size: 16px;
    border-radius: 40px;
    padding: 15px;
    margin-right: 5px;
    position: absolute;
    top: 10px;
    right: 10px;
    border:none;
}	
   

.pickup-circle svg, .dropoff-circle svg {
//  font-size: 30px; /* Adjust size as needed */
//  color: black; /* Adjust color as needed */

} 
#paySection {
	margin-top:20px;
	display:none;
		    }
#waitSection {
        margin-top:20px; 
	display:none; 
}
.instructionsHeader{
    font-size: 28px;
    border: 0px;
    color: black;
    font-weight: 100;
    margin-left: 30px;
    margin-top: 20px;
    margin-bottom:40px;
 }


touch-action: none;
    /* overflow-y: scroll; */
    font-size: 16px;
    width: 90%;
    border: 2px solid black;
    height: 200px;
   }
.order-icon {
  margin-right:40px; 
  position: relative;
  display: inline-block;
  font-size: 14px; /* Adjust size as needed */
  color: black; /* Main icon color */
  padding:10px;
}
.statusDiv{
	position:relative;
	font-weight:700; 
	margin-top:5px; 
	font-size:18px; 
}
.check-icon,
.x-icon {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;           /* Updated to your desired font size */
  color: #fff;
  width: 12px;
  height: 12px;
  padding: 4px;              /* Adds space around the text/icon */
  border-radius: 50%;
  box-sizing: content-box;
  top:-7px;
  right:-3px;
  position:absolute; 
	
}
.x-icon {
  background-color: #EB1700;
}
  .check-icon {
	  background-color:black;
  }

.check-icon2,
.x-icon2 {
  display: inline-flex;
  align-items: center;
  justify-content: center;  font-size: 10px;           /* Updated to your desired font size */
  color: '00CC00'
  width: 12px;
  height: 12px;
  padding: 4px;              /* Adds space around the text/icon */
  border-radius: 50%;
  box-sizing: content-box;
  position:absolute;
  top:-7px; 

}
.x-icon2 {
  background-color: #EB1700;
}
  .check-icon2 {
          background-color:'00CC00';
  }


@keyframes glow {
  50% {
    box-shadow: 0 0 40px hsl(12, 100%, 60%);
  }
}
    .search-container {
    display: flex;
   justify-content: center;
    align-items: center;
    text-align:center; 
    padding-top: 10px;
    padding-bottom: 30px;
    background: black;
    transition: opacity 0.5s ease-in-out;


    }

    /* Search Bar Input */
    .search-input {
    max-width:380px;
    width: 100%;
    padding: 19px 13px;
    font-size: 14px;
    border: 1px solid #ccc;
    border-radius: 50px;
    transition: all 0.8s ease-in-out;
    outline: none;
    visibility:hidden; 
    }
    .search-input.show{
	    visibility:visible; 
	    opacity:1;
    }
    .input-wrapper.show{
	    display:flex;
    }

    /* Search Bar Focused Style */
    .search-input:focus {
      border-color: #007BFF;
      box-shadow: 0 0 8px rgba(0, 123, 255, 0.5);
    }
    .store-column {
//      flex: 1;
      display: flex;
      flex-direction: column;         /* Stack items vertically */
      justify-content: center; /* Distribute items top and bottom */
   //   align-items: center;            /* Center items horizontally */
      padding: 10px;
      margin: 5px;                    /* Optional spacing */
    //  height:100px;
    }
    .checkbox-category{
	    font-size:14px;
	    color:grey;
    }

    .order-upload-image-new{
        display:none; 
    }
    .instructions-pane{
	 display:none
     }
   #chooseStoreButton{
	   right: 60px;
       }	  
   .editInstructionsButton{
	    background: #007bff;
    color: white;
    border: 2px solid;
    font-size: 18px;
    border-radius: 40px;
    padding: 10px;
    margin-top: 40px;   
   }
   .submitNewInstructionsButton{
        background: black;
    color: white;
    font-size: 18px;
    border-radius: 10px;
    padding: 10px;
    margin-right: 5px;	   
   }
   .submittedInstructions{
	       padding-left: 35px;
    padding-right: 35px;
   }
        .contactless-checkbox-container {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 18px;
    font-weight: bold;
    color: #333;
    cursor: pointer;
    justify-content: center;
    margin-bottom: 10px;
}		
        }

        /* Hide the default checkbox */
        .contactless-checkbox-container input[type="checkbox"] {
            display: none;
        }

        /* Custom checkbox styling */
        .custom-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid #007bff; /* Blue outline */
            border-radius: 6px; /* Slightly rounded */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
        }

        /* Checkmark symbol */
        .contactless-checkbox-container input[type="checkbox"]:checked + .custom-checkbox::before {
            content: '✔';
            color: white;
            font-size: 18px;
            font-weight: bold;
        }

        /* Change background on check */
        .contactless-checkbox-container input[type="checkbox"]:checked + .custom-checkbox {
            background-color: #007bff;
            border-color: #0056b3;
        }  

.section {
    display: flex;
    flex-direction: column;
    padding: 15;
    border-bottom: 1px solid #cecbd0;
}

.section-header {
    align-self: flex-start;
    margin-left: 0px;
    font-weight: 900;
    font-size: 20px;
}

.courier-content {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    font-size: 16px;
    margin-left:25px;
}
.dropoff-content {
    margin-top:10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 20px;
//    padding-left: 20px;
//    padding-right: 20px;    
}
.address-details {
	font-size:12px;
}

.courier-contact-container {
    display: flex;
    align-items: center; /* Aligns name and icon properly */
    font-size:16px; 
}

#courierProgress {
    display: flex;
    gap: 10px;
    color: black;
    font-size: 40px;	
}
.contact-button {
    border-radius: 20px;
   //  border: 1px solid black; 
    padding: 8px;
    background: #eee;
    color: black;
    font-size:12px;
    border:none;
    text-decoration:none;
		}
dropoff-content{
    display: flex;
    justify-content: ;
    align-items: center;
    font-size: 19px;
    padding-left: 20px;
}
		.order-info-button{
			background: white;
    color: black;
    border:none;
    font-size: 22px;
    border-radius: 40px;
    padding: 10px;
    margin-right: 5px;
    height: 50px;
    width: 50px;
  }
.guidanceButton{
	display:none;
	justify-content:space-between;
	height:60px; 
}
#getStateLoaderContainer{
    display: flex;
    justify-content: center;
    align-items: center;
    width: 50%;
    position: relative;		 
		}
#getStateLoaderContainerSwiper{
    display: none;
//    justify-content: center;
    align-items: center;
    width: 50%;
    position: absolute;
                }
.getStateLoader{
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}
#mapTypeControl {
    position: absolute;
    top: 10px;
    right: 10px;
    background: white;
    padding: 8px;
    border-radius: 4px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    display:none;
}

.control-group {
    display: flex;
    align-items: center;
    gap: 5px;
}

.control-button {
    background: #fff;
    border: 1px solid #ccc;
    padding: 5px 10px;
    cursor: pointer;
    border-radius: 3px;
    font-size: 14px;
}

.control-button.selected {
    background: #ddd;
}
.custom-modal-image {
  width: 100vw;
  height: 100vh;
}
		.closeIMG {
    width: 35px;
    height: 35px;
    padding: 12px;
    position: absolute;
    top: 10px;
    right: 10px;
    background: white;
    border: none;
    font-size: 18px;
    cursor: pointer;
    color: #333;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);			
		}
.closeIMG:hover {
    color: red;
}
		.viewIMG{
			    padding: 10px;
                            background: #ddd;
                            color: black;
                            border: 0px solid blue;
                            border-radius: 30px;
                            display: none;
                            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                            font-weight: 800;
		}
		.custom-modal {

		background:white;
		}
		.custom-modal .draggable{
			border-radius:0px;
			background:#007bff;

		}
		.custom-modal .move {
			color:#007bff;
			background:none; 
		}

		.viewIMG-container{
			display:flex;
			justify-content:center;
		}
.pending-courier-icon {
  display:none; 
  margin-left:5px; 
  align-items: center;
  justify-content: center;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background-color: black;
  color: white;
  font-size: 20px;
  text-decoration: none;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  transition: background-color 0.3s ease;
}



.pending-courier-icon:hover {
    color: #0056b3;
}	
.status {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  //padding: 6px 14px;
  //border-radius: 20px;
  font-weight: 500;
  //font-size: 14px;
 // box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
}

.idle {
  font-size:12px; 
  color: #2e7d32;
}

.busy {
  font-size:12px; 
  color: #ef6c00;
  opacity: 0.7;
}
.courier-notification {
    z-index:9;
    display:none;
    position: absolute;
    top: 25px;
    right: 15px;
    background-color: white;
    color: black;
    font-size: 20px;
    font-weight: bold;
    padding: 10px 15px;
    border-radius: 50px;
    align-items: center;   justify-content: center;
    gap: 8px;
    box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.7);
}

/* Number badge */
.courier-notification span {
    background-color: green;
    padding: 5px 10px;
    border-radius: 50%;
    font-size: 14px;
}

/* Pulsing animation for 'Searching...' */
@keyframes pulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.2); opacity: 0.7; }
    100% { transform: scale(1); opacity: 1; }
}

.searching {
    animation: pulse 1.5s infinite;
    background-color:orange; 
}
.pending-notification {
    position: fixed;
    bottom: 15px;
    right: 15px;
    background-color: black;
    color: white;
    font-size: 16px;
    font-weight: bold;
    padding: 10px 15px;
    border-radius: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
}
		.addressInput{
    -webkit-appearance: none;
    height: 50px;
    padding: 10px 40px 10px 20px;
    outline: none;
    font-size: 16px;
    transition: border-color 0.3s;
    box-shadow: 0 5px 0px 0 #050a0f40;
    display:flex; 
		}
.pac-container {
//    display:block !important;
    background-color: white !important;
//    width:100% !important;
    top: 250px !important;
    left: 50% !important;
    box-shadow: none !important;
    border: none important!; 
    transform: translateX(-50%) !important;


}
.pac-item {
    font-size: 16px;
    color: #007bff;
}
#clearButton {
        position: absolute;
    right:20px;
    background: transparent;
    border: none;
    font-size: 40px;
    cursor: pointer;
    display: none;	
}
		#addressInput{
			width:330px;
		}
		.payButton {
    margin-right:10px;
    display: inline-block;
    background-color: #007bff; /* Blue for trust & action */
    color: white; /* High contrast text */
    font-size: 12px; /* Slightly larger for emphasis */
    font-weight: bold; /* Make the text stand out */
    padding: 12px 24px; /* Comfortable padding */
    border-radius: 8px; /* Rounded corners for modern feel */
    text-align: center;
    text-transform: uppercase; /* All caps for visibility */
    cursor: pointer; /* Show it's clickable */
    border: none;
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1); /* Subtle shadow */
    transition: all 0.3s ease-in-out; /* Smooth hover effect */
		}
.swiperButtonsContainer{
	display:none;
}
		
	.live-offers-btn {
    position: relative;
    color: black;
    font-size: 28px;
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top:10px;
    background:none; 
}

.live-offers-btn i {
    font-size: 18px;
}

.badge {
position: absolute;
top: -6px;
right: -20px;
background-color:black;
color: white;
font-size: 18px;
width: 30px; /* Set explicit width */
height: 30px; /* Set explicit height */
display: flex;
align-items: center;
justify-content: center;
border-radius: 50%; /* Ensures perfect roundness */
	
}
#checkedContainer {
  position: sticky;
  top: 0;
  background-color: white;
  z-index: 1000;
  padding-bottom: 22px;
  box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
  overflow: hidden;
  max-height: 0;
  opacity: 0;
  transition: max-height 600ms ease-out, opacity 400ms ease-out;

}

#checkedContainer.show {
  max-height: 800px;
  opacity: 1;
}

.checkbox-container.moving {
  opacity: 0.3;
  transform: scale(1.05);
  transition: opacity 400ms ease-in, transform 400ms ease-in;


}
#totalPrice {
    position: absolute;
    bottom: 0px;
    right: 10px;
    font-size: 18px;
    font-weight: bold;
    color: black;
    background-color: transparent;
    padding: 8px 12px;
    border-radius: 5px;
}

#totalPrice.updated {
  animation: pulse 300ms ease-out;
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}
.checkbox-container input[type="checkbox"]:checked ~ * {
    display: flex;
}
.checkbox-container.checked {
    height: 60px; /* Set height when checked */
    box-shadow:none;
    background:none;
    border:none;
}
.checked-items {
	margin-bottom:28px; 
}
.checkbox-container.checked .store-image {
//    display: block; /* Hide image when checked */
}
		.useCheckboxes{


    font-size: 25px;
    color: white;
    font-weight:700;

		}
		.navigator{
    display:none; 
    display: flex;
    justify-content: space-between;
    height: 40px;
    padding: 1 30px 10px 2px;
    background: black;			
		}
		.store-dropoff{
	color:white;
	font-size:15px; 
		}
		.instruction-dropoff{
			color:black;
			font-size:18px;
			font-weight:600; 
		}

		.viewMap{
    font-size: 20px;
    color: white;
    border: none;
    background: #007bff;
    display: block;
    position: absolute;
    padding: 12px;
    border-radius: 20px;
    bottom: 46px;
    z-index: 99;			
		}

		
#dynamic-form-container {
    max-width: 360px;
    margin: 0px auto;
    padding: 15px;
    background: #f8f8f8;
    color: black;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

#dynamic-form-container label {
    font-weight: bold;
    color: #333;
    display: block;
    margin-bottom: 5px;
    font-size:14px; 
}

#dynamic-form-container input {
    width: 145px; ;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 12px;
}

#dynamic-form-container input:focus {
    border-color: #007bff;
    outline: none;
    box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
}

/* Group First and Last Name Fields */
.name-container, .order-pickup-container {
    display: flex;
    gap: 15px;
    justify-content: space-between;
}

.name-field, .order-field {
    flex: 1;
    margin-bottom:20px;
}

/* Button Styling */
#dynamic-form-container button {
    background: #007bff;
    color: white;
    padding: 12px;
    border: none;
    border-radius: 5px;
    font-size: 16px;
    cursor: pointer;
    transition: background 0.3s ease;
    width: 100px;
    margin-top:5px; 
}

#dynamic-form-container button:hover {
    background: #0056b3;
}
.suggestions-box {
    position: absolute;
    top: 100%;
    left: 0;
    width: 100%; /* Match width of input */
    background: white;
    border: 1px solid #ccc;
    border-radius: 5px;
    box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.2);
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
}

.suggestion-item {
    padding: 10px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
}

.suggestion-item:hover {
    background: #f0f0f0;
}
.courier-swiper {
    display:none; 
    opacity:0;
    width:250px; /* Set fixed width */
    height: 68px; /* Set fixed height */
  //  margin-top:26px;
    margin:0;
    transition: opacity 0.3s ease-in-out;


}

    #swiper-slide {
    transition: transform 0.5s ease, opacity 0.5s ease;
}
.hidden-slide {
    visibility: hidden;
}

#swiper-slide:not(.swiper-slide-active) {
//    transform: scale(0.85); /* Smaller inactive slides */
//    opacity: 0.6; /* Fades out inactive slides */
//    filter: blur(1px); /* Adds slight blur for depth effect */
}
.sidebar {
    position: fixed;
    left: -250px; /* Hidden off-screen */
    width: 250px;
    height: 100%;
    background: #333;
    color: white;
    transition: left 0.4s ease-in-out;
    padding: 20px;
}

.sidebar ul {
    list-style: none;
    padding: 0;
}

.sidebar ul li {
    padding: 15px;
    font-size: 18px;
}

.sidebar ul li a {
    text-decoration: none;
    color: white;
}

.sidebar.active {
    left: 0; /* Slide-in effect */
}
.sidebarSwiper {
    width: 250px; /* Sidebar width */
    height: 100vh; /* Full height */
    position: fixed;
    left: 0;
    top: 0;
    background: #333;
    color: white;
}
.swiper-slide {
  border-radius: 8px;
  transition: transform 0.2s ease;
  min-height: 50px;
  width:300px;
  margin-left:0; 
}

.tracker-store-swiper .swiper-slide:hover {
  transform: translateY(-2px);
}

.tracker-store-swiper .store-order {
  display: flex;
  flex-direction: row;
  align-items: flex-start;
  gap: 5px;
  width: 100%;
  justify-content:space-between; 
}

.tracker-store-swiper .store-order button {
  background: transparent;
  border: none;
  cursor: pointer;
  padding: 0;
}

.tracker-store-swiper .order-icon {
  font-size: 12px;
  color: black;
  padding:10px;
  background:#eee;
  border-radius:20px;
  width: 90px;
  position:relative; 
}

.tracker-store-swiper .store-order img {
  width: 28px;
  height: 28px;
  object-fit: contain;
}

.tracker-store-swiper .swiper-pagination {
  text-align: center;
  margin-top: 10px;
}
.cancel-pane {
    display: none;
    flex-direction: column;
    align-items: center;
    padding: 50px;
    z-index:999;
}
.modify-payment-pane {
    display: none;
    flex-direction: column;
    align-items: center;
    padding: 50px;
    z-index:999;
}
.label-pane {
 // display: none;
 // flex-direction: column;
 // align-items: center;
//  padding: 50px;
    z-index:999;
}


.cancel-option {
    width: 100%;
    padding: 18px;
    margin: 5px 0;
    border: none;
    border-radius: 30px;
    background: #c62626c2; 
    color: white;
    font-size: 18px;
    cursor: pointer;
    font-weight:700;
    transition: background 0.3s;
}

.cancel-option:hover {
    background: #cc3838;
}

.cancel-close {
    width: 100%;
    padding: 18px;
    margin-top: 10px;
    border: none;
    border-radius: 30px;
    background: #ddd;
    color: #333;
    font-size: 18px;
    cursor: pointer;
    font-weight:700;
    transition: background 0.3s;
}

.cancel-close:hover {
    background: #bbb;
}

/* ✅ Ensure the SVG wrapper behaves like the demo */
.svg-wrapper-1 {
  display: flex;
  align-items: center;
  justify-content: center;
}

.svg-wrapper {
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.3s ease-in-out;
}

/* ✅ Apply hover effects */
.button74:hover {
  background: #000;
}

.button74:hover .svg-wrapper {
  transform: scale(1.8);
  transition: 0.5s linear;
}

.button74:hover svg {
  transform: translateX(1.65em) scale(1.1);
  fill: #fff;
}

.button74:hover span {
  opacity: 0;
  transition: 0.5s linear;
}

/* ✅ Add pressed effect */
.button74:active {
  transform: scale(0.95);
}
.swiper-container {
  width: 295px;
  overflow: hidden;
  height:70px;
 // padding-right:10px; 
}
.tracker-swiper-container{
    /* width: 371px; */
    overflow: hidden;
    height: 60px;    /* width: 371px; */
    overflow: hidden;
    height: 100px;
    padding-left:25px; 
}
.swiper-pagination-stores{
  position: absolute;
  top: 55%;
  left: 50%;
  transform: translate(-50%, -50%);
  width:200px; 
	
	font-size:20px;
}
.swiper-button-prev::after,
.swiper-button-next::after {
  display: none;
}

.swiper-button-next:hover,
.swiper-button-prev:hover {
  background: rgba(255, 255, 255, 0.2);
}
.circle-icon-button {
    bottom: 30px;
    left: 35px;
    z-index: 9;
    position: absolute;
    background: white;
    color: black;
    border: none;
    border-radius: 50%;
    width: 48px;
    height: 48px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.3s ease, box-shadow 0.3s	
}

.circle-icon-button:hover {
  background: #f0f0f0;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
}

.circle-icon-button i {
  font-size: 20px;
}
#centerDot {
    transform: translate(-50%, -100%);
    position: absolute;
    top: 50%;
    left: 50%;
    z-index: 999;
    pointer-events: none;
    display: none;	
}
.filter-pane {
  padding: 20px;
  background: #fff;
  color: #333;
  border-radius: 12px 12px 0 0;
  box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
}

.filter-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.filter-header h3 {
  margin: 0;
  font-size: 1.2rem;
}

.close-btn {
  background: none;
  border: none;
  font-size: 1.2rem;
  cursor: pointer;
  color: #888;
}

.filter-section {
  margin-bottom: 20px;
}
.filter-section label {
  display: block;
  font-weight: 600;
  margin-bottom: 8px;
}

.range-inputs {
  display: flex;
  gap: 10px;
  align-items: center;
}

.range-inputs input {
  width: 45%;
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 6px;
}

.checkbox-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.checkbox-group label {
  font-weight: 500;
  font-size: 0.95rem;
  cursor: pointer;
}

.filter-footer {
  display: flex;
  justify-content: space-between;
  gap: 10px;
}

.apply-btn,
.reset-btn {
  flex: 1;
  padding: 10px;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
}

.apply-btn {
  background-color: #007bff;
  color: white;
}

.reset-btn {
  background-color: #f1f1f1;
  color: #333;
}
select {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 0.95rem;
  background-color: #fff;
  appearance: none;
  cursor: pointer;
}

select:focus {
  border-color: #007bff;
  outline: none;
  box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2);
}
.category-badge {
    font-weight: 600;
    color: #007bff;
    margin-right: 6px;
}

.type-badge {
    font-weight: 500;
    color: #666;
    font-style: italic;
}		
		.filter-trigger{
			    background: none;
    border: none;
    padding: 8px;
    font-size: 27px;
    color: #ffffff;
    cursor: pointer;
    border-radius: 6px;
    transition: background 0.2s ease, color 0.2s ease;
		}









.label-modal-container {
  background: #fff;
  border-radius: 16px 16px 0 0;
  padding: 20px;
  margin:20px; 
}

.label-modal-header h3 {
  margin: 0;
  font-size: 25px;
//text-align: center;
  color: #333;
}

.label-modal-body {
  margin: 20px 0;
}

.label-modal-input {
  width: 100%;
  padding: 12px;
  font-size: 1rem;
  border: 1px solid #ccc;
  border-radius: 8px;
  outline: none;
  transition: border-color 0.2s ease;
}

.label-modal-input:focus {
  border-color: #007bff;
}

.label-modal-footer {
  display: flex;
  justify-content: flex-start;
  gap: 10px;
}

.label-modal-cancel,
.label-modal-confirm {
    padding: 18px;
    font-weight: 600;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    border-radius: 10px;
    width: 130px;
    font-size:16px; 
}

.label-modal-cancel {
  background-color: #f1f1f1;
  color: #333;
}

.label-modal-confirm {
  background-color: black;
  color: white;
}
		.changeAddressContainer{
			    display: flex;
    text-align: center;
    flex-direction: row;
    margin-top: 20px;
    justify-content: center;
    align-items: center;
		}

body, .location-instructions-wrapper, .location-summary-wrapper {
font-family: 'Segoe UI', sans-serif;
	
}

/* Instructional content */
.location-instructions-wrapper {
  padding: 16px 20px 0px;
}

.location-heading {
  font-size: 23px;
  color: #222;
  margin-bottom: 10px;
  font-weight:700; 
}

.location-option-list {
  list-style: none;
  padding: 0;
  margin:4px 0px 12px 0px;
  display: flex;
  flex-direction: row;
  gap: 3px;
}

.location-option-list li {
    display: flex;
    align-items: center;
    font-size: 12px;
    color: #333;
    font-weight: 600;
    flex-direction: column;
    text-align: center;
    border: 1px solid black;
    border-radius: 10px;
    padding: 5px;	
}

.option-icon {
  font-size: 16px;
  color: #007bff;
  margin-right: 10px;
  width: 20px;
  text-align: center;
}

.location-note {
  font-size: 0.9rem;
  color: #888;
  margin:0; 
}

/* Address block */
.location-summary-wrapper {
  padding: 5px 32px;
}

.location-summary-container {
  display: flex;
  align-items: flex-start;
  gap: 12px;
}

.location-icon {
	color:black;

}

.location-address-text {
  font-size: 17px;
  font-weight: 600;
  color: #333;
  line-height: 1.4;
}
.button-loader {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  opacity: 0;
  animation: fadeIn 0.3s ease forwards;
}

.button-loader svg {
  color: #fff;
}

@keyframes fadeIn {
  to {
    opacity: 1;
  }
}
		#pay-button{
			font-weight:700;
			font-size:16px
			width: 100px; 
		}
		.store-dropoff-marker {
			font-size: 16px;
			color:whgte;
			padding:5px;
		}
		.option-strong{
			display:inline;
			font-weight:700;
			font-size:15px;
                       }
.selectedStoresNavigation {
  display: flex;
  justify-content: start;
  gap: 8px;
  align-items:end;
  height:20px; 
  
}

.swiper-button-prev,
.swiper-button-next {
    position: static !important;
    cursor: pointer;
    width: 15px;
    height: 15px;
    display:none;
}
.street-name{
	white-space:nowrap; 
	overflow:hidden;
	width:200px; 

}
.courier-wrapper{
//	  margin-left: 0; /* Remove default margins, if any */
//  transform: translateX(0) !important;
}
.courierRowOffer{
	display:flex;
	flex-direction:row;
	gap:4px;
}
		#instructionsPreview{
			width:360px;
			margin: 0 auto;
			min-height:350px; 
		}
.draggable.transparent-bg,
.pane.transparent-bg {
  background-color: transparent !important;
  box-shadow: none !important;
}
.custom-marker-wrapper {
  position: absolute;
  width: 50px;
  text-align: center;
  animation: custom-marker-drop-in 0.3s ease-out;
  z-index: 1000;
}

.custom-marker-content {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.custom-marker-content img {
  width: 35px;
  height: 35px;
  border-radius: 6px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
}

.custom-marker-label {
  margin-top: 4px;
  font-size: 12px;
  font-weight: bold;
  color: #333;
  background: rgba(255, 255, 255, 0.85);
  padding: 2px 6px;
  border-radius: 4px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
}

@keyframes custom-marker-drop-in {
  from {
    transform: translateY(-20px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}
     </style>
     <body id="body">
<script src="https://js.stripe.com/v3/"></script>
<div id="payment-form" class="max-w-md mx-auto bg-white rounded-lg shadow-md p-6 space-y-6">
  <h2 class="text-xl font-semibold text-gray-800">Pay Your Courier</h2>
  <h4 id="initializedCourierPhone" class ="text-sm font-semibold text-gray-800"></h4>
  <p class="text-sm text-gray-500 mt-1">
    Securely complete your payment to the courier using your preferred method.
  </p>

  <form id="stripe-payment-form" class="space-y-6">
    <div id="payment-element" class="mt-4">
      <!-- Stripe Payment Element mounts here -->
    </div>

    <button
      id="submit"
      type="submit"
      class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-colors"
    >
      Pay $50
    </button>

    <div id="error-message" class="text-red-600 text-sm mt-2" role="alert"></div>
  </form>
</div>



<script>
let stripe = Stripe("pk_live_51NC7o1L3wnbtBH2ic3SyI2wP1vcBWnO1ZRiV8sjeCyFNcC9lEanp9TYBRcQoSZqAUJwQXijLQogKO6OrCau3F2FQ00uBc0yBO1")
let elements;
function resetUI() {
  document.getElementById("error-message").textContent = "";
  const submitBtn = document.getElementById("submit");
  submitBtn.disabled = false;
  submitBtn.textContent = "Pay";
  document.getElementById("payment-element").innerHTML = "";
}
async function initialize(courierPhone) {
  document.getElementById("initializedCourierPhone").innerHTML = courierPhone; 
  const res = await fetch("/create-payment-intent/", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
  courierPhone: courierPhone,
  userPhone: phone_number
})

	  
  });

  const { clientSecret } = await res.json();

  elements = stripe.elements({ clientSecret });

  const paymentElement = elements.create("payment");
  paymentElement.mount("#payment-element");
}

async function handleSubmit(e) {
  e.preventDefault();

  if (!elements || !stripe) {
    showError("Payment system not ready.");
    return;
  }

  const submitBtn = document.getElementById("submit");
  submitBtn.disabled = true;
  submitBtn.textContent = "Processing...";

  const { error, paymentIntent } = await stripe.confirmPayment({
    elements,
    confirmParams: {
      return_url: window.location.href,
    },
    redirect: "if_required"
  });

  if (error) {
    showError(error.message);
    resetButton();
    return;
  }

  switch (paymentIntent.status) {
    case "succeeded":
      showSuccess();
      break;
    case "processing":
      showError("Payment is still processing. Please wait.");
      resetButton();
      break;
    case "requires_payment_method":
      showError("Payment failed. Please try another method.");
      resetButton();
      break;
    default:
      showError("Unexpected status: " + paymentIntent.status);
      resetButton();
  }
}

function showError(msg) {
  document.getElementById("error-message").textContent = msg;
}

function resetButton() {
  const submitBtn = document.getElementById("submit");
  submitBtn.disabled = false;
  submitBtn.textContent = "Pay $50";
}

function showSuccess() {
  document.getElementById("payment-form").innerHTML = `
    <div class="text-center space-y-4">
      <h2 class="text-xl font-semibold text-green-700">✅ Payment Successful</h2>
      <p class="text-gray-600">Thanks for paying your courier. You're all set!</p>
    </div>
  `;
}

document.getElementById("stripe-payment-form").addEventListener("submit", handleSubmit);
initialize();
</script>













    <div class="order-upload-overlay2">
<button class="closeIMG" id="closeOrderInfo"><i class="fa fa-times"></i></button>
<!-- 🔹 Global overlay for fullscreen image viewing -->
<div id="global-image-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden"></div>

<!-- 🔹 Instruction header (optional, can be styled with Tailwind) -->
<div id="Upload-Instruction" class="mb-6 p-4 bg-[#007bff] text-white rounded shadow-sm">
  <h2 class="text-2xl font-semibold ">Submit Order Information</h2>
 <p class="text-sm text-white">
  You can both <span class="font-semibold underline">upload a screenshot</span> or <span class="font-semibold underline">submit your order manually</span>.
</p> 
</div>

<!-- 🔹 Master container for all dynamically injected upload blocks -->
<div id="order-upload-overlay" class="space-y-10">
  <!-- Each store's upload block will be injected here -->
</div>

<!-- 🔹 Container for dynamic forms (e.g. editable order details) -->
<div id="dynamic-form-container"></div>

<!-- 🔹 Container for image preview and close button -->
<div id="order-upload-image-new" class="order-upload-image-new relative">
  <button id="closeIMG" class="absolute top-4 right-4 text-white bg-black bg-opacity-50 p-2 rounded-full hover:bg-opacity-70">
    <i class="fa fa-times"></i>
  </button>
</div>
    </div>

    <div id="order-upload-image-new" class="order-upload-image-new">
	<button id="closeIMG" class="closeIMG"><i class="fa fa-times"></i></button>
	    
    </div>
    <!-- SUDO MERCHANT PANE CONTENT -->

    <div id="info-container2">
    <div class="scrollable"></div>
    </div>

    <!-- END SUDO MERCHANT PANE CONTENT -->


     <!-- MYPANE MERCHANT PANE COMBO -->
 <div class="info-container" id="info">

<div
  id="progressBarCard2"
  class=" hidden max-w-sm mx-auto p-6 bg-white rounded-xl shadow-lg flex flex-col"
>
  <!-- Title -->
<div
  id="tracker-button-container"
  class="flex flex-col w-full max-w-md mx-auto space-y-1"
>
  <!-- Title / “Waiting For Offers” -->
  <div
    id="tracker-button"
    class="text-lg font-semibold text-gray-800"
  >
    Waiting For Offers
  </div>

    <!-- Progress fill; update inline width or via JS -->
    <div
      id="tracker-progress-bar"
      class="h-full bg-blue-600 transition-all duration-300"
      style="width: 0%;"
    ></div>
  </div>

  <!-- Subtext -->
  <div
    id="tracker-subtext"
    class="text-sm text-gray-500"
  >
    No offers yet. You will be notified when one is available.
  </div>
  <div class="relative mb-6">
<!-- Gray track -->
<div class="absolute top-5 left-[12.5%] w-[75%] h-1 bg-gray-200 rounded"></div>

<!-- Fill bar -->
<div class="absolute top-5 left-[12.5%] h-1 bg-indigo-500 rounded transition-all duration-500 ease-in-out progress-bar" style="width: 0%;"></div>
    <!-- Step icons -->
    <div class="grid grid-cols-4 relative z-10">
      <!-- Step 1: Pay -->
      <div class="step flex flex-col items-center">
        <div
          class="circle w-10 h-10 flex items-center justify-center rounded-full
                 border-2 border-gray-200 bg-gray-200 text-gray-400
                 transition-colors duration-300"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-5 h-5 stroke-current"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="2"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M3 7h18M3 11h18M5 16h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2z"
            />
          </svg>
        </div>
        <span class="mt-2 text-xs font-medium text-gray-600 text-center">
          Pay
        </span>
      </div>

      <!-- Step 2: Submit Order -->
      <div class="step flex flex-col items-center">
        <div
          class="circle w-10 h-10 flex items-center justify-center rounded-full
                 border-2 border-gray-200 bg-gray-200 text-gray-400
                 transition-colors duration-300"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-5 h-5 stroke-current"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="2"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 3h6a2 2 0 012 2v2H7V5a2 2 0 012-2zM8 11h8M8 15h8"
            />
          </svg>
        </div>
        <span class="mt-2 text-xs font-medium text-gray-600 text-center">
          Submit Order
        </span>
      </div>

      <!-- Step 3: Pickup -->
      <div class="step flex flex-col items-center">
        <div
          class="circle w-10 h-10 flex items-center justify-center rounded-full
                 border-2 border-gray-200 bg-gray-200 text-gray-400
                 transition-colors duration-300"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-5 h-5 stroke-current"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="2"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M16 11V5a4 4 0 00-8 0v6M5 11h14l1 9H4l1-9z"
            />
          </svg>
        </div>
        <span class="mt-2 text-xs font-medium text-gray-600 text-center">
          Pickup
        </span>
      </div>

      <!-- Step 4: Drop Off -->
      <div class="step flex flex-col items-center">
        <div
          class="circle w-10 h-10 flex items-center justify-center rounded-full
                 border-2 border-gray-200 bg-gray-200 text-gray-400
                 transition-colors duration-300"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-5 h-5 stroke-current"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="2"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M20 13V7a2 2 0 00-1-1.732l-6-3.464a2 2 0 00-2 0l-6 3.464A2 2 0 004 7v6a2 2 0 001 1.732l6 3.464a2 2 0 002 0l6-3.464A2 2 0 0020 13z"
            />
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M16 5.25l-4 2.25-4-2.25M4.5 8.25l7.5 4.25 7.5-4.25M4 15.75l7.5 4.25 7.5-4.25"
            />
          </svg>
        </div>
        <span class="mt-2 text-xs font-medium text-gray-600 text-center">
          Drop Off
        </span>
      </div>
    </div>
  </div>


</div>


	<!-- experimental -->	

	<div id="locationSearch" class="hidden input-wrapper">
        <input type="text"  id="addressInput" placeholder="Enter Address" class="addressInput">
        <i id="search-icon" class="fas fa-search search-icon"></i>
         <button id="clearButton">×</button>
         <div id="suggestionsList" class="suggestions-box"></div>
</div>  
    
<div id="merchantSearch" class="hidden w-full flex flex-col gap-4 p-4 bg-yellow-500 text-white shadow-sm">
  <!-- Dropoff Marker and Address -->
  <div class="flex items-center gap-3">
    <i class="fas fa-map-marker text-red-500 text-lg"></i>
    <div class="flex flex-col">
      <div class="text-base font-medium">105-Ut Mallette St</div>
      <div class="text-sm text-gray-400">CHAPEL HILL, NC</div>
    </div>
  </div>

  <!-- Done Button -->
  <button onclick="dismiss3()" class="hidden text-sm text-indigo-300 font-medium self-start hover:underline">Done</button>

  <!-- Search and Filter Section -->
  <div class="flex items-center gap-4">
    <button onclick="merchantPane.moveToBreak('bottom')" class="hidden flex items-center gap-2 px-3 py-2 bg-indigo-600 text-white text-sm rounded-md hover:bg-indigo-700">
      <i class="fa fa-map"></i> Map View
    </button>

    <button onclick="filterPane.present()" class="px-3 py-2 bg-gray-700 rounded-md hover:bg-gray-600 text-white">
      <i class="fa fa-sliders" aria-hidden="true"></i>
    </button>

    <input type="text" id="search-input" placeholder="Search for restaurants..." class="flex-1 px-3 py-2 rounded-md bg-gray-800 border border-gray-600 text-sm text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500">
  </div>
</div>
<div id="mapTypeControl">
    <div class="control-group">
        <button id="mapBtn" class="control-button selected">Map</button>
        <button id="satelliteBtn" class="control-button">Satellite</button>
    </div> 
    <div class="control-group" id="terrainOption" style="display: none;">
        <input type="checkbox" id="terrainCheckbox">
        <label for="terrainCheckbox">Terrain</label>
    </div>    <div class="control-group" id="labelsOption" style="display: none;">
        <input type="checkbox" id="labelsCheckbox">
        <label for="labelsCheckbox">Labels</label>
    </div>
</div>


<!-- experimental -->
<div style="display:flex; justify-content:center;">
  <div class="pkdrContainer">
    <!-- Connector -->
    <div id="connectorColumn" class="connectorColumn">
      <div id="dropoffCircle" class="dropoff-circle"><i class="fa-solid fa-house"></i></div>
      <div class="vertical-line"></div>
      <div id="pickupCircle" class="pickup-circle"><i class="fa-solid fa-store"></i></div>
      <div class="vertical-line2"></div>
      <div
  id="courier-circle"
  class="fading-out relative inline-flex items-center justify-center w-10 h-10 rounded-full bg-black text-white shadow-md"
  style="margin-top: 0px;"
>
  <!-- Spinner -->
  <svg id="courier-spinner" class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
  </svg>

  <!-- Badge -->
  <div
    id="pendingCourierCount"
    class="absolute top-0 left-0 transform -translate-x-1/2 -translate-y-1/2 bg-red-600 text-white text-xs font-bold px-2 py-0.5 rounded-full hidden"
  >
   0
  </div>
</div>
    </div>

    <!-- Initial Loader -->
    <div id="getStateLoaderContainer">
      <div id="getStateLoader" class="getStateLoader">
        <i class="fa-solid fa-spinner fa-spin" style="color:black; font-size:30px;"></i>
        <p id="getStateText" class="state-loading-text">Loading, please wait...</p>
      </div>
    </div>

    <!-- Address and Swiper Sections -->
    <div class="pkdrRows">
      <!-- Drop-off Address -->
      <div id="dropContainer" class="row12">
        <div id="resize-trigger" class="clickDirectionText">
          <div class="pickup-header">
            <div class="pickup-left">
              <strong>Dropoff to</strong>
            </div>
	    <button
  onclick="openAddressPane();"
  id="changeAddress"
  class="inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-400"
>
  <i class="fas fa-exchange-alt text-white text-sm"></i>
  Change
</button>
<button
  onclick="openInstructionsPane();"
  id="changeInstructions"
  style="display: none;"
  class="inline-flex items-center gap-2 px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-400"
>
  <i class="fa-solid fas fa-clipboard text-white text-sm"></i>
  Delivery Info
</button>
<!--
            <button onclick="openAddressPane();" class="changeAddress" id="changeAddress">
              <i class="fas fa-exchange-alt"></i> Change
            </button>
            <button onclick="openInstructionsPane();" style="display:none;" id="changeInstructions" class="changeInstructions">
              <i class="fa-solid fa-list-check"></i> Info
            </button>
-->
          </div>
        </div>
        <div class="DDAddress">
<div id="addressOverlayAddress2LabelWrapper" class="flex items-center">		
          <div id="addressOverlayAddress2Label" style="font-weight:500;font-size:18px;"></div>
</div>
          <div id="addressOverlayAddress2"></div>
        </div>
      </div>

      <!-- Store Swiper -->
      <div id="bottomB" class="row12">
        <div id="resize-trigger" class="clickDirectionText">
          <div class="pickup-header">
            <div class="pickup-left">
              <strong>Pickup from</strong>
            </div>
	    <button
 onclick="addPickupLocations();"			    
  id="chooseStoreButton"
  class="inline-flex items-center gap-2 px-4 py-2 bg-yellow-500 text-white text-sm font-medium rounded-md hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-blue-400"
>
  <i class="fas fa-plus text-white text-sm"></i>
  Add
</button>
            <button
 onclick="dismiss3();"
  id="doneChooseStoreButton"
  class="hidden inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400"
>
  <i class="fas fa-plus text-white text-sm"></i>
  Done
</button>
	 <!--   
		 
            <button class="changeAddress" id="chooseStoreButton">
              <i class="fas fa-plus"></i> Add
            </button>
	 -->
          </div>
        </div>

        <div id="swiperPaginationStores" class="swiper-pagination-stores"></div>

        <div class="DDAddress" style="border-bottom: none;">
          <div id="selectedStoresContainerOverlay" class="selectedStoresContainerOverlay"></div>

          <div id="selectedStoresContainer" class="swiper-container">
            <div id="selectedStoresWrapper" class="swiper-wrapper">
              <!-- Slides injected dynamically -->
            </div>
          </div>
        </div>

        <div class="selectedStoresNavigation">
          <div id="previous" class="swiper-button-prev">
            <i class="fas fa-chevron-left"></i>
          </div>
          <div class="slide-counter" id="slideCounter"></div>
          <div id="nextSlide" class="swiper-button-next">
            <i class="fas fa-chevron-right"></i>
          </div>
        </div>

        <span
          id="pickupOverlayAddress2"
          class="pickupOverlayAddress2"
          style="color: white; font-size: 18px;"
          tabindex="0">
        </span>
	 <div id="totalPrice">$0.00</div>
      </div>

      <!-- Courier Swiper -->
      <div id="row12Courier" class="row12">
        <div id="pickupBy" class="clickDirectionText" style="display:none;">
          <strong>Courier Offers</strong>
	            <button  onclick="displayModal()" class="cancelControl" style="color:black; background:white;" id="pay-button" >Adjust Offer</button>
        </div>

        <div id="getStateLoaderContainerSwiper">
          <div id="getStateLoaderSwiper" class="getStateLoader">
            <i class="fa-solid fa-spinner fa-spin" style="color:black; font-size:30px;"></i>
            <p id="getStateTextSwiper" class="state-loading-text">Searching, please wait...</p>
          </div>
        </div>

        <div id="courierList" class="swiper courier-swiper">
          <div id="courier-wrapper" class="courier-wrapper swiper-wrapper">
            <!-- Courier slides injected dynamically -->
          </div>
        </div>
              
	 <div style="width:58px" class="selectedStoresNavigation">
           <div id="courierPreviousSlide" class="swiper-button-prev">
              <i class="fas fa-chevron-left"></i>
            </div>
            <div class="slide-counter" id="courierPagination"></div>
            <div id="courierNextSlide" class="swiper-button-next">
              <i class="fas fa-chevron-right"></i>
            </div>
          </div>




      </div>
    </div> <!-- end .pkdrRows -->
  </div> <!-- end .pkdrContainer -->

  <!-- Hidden Days and Hours -->
<div class="waitPay" id="waitPay" style="display: none;">
  <span id="minutes" style="display: none;">0</span>
  <span id="seconds" style="display: none;">0</span>
  <span id="hours" style="display: none;">0</span>
  <span id="days" style="display: none;">0</span>
</div>

</div> <!-- end pdrContainerContainer -->

  <div id="submitStoreContent" style="width: auto; display: none;">
    
    
    <div id="selectedStoresContainerContainer">
      <div class="clickMerchantLabel">Selections</div>
    </div>

    <div class="scrollableContent" id="scrollableContent" style="overflow-x: clip; overflow-y: auto;">
      <form class="storeForm" id="storeForm" method="post">
	      <div class="hidden">      
        <div id="checkedContainer">
          <div class="checked-items">
            <!-- Checked checkboxes will be moved here -->
          </div>
        </div>
	      </div>

        <table class="sortable">
          <thead style="display: none;" class="my-header"></thead>
          <tbody id="tableBody">
            <input type="hidden" name="csrfmiddlewaretoken" value="PCycK9FwIo5sFOvHE5yZlHywzn2Xb1ja113PmmhnbStYWD9A3CYUptWKXzcl93lA">
            
              <tr data-parent-id="1" data-lat="35.91131805165857" data-lng="-79.06394697095067">
                <td>
                  <div class="checkbox-container" data-lat="35.91131805165857" data-lng="-79.06394697095067">
                    <input id="store-checkbox-1" type="checkbox" name="Al&#x27;S Burger Shack" value="Al&#x27;S Burger Shack">
                    <label for="store-checkbox-1" class="checkbox-remove">
                      <i class="fa fa-trash"></i>
                    </label>
                    <label for="store-checkbox-1">
                      <div class="store-column">
                        <img id="storeImage" src="/media/store_logos/alsburgershack.png" alt="Open in External Browser" class="store-image">
                      </div>
                      <div class="store-column">
                        <div id="1Button" class="expand-button">$2.00</div>
                        <div class="store-info">
                          <div class="checkbox-text">Al&#x27;S Burger Shack</div>
                          <div class="checkbox-category">
                            <span class="category-badge">Restaurant</span>
                            <span class="type-badge">American</span>
                          </div>
                        </div>
                      </div>
                    </label>
                  </div>
                </td>
              </tr>
            
              <tr data-parent-id="2" data-lat="35.910285766301385" data-lng="-79.07216510434458">
                <td>
                  <div class="checkbox-container" data-lat="35.910285766301385" data-lng="-79.07216510434458">
                    <input id="store-checkbox-2" type="checkbox" name="Neils Deli" value="Neils Deli">
                    <label for="store-checkbox-2" class="checkbox-remove">
                      <i class="fa fa-trash"></i>
                    </label>
                    <label for="store-checkbox-2">
                      <div class="store-column">
                        <img id="storeImage" src="/media/store_logos/neilsdeli.jpeg" alt="Open in External Browser" class="store-image">
                      </div>
                      <div class="store-column">
                        <div id="2Button" class="expand-button">$2.00</div>
                        <div class="store-info">
                          <div class="checkbox-text">Neils Deli</div>
                          <div class="checkbox-category">
                            <span class="category-badge">Restaurant</span>
                            <span class="type-badge">American</span>
                          </div>
                        </div>
                      </div>
                    </label>
                  </div>
                </td>
              </tr>
            
              <tr data-parent-id="3" data-lat="35.91003747366489" data-lng="-79.06380550674649">
                <td>
                  <div class="checkbox-container" data-lat="35.91003747366489" data-lng="-79.06380550674649">
                    <input id="store-checkbox-3" type="checkbox" name="The Purple Bowl" value="The Purple Bowl">
                    <label for="store-checkbox-3" class="checkbox-remove">
                      <i class="fa fa-trash"></i>
                    </label>
                    <label for="store-checkbox-3">
                      <div class="store-column">
                        <img id="storeImage" src="/media/store_logos/thepurplebowl.png" alt="Open in External Browser" class="store-image">
                      </div>
                      <div class="store-column">
                        <div id="3Button" class="expand-button">$2.00</div>
                        <div class="store-info">
                          <div class="checkbox-text">The Purple Bowl</div>
                          <div class="checkbox-category">
                            <span class="category-badge">Restaurant</span>
                            <span class="type-badge">Coffee_Tea</span>
                          </div>
                        </div>
                      </div>
                    </label>
                  </div>
                </td>
              </tr>
            
          </tbody>
        </table>
      </form>
    </div>
  </div>
</div> <!-- end .info-container -->








    <!-- MYPANE MERCHANT PANE COMBO END-->


    <!-- MERCHANT PANE CONENT -->


<!--

<div id="info-container2" class="info-container2" style="overflow: none;">
  <div id="submitStoreContent" style="width: auto; display: none;">
    <div class="navigator">
      <div style="display: flex; flex-direction: row; align-items: center;">
        <i class="fas fa-map-marker store-dropoff-marker"></i>
        <div class="store-dropoff" id="storeDropoff"></div>
      </div>
      <div class="useCheckboxes" onclick="dismiss3()">Done</div>
    </div>

    <div id="search-container" class="search-container draggable-handle">
      <button class="viewMap" onclick="merchantPane.moveToBreak('bottom')">
        <i class="fa fa-map"></i> Map View
      </button>

      <button class="filter-trigger" onclick="filterPane.present()">
        <i class="fa fa-sliders" aria-hidden="true"></i>
      </button>

      <input type="text" id="search-input" class="search-input" placeholder="Search for restaurants...">
    </div>

    <div id="selectedStoresContainerContainer">
      <div class="clickMerchantLabel">Selections</div>
    </div>

    <div class="scrollableContent" id="scrollableContent" style="overflow-x: clip; overflow-y: auto;">
      <form class="storeForm" id="storeForm" method="post">
        <div id="checkedContainer">
          <div class="checked-items">
          </div>
          <div id="totalPrice">$0.00</div>
        </div>

        <table class="sortable">
          <thead style="display: none;" class="my-header"></thead>
          <tbody id="tableBody">
            <input type="hidden" name="csrfmiddlewaretoken" value="PCycK9FwIo5sFOvHE5yZlHywzn2Xb1ja113PmmhnbStYWD9A3CYUptWKXzcl93lA">
            
              <tr data-parent-id="1" data-lat="35.91131805165857" data-lng="-79.06394697095067">
                <td>
                  <div class="checkbox-container" data-lat="35.91131805165857" data-lng="-79.06394697095067">
                    <input id="store-checkbox-1" type="checkbox" name="Al&#x27;S Burger Shack" value="Al&#x27;S Burger Shack">
                    <label for="store-checkbox-1" class="checkbox-remove">
                      <i class="fa fa-trash"></i>
                    </label>
                    <label for="store-checkbox-1">
                      <div class="store-column">
                        <img id="storeImage" src="/media/store_logos/alsburgershack.png" alt="Open in External Browser" class="store-image">
                      </div>
                      <div class="store-column">
                        <div id="1Button" class="expand-button">$2.00</div>
                        <div class="store-info">
                          <div class="checkbox-text">Al&#x27;S Burger Shack</div>
                          <div class="checkbox-category">
                            <span class="category-badge">Restaurant</span>
                            <span class="type-badge">American</span>
                          </div>
                        </div>
                      </div>
                    </label>
                  </div>
                </td>
              </tr>
            
              <tr data-parent-id="2" data-lat="35.910285766301385" data-lng="-79.07216510434458">
                <td>
                  <div class="checkbox-container" data-lat="35.910285766301385" data-lng="-79.07216510434458">
                    <input id="store-checkbox-2" type="checkbox" name="Neils Deli" value="Neils Deli">
                    <label for="store-checkbox-2" class="checkbox-remove">
                      <i class="fa fa-trash"></i>
                    </label>
                    <label for="store-checkbox-2">
                      <div class="store-column">
                        <img id="storeImage" src="/media/store_logos/neilsdeli.jpeg" alt="Open in External Browser" class="store-image">
                      </div>
                      <div class="store-column">
                        <div id="2Button" class="expand-button">$2.00</div>
                        <div class="store-info">
                          <div class="checkbox-text">Neils Deli</div>
                          <div class="checkbox-category">
                            <span class="category-badge">Restaurant</span>
                            <span class="type-badge">American</span>
                          </div>
                        </div>
                      </div>
                    </label>
                  </div>
                </td>
              </tr>
            
              <tr data-parent-id="3" data-lat="35.91003747366489" data-lng="-79.06380550674649">
                <td>
                  <div class="checkbox-container" data-lat="35.91003747366489" data-lng="-79.06380550674649">
                    <input id="store-checkbox-3" type="checkbox" name="The Purple Bowl" value="The Purple Bowl">
                    <label for="store-checkbox-3" class="checkbox-remove">
                      <i class="fa fa-trash"></i>
                    </label>
                    <label for="store-checkbox-3">
                      <div class="store-column">
                        <img id="storeImage" src="/media/store_logos/thepurplebowl.png" alt="Open in External Browser" class="store-image">
                      </div>
                      <div class="store-column">
                        <div id="3Button" class="expand-button">$2.00</div>
                        <div class="store-info">
                          <div class="checkbox-text">The Purple Bowl</div>
                          <div class="checkbox-category">
                            <span class="category-badge">Restaurant</span>
                            <span class="type-badge">Coffee_Tea</span>
                          </div>
                        </div>
                      </div>
                    </label>
                  </div>
                </td>
              </tr>
            
          </tbody>
        </table>
      </form>
    </div>
  </div>
</div>

-->
<!-- END MERCHANT PANE CONTENT -->





<!-- FILTER PANE CONTENT -->




<div class="filter-pane">
  <div class="filter-header">
    <h3>Filter & Sort</h3>
    <button class="close-btn" onclick="dismiss8()"><i class="fa fa-times"></i></button>
  </div>

  <!-- Sort Section -->
  <div class="filter-section">
<label for="sort-options" class="filter-label" >Sort By:</label>
<select id="sort-options" onchange="handleSortChange(this.value)">
  <option value="merchant-asc">Merchant (A–Z)</option>
  <option value="merchant-desc">Merchant (Z–A)</option>
  <option value="price-asc">Price (Low–High)</option>
  <option value="price-desc">Price (High–Low)</option>
</select>
  </div>
  <!-- Category and Type Filters -->
  <div class="filter-section">
    <label for="store-category">Store Category</label>
    <select id="store-category">
      <option value="">All Categories</option>
      <option value="restaurant">Restaurant</option>
      <option value="grocery">Grocery</option>
      <option value="other">Other</option>
    </select>
  </div>

  <div class="filter-section">
    <label for="store-type">Store Type</label>
    <select id="store-type">
      <option value="">All Types</option>
      <!-- Dynamically filled based on category -->
    </select>
  </div>

  <!-- Footer Buttons -->
  <div class="filter-footer">
    <button class="apply-btn" onclick="filterPane.destroy()">Done</button>
    <button class="reset-btn" onclick="resetFilters()">Reset</button>
  </div>
</div>

<!-- END FILTER PANE CONTENT -->




<!-- MODIFY OFFER PANE CONTENT -->

<div id="modal-container" style="display:none;"class="h-[300px] bg-white p-6 rounded-xl shadow-lg max-w-md mx-auto">
  <div class="notModal space-y-4">
    <h2 class="text-xl font-semibold text-gray-800">Optimize Your Offer</h2>
    <p class="text-sm text-gray-600">
      Adjust your bid to improve the chances of your order being accepted quickly. A higher bid can help couriers prioritize your request.
    </p>

    <form id="modify-payment-form" method="POST" class="space-y-4">
      <p class="text-sm font-medium text-gray-700">
        <strong>Current Offer:</strong>
        <span id="current-offer" class="text-2xl text-gray-900 ml-2">$0.00</span>
      </p>

      <div>
        <label for="new-amount" class="block text-sm font-medium text-gray-700 mb-1">New Bid Amount:</label>
        <div class="flex items-center border border-gray-300 rounded-lg px-3 py-2 bg-gray-50 w-[230px]">
          <span class="text-gray-500 text-base mr-2">$</span>
          <input
            type="number"
            name="user"
            id="new-amount"
            min="4.00"
            step="0.01"
            required
            placeholder="Enter Amount"
            class="flex-1 bg-transparent border-none text-right text-base text-gray-800 placeholder-gray-400 focus:outline-none"
          >
        </div>
      </div>

      <div class="flex gap-4 pt-2">
        <button
          type="submit"
          class="custom-button h-[60px] px-6 py-2 bg-black text-white rounded-lg hover:bg-gray-900 transition"
        >
          Confirm
        </button>
        <button
          type="button"
          onClick="hideModal()"
          class="custom-button h-[60px] px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition"
        >
          Cancel
        </button>
      </div>
    </form>
  </div>
</div>



<!-- END MODEIFY OFFER PANE CONTENT -->

<div class="instructions-pane max-w-xl mx-auto mt-8" id="instructions">
 <script id="userInstructions" type="application/json">{"dropoff_option": "Leave at Door", "delivery_time_preference": "ASAP", "apartment_number": "", "access_instructions": "", "instructions": "Leave at door"}</script>	
  <!-- 🔹 Editable Preview Block -->
  <div id="instructionsPreview" class="bg-gray-50 p-4 rounded-lg shadow space-y-2">
    <div class="flex justify-between items-center">
      <h3 class="text-lg font-semibold text-gray-800">Your Delivery Instructions</h3>
      <button id="editInstructionsBtn" class="text-blue-600 hover:underline text-sm">Edit</button>
    </div>
    <div id="addressOverlayAddress4"></div>

	  
    <div id="instructionsSummary" class="text-sm text-gray-700 leading-relaxed">
      <!-- Populated dynamically -->
    </div>
  </div>

  <!-- 🔹 Editable Form Block -->
  <div id="instructionsForm" style="padding-top:0px;"class="hidden bg-white p-6 rounded-xl shadow-md space-y-4">
    <h2 class="text-xl font-semibold text-gray-800">Update Instructions</h2>

    <!-- Dropoff Method -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Dropoff Method:</label>
      <div class="flex space-x-6 ml-4">
          <label class="inline-flex items-center space-x-2">
              <input type="radio" name="dropoffMethod" value="Leave at Door" checked class="form-radio text-blue-600">
              <span>Leave at Door</span>
          </label>
         <label class="inline-flex items-center space-x-2">
             <input type="radio" name="dropoffMethod" value="Hand it to Me" class="form-radio text-blue-600">
             <span>Hand it to Me</span>
         </label>
      </div>
    </div>

    <!-- Apartment Access -->
    <div class="flex flex-wrap gap-6">
      <div class="flex-1 min-w-[140px]">
        <label for="apartmentNumber" class="block text-sm font-medium text-gray-700 mb-1">Apartment/Suite:</label>
        <input type="text" id="apartmentNumber" name="apartment_number"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>

      <div class="flex-1 min-w-[100px]">
        <label for="accessCode" class="block text-sm font-medium text-gray-700 mb-1">Access Code:</label>
        <input type="text" id="accessCode" name="access_code"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
    </div>

    <!-- Delivery Time -->
    <div>
      <label for="deliveryTime" class="block text-sm font-medium text-gray-700 mb-1">Delivery Time Preference:</label>
      <select id="deliveryTime"
        class="w-32 px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
        <option value="ASAP">ASAP</option>
        <option value="1 hour">1 Hour</option>
        <option value="2 hour">2 Hours</option>
        <option value="3 hour">3 Hours</option>
        <option value="End of Day">End of Day</option>
      </select>
    </div>

    <!-- Additional Notes -->
    <div>
      <label for="deliveryInstructions" class="block text-sm font-medium text-gray-700 mb-1">Additional Notes:</label>
      <textarea id="deliveryInstructions" name="delivery_instructions" rows="4"
        class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
        placeholder="Enter additional delivery instructions..."></textarea>
    </div>

    <!-- Submit Button -->
    <div>
      <button type="button"
        class="submitNewInstructionsButton inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
        <i class="fa fa-pencil mr-2"></i> Save Instructions
      </button>
    </div>
  </div>















</div>
    
<!-- Include Interact.js library from CDN -->

<script src="/static/interactjs/interact.min.js"></script>
<script src="/static/cupertino-pane/cupertino-pane.min.js"></script>
<script src="/static/fusejs/interact.min.js"></script>
<script>
let instructions3; 






document.addEventListener("DOMContentLoaded", () => {
// Start checking after DOM is loaded
        loadCupertinos();
        checkIfLoaded(); // Begin checking dynamically





const circles = Array.from(
document.querySelectorAll('#progressBarCard2 .step .circle')
);
const bar       = document.querySelector('#progressBarCard2 .progress-bar');
const container = bar.parentElement;
const total     = circles.length;

function goToStep(assigned, paid, submitted, pickedUp, droppedOff) {
  const flags = [assigned, paid, submitted, pickedUp, droppedOff];
  const lastActiveIndex = flags.lastIndexOf(true);

  // 1. Restyle circles
  circles.forEach((circle, i) => {
    circle.classList.remove(
      'bg-indigo-500','text-white','border-indigo-500',
      'bg-white','text-indigo-500',
      'bg-gray-200','text-gray-400','border-gray-200'
    );
    if      (i <  lastActiveIndex) circle.classList.add('bg-indigo-500','text-white','border-indigo-500');
    else if (i === lastActiveIndex) circle.classList.add('bg-white','text-indigo-500','border-indigo-500');
    else                            circle.classList.add('bg-gray-200','text-gray-400','border-gray-200');
  });

  // 2. Measure center positions
  const containerRect = container.getBoundingClientRect();
  const firstCenter = circles[0].getBoundingClientRect().left - containerRect.left + circles[0].offsetWidth / 2;

  if (lastActiveIndex < 0) {
    bar.style.left = `${firstCenter}px`;
    bar.style.width = '0px';
    return;
  }

  const activeCenter = circles[lastActiveIndex].getBoundingClientRect().left - containerRect.left + circles[lastActiveIndex].offsetWidth / 2;

  // 3. Apply fill bar
  bar.style.left  = `${firstCenter}px`;
  bar.style.width = `${activeCenter - firstCenter}px`;
}








  const modal = document.getElementById('notification-modal');
  const enableBtn = document.getElementById('enable-notifications');
  const dismissBtn = document.getElementById('dismiss-modal');

  // Show modal only if permission hasn't been granted or denied
  if (Notification.permission === 'default') {
    modal.classList.remove('hidden');
  }

  // Handle modal dismissal
  dismissBtn.addEventListener('click', () => {
    modal.classList.add('hidden');
  });

  // Handle permission request
  enableBtn.addEventListener('click', () => {
    Notification.requestPermission().then(permission => {
      alert('📬  Permission result: ' + permission);
      modal.classList.add('hidden');

      if (permission === 'granted' && window._swRegistration) {
        subscribeUser(window._swRegistration);
      }
    });
  });

 

const previewBlock = document.getElementById("instructionsPreview");
  const formBlock = document.getElementById("instructionsForm");
  const summaryBlock = document.getElementById("instructionsSummary");
  const editBtn = document.getElementById("editInstructionsBtn");

  // Load existing instructions
  const instructions3 = JSON.parse(document.getElementById("userInstructions").textContent);

  // Populate form
  document.getElementById("deliveryInstructions").value = instructions3.instructions || "";

  // Populate preview
  function renderSummary(data) {
    const contactlessTag = data.dropoff_option === "Leave at Door"
      ? "Contactless Delivery"
      : "Meet Customer at Dropoff";

    summaryBlock.innerHTML = `
      <p><strong>${contactlessTag}</strong></p>
      <p><strong>Drop-Off:</strong> ${data.dropoff_option}</p>
      <p><strong>Apt:</strong> ${data.apartment_number || 'N/A'}</p>
      <p><strong>Access:</strong> ${data.access_instructions || 'N/A'}</p>
      <p><strong>Time:</strong> ${data.delivery_time_preference}</p>
      <p><strong>Notes:</strong> ${data.instructions || 'None'}</p>
    `;
  }

  renderSummary(instructions3);

  // Toggle to edit mode
  editBtn.addEventListener("click", () => {
    previewBlock.classList.add("hidden");
    formBlock.classList.remove("hidden");
  });

  // Save logic (hook into your existing updateInstructions function)
  document.querySelector(".submitNewInstructionsButton").addEventListener("click", () => {
    const updated = {
      dropoff_option: document.querySelector('input[name="dropoffMethod"]:checked')?.value || "Unspecified",
      apartment_number: document.getElementById("apartmentNumber")?.value.trim() || "",
      access_instructions: document.getElementById("accessCode")?.value.trim() || "",
      delivery_time_preference: document.getElementById("deliveryTime")?.value || "",
      instructions: document.getElementById("deliveryInstructions")?.value.trim() || ""
    };

    // Call your updateInstructions(user) here if needed
    renderSummary(updated);

    // Toggle back to preview
    formBlock.classList.add("hidden");
    previewBlock.classList.remove("hidden");
  });

/*	
 instructions3 = JSON.parse(document.getElementById("userInstructions").textContent);

// Now you can use the object directly
document.getElementById("apartmentNumber").value = instructions3.apartment_number || "";
document.getElementById("accessCode").value = instructions3.access_instructions || "";
document.getElementById("deliveryTime").value = instructions3.delivery_time_preference || "";
document.getElementById("deliveryInstructions").value = instructions3.instructions || ""; 


const dropoffRadios = document.querySelectorAll('input[name="dropoffMethod"]');
dropoffRadios.forEach(radio => {
  if (radio.value === instructions3.dropoff_option) {
    radio.checked = true;
  }
});

}); 	
*/



  const categoryDropdown = document.getElementById("store-category");
  const typeDropdown = document.getElementById("store-type");
  const allRows = document.querySelectorAll("#tableBody tr[data-parent-id]");

  const storeTypes = {
    restaurant: [
      "american", "mexican", "italian", "chinese", "japanese", "indian",
      "thai", "korean", "bbq", "seafood", "vegan", "fast_food"
    ],
    grocery: [
      "supermarket", "organic", "convenience", "butcher", "farmers_market"
    ],
    other: [
      "pharmacy", "liquor", "flower_shop", "pet_store", "electronics"
    ]
  };

  categoryDropdown.addEventListener("change", (e) => {
    const category = e.target.value;
    populateTypeDropdown(category);
    filterStores();
    updateUncheckedStoreMarkers();	  
  });

  typeDropdown.addEventListener("change", () => {
    filterStores();
    updateUncheckedStoreMarkers();	  
  });
  function populateTypeDropdown(category) {
    typeDropdown.innerHTML = '<option value="">All Types</option>';
    const options = storeTypes[category];
    if (options) {
      options.forEach(type => {
        const option = document.createElement("option");
        option.value = type;
        option.textContent = capitalizeWords(type.replace(/_/g, " "));
        typeDropdown.appendChild(option);
      });
    }
  }

  function capitalizeWords(str) {
    return str.replace(/\b\w/g, char => char.toUpperCase());
  }
function filterStores() {
  const selectedCategory = categoryDropdown.value;
  const selectedType = typeDropdown.value;

  const currentRows = document.querySelectorAll("#tableBody tr[data-parent-id]");

  currentRows.forEach(row => {
    const categoryText = row.querySelector(".checkbox-category .category-badge")?.textContent.toLowerCase() || "";
    const typeText = row.querySelector(".checkbox-category .type-badge")?.textContent.toLowerCase() || "";

    const categoryMatch = !selectedCategory || categoryText === selectedCategory;
    const typeMatch = !selectedType || typeText === selectedType;

    row.style.display = (categoryMatch && typeMatch) ? "" : "none";
  });
}	
});

function handleSortChange(sortBy) {
  const tableBody = document.getElementById("tableBody");
  const rows = Array.from(tableBody.querySelectorAll("tr[data-parent-id]"));

  let getValue;

  if (sortBy.startsWith("merchant")) {
    getValue = row =>
      row.querySelector(".checkbox-text")?.textContent.trim().toLowerCase() || "";
  } else if (sortBy.startsWith("price")) {
    getValue = row => {
      const priceText = row.querySelector("td:nth-child(2)")?.textContent.replace("$", "") || "0";
      return parseFloat(priceText);
    };
  }

  const ascending = sortBy.endsWith("asc");

  rows.sort((a, b) => {
    const aVal = getValue(a);
    const bVal = getValue(b);

    if (aVal < bVal) return ascending ? -1 : 1;
    if (aVal > bVal) return ascending ? 1 : -1;
    return 0;
  });

  rows.forEach(row => tableBody.appendChild(row));
}
function resetFilters() {
  const categoryDropdown = document.getElementById("store-category");
  const typeDropdown = document.getElementById("store-type");
  const allRows = document.querySelectorAll("#tableBody tr[data-parent-id]");
updateUncheckedStoreMarkers();
  // Reset dropdowns to default
  categoryDropdown.value = "";
  typeDropdown.innerHTML = '<option value="">All Types</option>';
  typeDropdown.value = "";

  // Show all store rows
  allRows.forEach(row => {
    row.style.display = "";
  });
}



let swiper;

function expandPane() {
  document.getElementById("addressOverlayAddress2Label").textContent = destination_label;

       myPaneBreaks = ({
    top: { enabled: false, height: 700, bounce: true },
    middle: { enabled: true, height: 650, bounce: true },
    bottom: { enabled: true, height: 340 }
  });
    myPane.setBreakpoints(myPaneBreaks);	

  setTimeout(() => {

    const verticalLine = document.querySelector('.vertical-line2');
    const verticalLineMain = document.querySelector('.vertical-line');
    const dropContainer = document.getElementById('dropContainer');
    const courierList = document.getElementById('courierList');
    const pickUpBy = document.getElementById('pickupBy');
    const courierCircle = document.getElementById('courier-circle');
    const courierContainer = document.getElementById('row12Courier'); 
    pickUpBy.style.display = "flex";
    pickUpBy.style.height = "40px";
    courierCircle.style.display = "flex";
//    dropContainer.style.marginBottom = "0px";
    verticalLine.style.height = "110px";
    courierContainer.style.display = "block"; 
    
    setTimeout(() => {
      myPane.moveToBreak('top');
      courierList.style.display = "block";
       courierCircle.classList.remove('fading-out');
   //   courierCircle.classList.add('animate-pulse'); 
 
    }, 500);

    document.querySelector('.footer').style.display = "flex";
    updatePayButton();
     addPayButtonListener();	  

    if (!courierList.querySelector(".swiper-slide")) {
      setTimeout(() => {
        document.getElementById('getStateLoaderContainerSwiper').style.display = 'flex';
      }, 100);
    }

    setTimeout(() => {
      const watcher = setInterval(() => {
        requestAnimationFrame(() => {
          if (!myPane.paneEl) return;

          const transformValue = myPane.paneEl.style.transform;
          const translateYMatch = transformValue.match(/translateY\(([\d.]+)px\)/);

          if (translateYMatch) {
            const paneTop = parseFloat(translateYMatch[1]);
            const windowHeight = window.innerHeight;
            const currentHeight = windowHeight - paneTop;


            const courierCountContainer = document.getElementById('courierCountContainer');
            const dropContainer = document.getElementById('dropContainer');
            const bottomB = document.getElementById('bottomB');
            const pickupCircle = document.getElementById('pickupCircle');
            const dropoffCircle = document.getElementById('dropoffCircle');
            const courierContainer = document.getElementById('row12Courier'); 
            const verticalLine = document.querySelector('.vertical-line');
            const verticalLine2 = document.querySelector('.vertical-line2');
	    const courierCircle = document.getElementById('courier-circle'); 
            const progressBar = document.getElementById('progressBarCard2');
            // Collapse when shrinking
            if (currentHeight <= 370) {
              dropContainer.classList.add('fading-collapse');
              bottomB.classList.add('fading-collapse');
              courierContainer.classList.add('fading-collapse'); 				    
              pickupCircle.classList.add('fading-out');
              dropoffCircle.classList.add('fading-out');
	      courierCircle.classList.add('fading-out');
              verticalLine.classList.add('collapsing');
              verticalLine2.classList.add('collapsing');
              pickupCircle.classList.add('fading-collapse-tight');
	      courierCircle.classList.add('fading-collapse-tight'); 
              dropoffCircle.classList.add('fading-collapse-tight');
                // Fade out the courier count
               courierCountContainer.classList.remove('fading-in');
               courierCountContainer.classList.add('fading-out');
	       //courierCircle.style.marginTop= '10px';
	           progressBar.classList.remove('hidden');

	     

		    
            }

            // Expand when returning to top
            if (currentHeight >= 500) {
	      courierContainer.classList.remove('fading-collapse'); 
              dropContainer.classList.remove('fading-collapse');
              bottomB.classList.remove('fading-collapse');
              pickupCircle.classList.remove('fading-out');
              courierCircle.classList.remove('fading-out'); 
              dropoffCircle.classList.remove('fading-out');
              verticalLine.classList.remove('collapsing');
              verticalLine2.classList.remove('collapsing');
              pickupCircle.classList.remove('fading-collapse-tight');
              dropoffCircle.classList.remove('fading-collapse-tight');
	      courierCircle.classList.remove('fading-collapse-tight'); 
		
                // Fade in the courier count
               courierCountContainer.classList.remove('fading-out');
               courierCountContainer.classList.add('fading-in');
	      
	       courierCircle.style.marginTop = '0px';
	        progressBar.classList.add('hidden'); 

		    
            }
          }
        });
      }, 150);
    }, 1200);
  }, 1000);
}
function initializeCourierSwiper() {
expandPane(); 
  if (swiper) {
    swiper.destroy(true, true);
  }

  const paginationEl = document.getElementById("courierPagination");
  const slides = document.querySelectorAll('#courier-wrapper .swiper-slide');
  const totalSlides = slides.length;
  const prevButton = document.getElementById('courierPreviousSlide');
  const nextButton = document.getElementById('courierNextSlide');

  if (totalSlides === 0) {
      goToStep(false,false,false,false,false)	  
 //   paginationEl.textContent = 'No couriers available';
      prevButton.style.display = 'none';
      nextButton.style.display = 'none';
  } else {
     goToStep(true, false,false,false,false)	  
    swiper = new Swiper('#courierList', {
      slidesPerView: 1,
      spaceBetween: 10,
      grabCursor: true,
      navigation: {
        nextEl: '#courierNextSlide',
        prevEl: '#courierPreviousSlide'
      },
pagination: {
  el: '#courierPagination',
  type: 'custom',
  renderCustom: function (swiper, current, total) {
    const prevButton = document.getElementById('courierPreviousSlide');
    const nextButton = document.getElementById('courierNextSlide');

    if (total === 0 || total === 1) {
      prevButton.style.display = 'none';
      nextButton.style.display = 'none';
      return '';
    } else {
      prevButton.style.display = 'flex';
      nextButton.style.display = 'flex';
      return `${current}/${total}`;
    }
  }
},	    
      on: {
        init() {
          updateCourierSlideCounter(this);
        },
        slideChange() {
          updateCourierSlideCounter(this);
        }
      }
    });

    updateCourierSlideCounter(swiper);
  }
  function updateCourierSlideCounter(swiperInstance) {
    const total = swiperInstance.slides.length;
    const counter = document.getElementById("courierPagination");

    if (total <= 1) {
      counter.style.display = "none";
    } else {
      const current = swiperInstance.realIndex + 1;
      counter.textContent = `${current}/${total}`;
      counter.style.display = "block";
    }
  }

	
}
function checkIfLoaded() {
    // Ensure map is fully loaded
//  const mapReady = typeof map !== "undefined" && map !== null && map.getDiv();

    // Ensure Cupertino panes exist
    const panesReady =trackerPane && myPane && paneModal && orderPane && merchantPane && addressPane && instructionsPane &&cancelPane &&labelPane; 

    if (panesReady) {
/*
swiper = new Swiper(".courier-swiper", {
    grabCursor: true, // ✅ Allow users to grab and drag
   //centeredSlides: true, // ✅ Focus the middle card
    slidesPerView: "auto",
    pagination: {
        el: ".swiper-pagination",
        type: "fraction" // ✅ Displays "1/2"
    },
	
});
*/

footerNoPane(); 


document.getElementById("mapBtn").addEventListener("click", function () {
    map.setMapTypeId("roadmap");
    this.classList.add("selected");
    document.getElementById("satelliteBtn").classList.remove("selected");
    
    document.getElementById("terrainOption").style.display = "block"; // Show terrain checkbox
    document.getElementById("labelsOption").style.display = "none"; // Hide labels checkbox
});

document.getElementById("satelliteBtn").addEventListener("click", function () {
    map.setMapTypeId("satellite");
    this.classList.add("selected");
    document.getElementById("mapBtn").classList.remove("selected");
    
    document.getElementById("terrainOption").style.display = "none"; // Hide terrain checkbox
    document.getElementById("labelsOption").style.display = "block"; // Show labels checkbox
});

document.getElementById("terrainCheckbox").addEventListener("change", function () {
    map.setMapTypeId(this.checked ? "terrain" : "roadmap");
});

document.getElementById("labelsCheckbox").addEventListener("change", function () {
    map.setMapTypeId(this.checked ? "hybrid" : "satellite");
});	    
	    
    } else {
        setTimeout(checkIfLoaded, 250); // Retry every 250ms until loaded
    }
}

let myPaneBreaks = {
  top: { enabled: false, height: window.innerHeight, bounce: true },
  middle: { enabled: true, height: 480, bounce: true },
  bottom: { enabled: false, height: 320 }
};
        let trackerPane, myPane, paneModal, orderPane, modifyPricePane, cancelPane, labelPane;
        
         function loadCupertinos() {
            // Initialize myPane
myPane = new CupertinoPane('.info-container', {
  parentElement: 'body',
  scrollElement: false,
  cssClass: 'custom-pane',
//  fitScreenHeight: true,
     clickBottomOpen: false,

	

  breaks: {
    top: { enabled: false, height: window.innerHeight, bounce: false },
    middle: { enabled: true, height: 480, bounce: true },
    bottom: { enabled: false, height: 320 },
  },

  initialBreak: 'middle',

  events: {
    onDrag: () => {
      updateMapHeight(myPane);
      positionControlsAbovePane(myPane);
    },

    onTransitionStart: () => {
      updateMapHeight(myPane);
      positionControlsAbovePane(myPane);
    },

    onTransitionEnd: () => {
      updateMapHeight(myPane);
      positionControlsAbovePane(myPane);
      updateThemeColor(myPane);
    },
  },
});		 
            trackerPane = new CupertinoPane('.info-bar', {
                parentElement: 'body',
		scrollElement: false,
		  fitScreenHeight: true,      
                cssClass: 'custom-pane',
        //      upperThanTop: true,
                breaks: {
                    top: { enabled: false, height: window.innerHeight , bounce: true },
                    middle: { enabled: true, height: 750, bounce: true },
                    bottom: { enabled: true, height: 250 }
                },
                initialBreak: 'bottom',         
                  events: {
                  onDrag: () => updateMapHeight(trackerPane),    
                  onTransitionEnd: () => {
                  updateMapHeight(trackerPane);  
                       },
                  onTransitionStart: () => {
                  updateMapHeight(trackerPane);  
                       }                          
  }                 
            });		 
            console.log(myPane);

            // Initialize paneModal
 paneModal = new CupertinoPane('.order-upload-overlay2', { 
  cssClass:'custom-modal',
  scrollElement: false, 	 
  parentElement: 'body',
  modal:false,
    fitScreenHeight: true,
    backdrop: true,
breaks: {
    top: { enabled: true, height: window.innerHeight },
    middle: { enabled: false, height: 300 },
    bottom: { enabled: false, height: 200 }	
},
initialBreak: 'top',	
 	 
  events: {
    onBackdropTap: () => dismiss(),
 onTransitionEnd: () => {
                   updateThemeColor2(paneModal,'#007bff'); 
                       }	  
  }

});
       
 orderPane = new CupertinoPane('.order-upload-image-new', { 
  cssClass:'custom-modal-image',
  parentElement: 'body',
  scrollElement: false,
    fitScreenHeight: true,  	 
breaks: {
    top: { enabled: true, height: window.innerHeight },
    middle: { enabled: false, height: 300 },
        bottom: {enabled:false, height: 150}
},
   
  modal:true,
  backdrop: false,
  events: {
    onBackdropTap: () => dismiss2()
  }
});
  merchantPane = new CupertinoPane('.info-container2', {
  dragBy: ['.draggable-handle'],
  cssClass:'merchant-pane',
  scrollElement: true, 	  
  parentElement: 'body',
  scrollable: true, // ✅ enables internal scrolling
  scrollableSelector: '.sortable',
 
  modal:false,
  buttonClose:true,
    fitScreenHeight: true,
//  backdrop: true,
breaks: {
    top: { enabled: true, height: window.innerHeight },
    middle: { enabled: false, height: 300 },
	bottom: {enabled:true, height: 150}
},
	  
    initialBreak: 'top', 


  events: {
    onBackdropTap: () => dismiss3(),
	  onTransitionEnd: () => {updateThemeColor(merchantPane)}, 
	  onTransitionStart: () => {updateMapHeight(merchantPane)}	  
  	  
}
	  
});
merchantPane.settings.animationDuration = 500;
 

addressPane = new CupertinoPane('.addressLookup', {
	
  maxFitHeight: window.innerHeight, 	  
  cssClass:'address-pane',
  parentElement: 'body',
  scrollElement: false, 	
  modal:false,
  initialBreak: 'bottom', 	  
  breaks: {           
                    top: { enabled: true, height: window.innerHeight },
                    middle: { enabled: false, height: 500, bounce: true },
                    bottom: { enabled: true, height: 430, bounce: true }
                },
	
  events: {
    onBackdropTap: () => dismiss3(),
    onDrag: () => updateMapHeight(addressPane),
  onTransitionStart: () => updateMapHeight(addressPane), 	  
    onTransitionEnd: () => {
     updatePacContainerWidth(addressPane); 	    
      updateThemeColor(addressPane); 
      updateMapHeight(addressPane);   
    }
  }

	  
});
  labelPane = new CupertinoPane('#labelLocationPane', {
  parentElement: 'body',
  scrollElement: false, 	  
  backdrop: true,
  modal: false, // 👈 enables modal behavior
  initialBreak: 'bottom', 	  
  cssClass: 'label-pane',
    breaks: {           
                    top: { enabled: false, height: 500, bounce: true },
                    middle: { enabled: false, height: 400, bounce: true },
                    bottom: { enabled: true, height: 300, bounce: true }
                },  	  
  events: {
    onBackdropTap: () => dismiss9()
  }	  
});

  paymentPane = new CupertinoPane('#payment-form', {
  parentElement: 'body',
  scrollElement: false,
  backdrop: true,
  modal: false, // 👈  enables modal behavior
  initialBreak: 'top',
  cssClass: 'label-pane',
    breaks: {
                    top: { enabled: true, height: 700, bounce: true },
                    middle: { enabled: false, height: 400, bounce: true },
                    bottom: { enabled: false, height: 300, bounce: true }
                },
  events: {
    onBackdropTap: () => dismissPaymentPane()
  }
});
  instructionsPane = new CupertinoPane('#instructions', { 
  cssClass:'instruction-pane',
  parentElement: 'body',
  modal:false,
  scrollElement: false, 	  
  backdrop: true,
  initialBreak: 'top',	  
  events: {
    onBackdropTap: () => dismiss4()
  }, 
    breaks: {           
                    top: { enabled: true, height: 550, bounce: true },
                    middle: { enabled: false, height: 300, bounce: true },
                    bottom: { enabled: false, height: 200, bounce: true }
                },  	  
  events: {
    onBackdropTap: () => dismiss4()
  }
});

  modifyPaymentPane = new CupertinoPane('#modal-container', {   cssClass:'custom-pane',
  parentElement: 'body',
  cssClass: 'modify-payment-pane',	  
  modal:false,
  backdrop: true,
  scrollElement: false, 	  
  initialBreak: 'top',  
  events: {
    onBackdropTap: () => dismiss5()
  }, 
    breaks: {           
                    top: { enabled: true, height: 500, bounce: true },
                    middle: { enabled: false, height: 400, bounce: true },
                    bottom: { enabled: false, height: 200, bounce: true }
                },        
});

   cancelPane = new CupertinoPane('.cancel-pane', {
    parentElement: 'body',
    cssClass: 'cancel-pane',
    scrollElement: false, 	   
    backdrop: true,
    breaks: {
        top: { enabled: false, height:500 },
        middle: { enabled: true, height: 350 },
        bottom: { enabled: false, height:100 }
    },
  events: {
    onBackdropTap: () => dismiss6()
  }, 	   
    initialBreak: 'middle'
});

   filterPane = new CupertinoPane('.filter-pane', {
    parentElement: 'body',
    cssClass: 'filter-pane',
    backdrop: false,
    scrollElement: false, 	   
    breaks: {
	    top: { enabled: false, height:700  },
            middle: { enabled: true, height: 500 },
            bottom: { enabled: false, height:100 }
    },
    initialBreak: 'middle'
});

   sideNavPane = new CupertinoPane('.sidenav', {
    parentElement: 'body',
    cssClass: 'custom-menu-style',
    backdrop: true,
    inverse: true,
    scrollElement: false,
    breaks: {
        top: { enabled: true, height: 200},
        middle: { enabled: false, height:200 },
        bottom: { enabled: false, height:100 }
    },
  events: {
    onBackdropTap: () => dismiss7()
  },       
    initialBreak: 'top'
});


function dismissPaymentPane(){
    button =document.getElementById("selectPayCourier");
    button.innerHTML = '<i class="fas fa-credit-card"></i> Pay Offer';
    button.disabled = false;
    document.body.classList.remove("touch-lock");
	paymentPane.destroy({animate:true}); 



}


// Function to filter table rows based on search input
function handleSearch() {
    const searchInput = document.getElementById('search-input');
    const query = searchInput.value.toLowerCase();
    const rows = document.querySelectorAll('#tableBody tr');

    rows.forEach(row => {
        const labelElement = row.querySelector('.checkbox-text');
        if (labelElement) {
            const restaurantName = labelElement.textContent.toLowerCase();
            row.style.display = restaurantName.includes(query) ? 'table-row' : 'none';
        } else {
            row.style.display = 'none';
        }
    });
	updateUncheckedStoreMarkers();
}

// Function to reset and reattach search event listener on focus
document.getElementById('search-input').addEventListener('focus', function () {
    const checkedContainer = document.getElementById('checkedContainer').style.display = 'none'; 
    const searchInput = document.getElementById('search-input');

    // Remove existing event listener to prevent multiple bindings
    searchInput.removeEventListener('input', handleSearch);
    
    // Clear input value and reapply filtering
    searchInput.value = '';
    handleSearch();

    // Reattach the event listener
    searchInput.addEventListener('input', handleSearch);
});
document.getElementById('search-input').addEventListener('blur', function () {
    console.log("Search input lost focus"); // Replace this with what you want to happen
checkedContainer.style.display='block'; 	
});
};



	
	function openInstructionsPane() {
      instructionsPane.present({animate: true});
		
//  myPane.destroy({animate: true});
	}		
function openAddressPane() {
  document.getElementById('changeAddress').style.display = "none"; 	
  const flexContainer = document.querySelector('.flex-container33');
//flexContainer.style.justifyContent = 'center';
document.getElementById('submitStores').style.display= 'none'; 	
	
   const openBtn = document.querySelector('.open-btn');
//  openBtn.classList.remove('open-btn');	
//  openBtn.classList.add('user-button'); // Add multiple classes
//  document.getElementById("search-icon").style.display="block";
  document.getElementById("addressInput").style.display = "block"; 
  document.getElementById("search-Controls").style.display = "flex";
  menu=document.getElementById("findAddress");
//  menu.style.top= "8%";
//  menu.style.left= "0"; 
//  addressPane.present({animate: true});

  
    // DOM references
    const verticalLineMain = document.querySelector('.vertical-line');
    const bottomB = document.getElementById('bottomB');
    const pickupCircle = document.getElementById('pickupCircle');
    const dropoffCircle = document.getElementById('dropoffCircle');





    // Move pane to top after short delay
    setTimeout(() => {
      bottomB.classList.add('fading-collapse');
      pickupCircle.classList.add('fading-out');
      verticalLineMain.classList.add('collapsing');
      pickupCircle.classList.add('fading-collapse-tight')
       setTimeout(() => {
          myPaneBreaks = ({
    top: { enabled: true, height: window.innerHeight, bounce: false },
    middle: { enabled: false, height: 480, bounce: true },
    bottom: { enabled: true, height: 320 }
  });
    myPane.setBreakpoints(myPaneBreaks);      
       },400);

    }, 100);
//  myPane.destroy({animate: true});
  changeHomeLocation(); 	
	}
function dismiss() {
  paneModal.destroy({animate: true});
}
function dismiss2() {
  orderPane.destroy({animate: true});
}
function dismiss3() {
undoPickupOnly(); 	
document.getElementById("chooseStoreButton").classList.remove("hidden");
//document.getElementById("doneChooseStoreButton").classList.add("hidden");
document.getElementById("submitStores").style.display = "block";
document.getElementById("confirmPickups").style.display ="none"; 
// Remove checkbox listeners
document.querySelectorAll('.checkbox-container input[type="checkbox"]').forEach(cb => {
  cb.removeEventListener('change', handleCheckboxChange);
});

// Clear markers and cluster
if (storeMarkerCluster) {
  storeMarkerCluster.clearMarkers();
  storeMarkerCluster = null;
}
uncheckedStoreMarkers.forEach(marker => marker.setMap(null));
uncheckedStoreMarkers = [];
    // Select elements
    const footerElement = document.querySelector('.footer');
 //   const selectedStoresContainer = document.getElementById("selectedStoresContainer");
      const selectedStoresContainer = document.getElementById("selectedStoresWrapper"); 
    const submitStores = document.getElementById('submitStores');

    if (selectedStoresContainer.children.length > 0) {
        footerElement.style.display = 'flex';
        submitStores.innerHTML = '<i class="fa fa-paper-plane"></i> Post Delivery Request';
        submitStores.className =" w-full max-w-[90%] mx-auto bg-blue-500 text-white text-base font-semibold rounded-lg h-14 flex items-center justify-center"; // Correct class name update
    } else {
        footerElement.style.display = 'flex';
        submitStores.innerHTML = "No Pick-ups Selected"; // Fixed string syntax
        submitStores.className = "inactiveButton"; // Correct class name update
    }
}	
function dismiss4() {
  const previewBlock = document.getElementById("instructionsPreview");
  const formBlock = document.getElementById("instructionsForm");
  const submittedInstructionsContainer = document.querySelector(".submittedInstructionsContainer");
  const newInstructionsContainer = document.getElementById("newInstructions");

  // 🔹 Reset to preview view
  previewBlock.classList.remove("hidden");
  formBlock.classList.add("hidden");

  // 🔹 Show submitted summary if needed
  if (submittedInstructionsContainer) {
    submittedInstructionsContainer.style.display = "block";
  }
  if (newInstructionsContainer) {
    newInstructionsContainer.style.display = "none";
  }

  // 🔹 Close the pane
  if (typeof instructionsPane !== "undefined") {
    instructionsPane.destroy({ animate: true });
  }

  // Optional: re-present another pane
  // if (typeof myPane !== "undefined") {
  //   myPane.present({ animate: true });
  // }
}
function dismiss5() {    
  modifyPaymentPane.destroy({animate: true});
}
function dismiss6() {
	cancelPane.destroy({animate:true}); 
}
function dismiss7() {
        sideNavPane.destroy({animate:true});
}
function dismiss8() {
        filterPane.destroy({animate:true});
}
function dismiss9() {
        labelPane.destroy({animate:true});
}
function updateMapWidth(pane) {
    requestAnimationFrame(() => {
        if (!pane.paneEl) return;

        // Get the pane's width dynamically
        const paneWidth = pane.paneEl.getBoundingClientRect().width;

        const mapContainer = document.getElementById('map-container');
        if (mapContainer) {
            mapContainer.style.width = `${paneWidth}px`;
        }

        const submitFooter = document.getElementById('submitFooter');
        if (submitFooter) {
            submitFooter.style.width = `${paneWidth}px`;
        }
    }); // ✅ Corrected closing bracket placement
}
/*
function updateMapHeight(pane) {
    requestAnimationFrame(() => {
        if (!pane.paneEl) return;

        // Extract translateY value from the transform property
        const transformValue = pane.paneEl.style.transform;
        const translateYMatch = transformValue.match(/translateY\(([\d.]+)px\)/);

        if (translateYMatch) {
            const paneTop = parseFloat(translateYMatch[1]); // Get numeric translateY value

            const mapContainer = document.querySelector('#map'); // Adjust based on your map element
if (mapContainer && smsSequence !== "SEND_SCREENSHOT") {
  mapContainer.style.height = `${paneTop + 15}px`; // Apply extra offset
} else {
  mapContainer.style.height = `${paneTop}px`; // No offset for screenshots
}

		
        }
    });
}
*/
function positionControlsAbovePane(pane) {
  requestAnimationFrame(() => {
    const controls = document.getElementById('mapDisplayControls');
    if (!pane.paneEl || !controls) return;

    const transformValue = pane.paneEl.style.transform;
    const translateYMatch = transformValue.match(/translateY\(([\d.]+)px\)/);

    if (translateYMatch) {
      const paneTop = parseFloat(translateYMatch[1]);
      controls.style.transform = `translateY(${paneTop - controls.offsetHeight}px)`;
    }
  });
}
function updateMapHeight(pane) {
  requestAnimationFrame(() => {
    if (!pane.paneEl) return;

    const transformValue = pane.paneEl.style.transform;
    const translateYMatch = transformValue.match(/translateY\(([\d.]+)px\)/);

    if (translateYMatch) {
      const paneTop = parseFloat(translateYMatch[1]);
      const panelHeight = window.innerHeight - paneTop;

      const mapContainer = document.querySelector('#map');
      const draggable = document.querySelector('.cupertino-pane-wrapper .draggable');
      const paneContent = document.querySelector('.cupertino-pane-wrapper.custom-pane.rendered .pane');

      if (mapContainer) {
        if (panelHeight < 350) {
	  if (smsSequence === 'SEND_SCREENSHOT'){
             mapContainer.style.height = `${window.innerHeight}px`;
				     }else{
          mapContainer.style.height = `${window.innerHeight - 90}px`;
				     }
          draggable?.classList.add('transparent-bg');
          paneContent?.classList.add('transparent-bg');
        } else {
          mapContainer.style.height = `${paneTop + 15}px`;
          draggable?.classList.remove('transparent-bg');
          paneContent?.classList.remove('transparent-bg');
        }
      }
    }
  });
}	

function updatePacContainerWidth(pane) {
    requestAnimationFrame(() => {
        if (!pane.paneEl) return;

        // Get the pane's width dynamically
        const paneWidth = pane.paneEl.getBoundingClientRect().width;

        const pacContainer = document.querySelector('.pac-container');
        if (pacContainer) {
            pacContainer.style.width = `${paneWidth}px`; // Set width dynamically
        }
    });
}

function updateThemeColor2(pane,color){
	    setTimeout(() => {
        const paneHeight = pane.currentBreak();

        console.log("Pane Height:", paneHeight);

        if (paneHeight === 'top') {
            document.querySelector('meta[name="theme-color"]').setAttribute('content', color);
        } else {
            document.querySelector('meta[name="theme-color"]').setAttribute('content', 'white');
        }
    }, 100);
}
function updateThemeColor(pane) {
  setTimeout(() => {
    const paneHeight = pane.currentBreak();
    console.log("Pane Height:", paneHeight);

    // DOM references
    const merchantSearch = document.getElementById("merchantSearch");
    const searchInput = document.getElementById('search-input');
    const locationSearch = document.getElementById('locationSearch');
    const locationInstructionsWrapper = document.getElementById('locationInstructionsWrapper');
    const submitStoreContent = document.getElementById("submitStoreContent");
    const dropContainer = document.getElementById("dropContainer");
    const bottomB = document.getElementById("bottomB");
    const connectorColumn = document.getElementById('connectorColumn'); 
    const isHidden = window.getComputedStyle(submitStoreContent).display === 'none';
    const dropCollapsed = dropContainer?.classList.contains('fading-collapse');
    const pickupCollapsed = bottomB?.classList.contains('fading-collapse');

    // Drag styling references
    const paneClass = pane.settings.cssClass;
    if (!paneClass) return;

    const moveElement = document.querySelector(`.${paneClass} .move`);
    const draggableElement = document.querySelector(`.${paneClass} .draggable`);

    if (paneHeight === 'top') {
	    connectorColumn.style.display = 'none';
      if (!dropCollapsed) {
        searchInput.classList.add("show");
        locationSearch.style.display = "flex";
        locationInstructionsWrapper.style.display = 'none';
        document.querySelector('meta[name="theme-color"]').setAttribute('content', '#4f46e5');

        if (moveElement && draggableElement) {
          moveElement.style.backgroundColor = '#4f46e5';
          draggableElement.style.backgroundColor = '#4f46e5';
          draggableElement.style.borderRadius = '0';
        }
      }

      if (!pickupCollapsed) {
        merchantSearch.style.display = "block";
        submitStoreContent.style.display = "block";
        document.querySelector('meta[name="theme-color"]').setAttribute('content', '#eab308');

        if (moveElement && draggableElement) {
          moveElement.style.backgroundColor = '#eab308';
          draggableElement.style.backgroundColor = '#eab308';
          draggableElement.style.borderRadius = '0';
        }
      }
    } else {
      connectorColumn.style.display = 'flex'; 
      submitStoreContent.style.display = "none";
      locationSearch.style.display = "none";
      merchantSearch.style.display = "none";
      locationInstructionsWrapper.style.display = 'block';
      document.querySelector('meta[name="theme-color"]').setAttribute('content', 'white');

      if (moveElement && draggableElement) {
        moveElement.style.backgroundColor = 'black';
        draggableElement.style.backgroundColor = 'white';
        draggableElement.style.borderRadius = '12px 12px 0px 0px';
      }
    }
  }, 100);
}

function handleCheckboxChange() {
  updateUncheckedStoreMarkers();
}


function getRowForCheckbox(checkbox) {
  if (!checkbox || !checkbox.id) return null;
  const parentId = checkbox.id.replace("store-checkbox-", "");
  return document.querySelector(`tr[data-parent-id="${parentId}"]`);
}
function createMarkerIcon(imageUrl, callback) {
  const logicalSize = 80;       // Desired visual size
  const tailHeight = 12;
  const dpr = window.devicePixelRatio || 1; // Handle retina

  const canvas = document.createElement('canvas');
  canvas.width = logicalSize * dpr;
  canvas.height = (logicalSize + tailHeight) * dpr;
  canvas.style.width = `${logicalSize}px`;
  canvas.style.height = `${logicalSize + tailHeight}px`;

  const ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr); // Scale drawing for high-DPI

  const centerX = logicalSize / 2;
  const centerY = logicalSize / 2;
  const outerRadius = centerX - 4;
  const imageRadius = outerRadius - 4;

  const img = new Image();
  img.crossOrigin = 'anonymous';
  img.onload = () => {
    // Draw circular background
    ctx.beginPath();
    ctx.arc(centerX, centerY, outerRadius, 0, Math.PI * 2);
    ctx.fillStyle = 'white';
    ctx.shadowColor = 'rgba(0,0,0,0.3)';
    ctx.shadowBlur = 5;
    ctx.fill();

    ctx.lineWidth = 2;
    ctx.strokeStyle = '#2563eb';
    ctx.stroke();
    ctx.closePath();

    // Clip and draw store image
    ctx.save();
    ctx.beginPath();
    ctx.arc(centerX, centerY, imageRadius, 0, Math.PI * 2);
    ctx.closePath();
    ctx.clip();

    const { width, height } = img;
    const side = Math.min(width, height);
    const sx = (width - side) / 2;
    const sy = (height - side) / 2;

    const imageSize = imageRadius * 2;
    ctx.drawImage(
      img,
      sx, sy, side, side,
      centerX - imageSize / 2,
      centerY - imageSize / 2,
      imageSize,
      imageSize
    );
    ctx.restore();

    // Draw pointer tail
    ctx.beginPath();
    ctx.moveTo(centerX - 7, logicalSize);
    ctx.lineTo(centerX, logicalSize + tailHeight);
    ctx.lineTo(centerX + 7, logicalSize);
    ctx.fillStyle = '#2563eb';
    ctx.fill();

    callback(canvas.toDataURL());
  };

  img.src = imageUrl;
}
/*
function createMarkerIcon(imageUrl, callback) {
  const canvas = document.createElement('canvas');
  const size = 60;
  canvas.width = size;
  canvas.height = size + 10; // extra space for pointer tail
  const ctx = canvas.getContext('2d');

  const img = new Image();
  img.crossOrigin = 'anonymous';
  img.onload = () => {
    // Draw circular background
    ctx.beginPath();
    ctx.arc(size / 2, size / 2, size / 2 - 4, 0, Math.PI * 2);
    ctx.fillStyle = 'white';
	  
    ctx.shadowColor = 'rgba(0,0,0,0.3)';
    ctx.shadowBlur = 4;
    ctx.fill();

    ctx.lineWidth = 2;
    ctx.strokeStyle = '#000'; // Black border
    ctx.stroke();

	  
    ctx.closePath();

    // Clip and draw store image
    ctx.save();
    ctx.beginPath();
    ctx.arc(size / 2, size / 2, size / 2 - 6, 0, Math.PI * 2);
    ctx.closePath();
    ctx.clip();
    ctx.drawImage(img, 0, 0, size, size);
    ctx.restore();

    // Optional: draw pointer tail
    ctx.beginPath();
    ctx.moveTo(size / 2 - 6, size);
    ctx.lineTo(size / 2, size + 10);
    ctx.lineTo(size / 2 + 6, size);
    ctx.fillStyle = '#facc15';
    ctx.fill();

    callback(canvas.toDataURL());
  };
  img.src = imageUrl;
}
*/
const uncheckedStoreMarkerMap = new Map(); // storeName → marker

function updateUncheckedStoreMarkers() {
  if (storeMarkerCluster) {
    storeMarkerCluster.clearMarkers();
    storeMarkerCluster = null;
  }

  const newMarkerPromises = [];
  const newMarkerMap = new Map();

  document.querySelectorAll('.checkbox-container').forEach(container => {
    const checkbox = container.querySelector('input[type="checkbox"]');
    if (!checkbox || checkbox.checked) return;

    const row = getRowForCheckbox(checkbox);
    if (!row || row.style.display === "none") return;

    const lat = parseFloat(row.dataset.lat);
    const lng = parseFloat(row.dataset.lng);
    if (isNaN(lat) || isNaN(lng)) return;

    const storeName = checkbox.name || checkbox.value;

    // Reuse existing marker if available
    if (uncheckedStoreMarkerMap.has(storeName)) {
      const existingMarker = uncheckedStoreMarkerMap.get(storeName);
      existingMarker.setMap(map);
      newMarkerMap.set(storeName, existingMarker);
      return;
    }

    // Create new marker with DROP animation
    newMarkerPromises.push(new Promise(resolve => {
      createLabeledMarker({ lat, lng }, storeName, checkbox, marker => {
        if (marker) {
          newMarkerMap.set(storeName, marker);
        }
        resolve(marker);
      });
    }));
  });

  // Remove old markers not in the new set
  uncheckedStoreMarkerMap.forEach((marker, storeName) => {
    if (!newMarkerMap.has(storeName)) {
      marker.setMap(null);
    }
  });

  // Finalize new marker set
  Promise.all(newMarkerPromises).then(newMarkers => {
    uncheckedStoreMarkers = [...newMarkerMap.values()];
    uncheckedStoreMarkerMap.clear();
    newMarkerMap.forEach((marker, storeName) => {
      uncheckedStoreMarkerMap.set(storeName, marker);
    });

    storeMarkerCluster = new markerClusterer.MarkerClusterer({
      map,
      markers: uncheckedStoreMarkers
    });
  });
}
/*
function createLabeledMarker(position, storeName, checkbox, done) {
  const matchedStore = jsOpenStores.find(store => store.store_name === storeName);
  const imageUrl = matchedStore?.link_image
    ? `/media/${matchedStore.link_image}`
    : matchedStore?.external_image_link || null;

  if (!imageUrl) return done(null);

  createMarkerIcon(imageUrl, (styledIconUrl) => {
    const marker = new google.maps.Marker({
      position,
      map,
      icon: {
        url: styledIconUrl,
        scaledSize: new google.maps.Size(40, 40),
        labelOrigin: new google.maps.Point(20, 50),
      },
      label: {
        text: storeName,
        color: '#2563eb',
        fontSize: '14px',
        fontWeight: 'bold',
      },
      title: storeName,
      animation: google.maps.Animation.DROP,
    });

    marker.addListener('click', () => {
      checkbox.checked = true;
      checkbox.dispatchEvent(new Event('change'));
       setTimeout(updateUncheckedStoreMarkers, 500); 
    });

    done(marker);
  });
}

*/
async function createLabeledMarker(position, storeName, checkbox, done) {
  const matchedStore = jsOpenStores.find(store => store.store_name === storeName);
  const imageUrl = matchedStore?.link_image
    ? `/media/${matchedStore.link_image}`
    : matchedStore?.external_image_link || null;

  if (!imageUrl) return done(null);

  const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");

  const markerContent = buildUnhighlightedMarkerContent(storeName, imageUrl);

  const marker = new AdvancedMarkerElement({
    map,
    content: markerContent,
    position,
    title: storeName,
    zIndex: 1, // Lower than highlighted
  });

  marker.addListener('click', () => {
    checkbox.checked = true;
    checkbox.dispatchEvent(new Event('change'));
    setTimeout(updateUncheckedStoreMarkers, 500);
  });

  done(marker);
}
function buildUnhighlightedMarkerContent(storeName, linkImage) {
  const container = document.createElement("div");
  container.classList.add("unhighlighted-marker");

  container.innerHTML = `
    <div class="unhighlighted-icon">
      <img class="unhighlighted-logo" src="${linkImage}" alt="${storeName}" />
      <div class="arrow-down">
        <i class="fas fa-chevron-down"></i>
      </div>
    </div>
    <div class="unhighlighted-label">${storeName}</div>
  `;

  return container;
}

/*
function createLabeledMarker(position, storeName, checkbox) {
  const matchedStore = jsOpenStores.find(store => store.store_name === storeName);
  const imageUrl = matchedStore?.link_image
    ? `/media/${matchedStore.link_image}`
    : matchedStore?.external_image_link || null;

  if (!imageUrl) return;

  createMarkerIcon(imageUrl, (styledIconUrl) => {
    const marker = new google.maps.Marker({
      position,
      map,
      icon: {
        url: styledIconUrl,
        scaledSize: new google.maps.Size(50, 60),
        labelOrigin: new google.maps.Point(25, 70),
      },
      label: {
        text: storeName,
        color: '#333',
        fontSize: '12px',
        fontWeight: 'bold',
      },
      title: storeName,
      animation: google.maps.Animation.DROP,
    });

    marker.addListener('click', () => {
      checkbox.checked = true;
      checkbox.dispatchEvent(new Event('change'));
      updateUncheckedStoreMarkers();
    });

    uncheckedStoreMarkers.push(marker);
    storeMarkerCluster?.addMarker(marker);
  });
}

function updateUncheckedStoreMarkers() {
  if (storeMarkerCluster) {
    storeMarkerCluster.clearMarkers();
    storeMarkerCluster = null;
  }

  uncheckedStoreMarkers.forEach(marker => marker.setMap(null));
  uncheckedStoreMarkers = [];

  document.querySelectorAll('.checkbox-container').forEach(container => {
    const checkbox = container.querySelector('input[type="checkbox"]');
    if (!checkbox || checkbox.checked) return;

    const row = getRowForCheckbox(checkbox);
    if (!row || row.style.display === "none") return;

    const lat = parseFloat(row.dataset.lat);
    const lng = parseFloat(row.dataset.lng);
    if (isNaN(lat) || isNaN(lng)) return;

    const storeName = checkbox.name || checkbox.value;
    const marker = createLabeledMarker({ lat, lng }, storeName, checkbox);
    uncheckedStoreMarkers.push(marker);
  });

  storeMarkerCluster = new markerClusterer.MarkerClusterer({
    map,
    markers: uncheckedStoreMarkers
  });
}
*/
function undoPickupOnly() {
 setTimeout(() => {	
  const verticalLineMain = document.querySelector('.vertical-line');
  const bottomB = document.getElementById('bottomB');
  const pickupCircle = document.getElementById('pickupCircle');
  const dropoffCircle = document.getElementById('dropoffCircle');
  const dropContainer = document.getElementById('dropContainer');

  // Revert animations and styles
  if (dropContainer) dropContainer.classList.remove('fading-collapse');
  if (dropoffCircle) {
    dropoffCircle.classList.remove('fading-out');
    dropoffCircle.classList.remove('fading-collapse-tight');
  }
  if (verticalLineMain) verticalLineMain.classList.remove('collapsing');
  if (pickupCircle) pickupCircle.classList.remove('fading-collapse-tight');
  if (bottomB) bottomB.classList.remove('fading-collapse');
  }, 400);
  // Reset pane layout
     myPaneBreaks = {
      top: { enabled: false, height: window.innerHeight, bounce: true },
      middle: { enabled: true, height: 480, bounce: true },
      bottom: { enabled: false, height: 320 }
    };
    myPane.setBreakpoints(myPaneBreaks);
    myPane.moveToBreak('middle');

  console.log("Reverted to drop-off layout");
}
function showPickupOnly() {
  // DOM references
  const verticalLineMain = document.querySelector('.vertical-line');
  const bottomB = document.getElementById('bottomB');
  const pickupCircle = document.getElementById('pickupCircle');
  const dropoffCircle = document.getElementById('dropoffCircle');
  const dropContainer = document.getElementById('dropContainer');

  // Animate dropoff collapse and show pickup circle
  setTimeout(() => {
    if (dropContainer) dropContainer.classList.add('fading-collapse');
    if (dropoffCircle) {
      dropoffCircle.classList.add('fading-out');
      dropoffCircle.classList.add('fading-collapse-tight');
    }
    if (verticalLineMain) verticalLineMain.classList.add('collapsing');

    // Update pane breakpoints shortly after collapse animation begins
    setTimeout(() => {
       myPaneBreaks = {
        top: { enabled: true, height: window.innerHeight, bounce: false },
        middle: { enabled: false, height: 480, bounce: true },
        bottom: { enabled: true, height: 320 }
      };
      myPane.setBreakpoints(myPaneBreaks);
    }, 400);
  }, 100);
}
function createMarkerSVG(label, width) {
  const centerX = width / 2;

  return `
    <svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="40">
      <rect x="0" y="0" rx="6" ry="6" width="${width}" height="28" fill="#007bff" />
      <text x="${centerX}" y="18" text-anchor="middle" font-size="12" font-family="Arial" fill="#ffffff">${label}</text>
      <polygon points="${centerX - 6},28 ${centerX},36 ${centerX + 6},28" fill="#007bff" />
    </svg>
  `;
}

function getMarkerWidth(label) {
  return Math.max(40, label.length * 7 + 16);
} 	
	
  </script>
<!--<div id="menu" style="display:none;"class="header">
<span class="open-btn" onclick="openNav()"><i class="fa fa-user" aria-hidden="true"></i></span> 
</div>-->

<div id="overlay-container" class="overlay-container">
    <!-- Centered Image -->
    <img rel="icon" class="overlay-image" src="/static/splash/splash_screens/icon.png" alt="App Icon">

    <!-- Container for spinner & text (separate from image centering) -->
    <div class="loading-container">
        <i class="fa-solid fa-spinner fa-spin"></i>
        <p id="loading-text">Loading, please wait...</p>
    </div>
</div>    



<div id="notification-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-lg shadow-lg p-6 max-w-sm w-full text-center">
    <h2 class="text-lg font-semibold mb-2">Enable Notifications</h2>
    <p class="text-sm text-gray-600 mb-4">Get real-time updates and alerts.</p>
    <div class="flex justify-center gap-4">
      <button id="enable-notifications" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
        Enable
      </button>
      <button id="dismiss-modal" class="text-gray-500 hover:text-gray-700">
        Not Now
      </button>
    </div>
  </div>
</div>
<div id="map-container" class="map-container">
<!-- Notification Modal -->
<div
  id="mapDisplayControls"
  class="absolute left-0 right-0 px-4 z-[999] flex justify-between items-end pointer-events-none bg-transparent"
>
  <!-- Bottom-left: Locate button -->
  <div class="pointer-events-auto">
    <button
      id="locateButton"
      class="p-4 rounded-full bg-gray-200 hover:bg-gray-300 text-xl shadow"
    >
      <i class="fas fa-location-arrow text-gray-700"></i>
    </button>
  </div>
  <div class="pointer-events-auto">


       <div  id="cancelControls" class="useCancelControls" >
         <button onclick="cancelPane.present({animate:true})" class="cancelControl" id="cancelBtn" > <i class="fas fa-ban"></i>
 <span id="minutes">15</span>:<span id="seconds">00</span>
           </button>    
       </div> 
  </div>
     
  <!-- Bottom-right: Search Controls column -->
  <div
    id="search-Controls"
    class="hidden flex flex-col gap-3 items-end pointer-events-auto"
  >
    <button
      id="manualLocation"
      class="p-4 rounded-lg bg-yellow-400 hover:bg-yellow-500 text-white text-xl shadow"
    >
      <i class="fa fa-hand-pointer"></i>
    </button>


    <button
      id="useMyLocationButton"
      class="p-4 rounded-lg bg-green-500 hover:bg-green-600 text-white text-xl shadow"
    >
      <i class="fas fa-location"></i>
    </button>

    <button
      id="searchLocation"
      onclick="myPane.moveToBreak('top')"
      class="p-4 rounded-lg bg-blue-500 hover:bg-blue-600 text-white text-xl shadow"
    >    
      <i class="fas fa-search"></i>
    </button>
     <button
      id="manualLocationOff"
      class="hidden inline-flex items-center gap-2 px-4 py-3 bg-yellow-100 text-yellow-800 text-base font-medium rounded-lg border border-yellow-300 hover:bg-yellow-200 transition"
    >
      <i class="fas fa-ban text-yellow-600"></i>
      Turn Off Manual Location
    </button>
    
  </div>
</div>	
<div id="sideNav" class="sidenav">
  <a href="javascript:void(0)" class="close-btn" onclick="closeNav()">&times;</a>
  <a href="#">
    <i class="fas fa-user"></i> +19193609602
  </a>
    <a href="#" onclick="logout()">
    <i class="fas fa-sign-out-alt"></i> Logout
  </a>
    <a href="#"  id="instructions2">
    <i class="fas fa-info-circle"></i> Help
  </a>
</div> 
	
<div id="centerDot">
<div  class="group relative cursor-pointer flex flex-col items-center text-blue-600">
  <!-- Fixed Icon + Arrow Block -->
  <div class="relative z-10 flex flex-col items-center">
    <!-- Icon -->
    <div style="margin-bottom:40px" class="w-12 h-12  rounded-full bg-blue-100 flex items-center justify-center shadow-md">
      <i class="fas fa-house text-blue-600 text-xl"></i>
    </div>

    <!-- Arrow (always fixed below icon) -->
    <div class="mb-0">
      <i class="fas fa-caret-down text-blue-600 text-lg"></i>
    </div>
  </div>

</div>
</div>
<!--
<div id="mapDisplayControls" class="fixed">
<button id="locateButton" class="circle-icon-button">
  <i class="fas fa-location-arrow"></i>
</button>	
    <div id="search-Controls" class="useSearchLocation">
	        <button id="manualLocation" class="useLocation">
            <i class="fa fa-hand-pointer"></i> 
        </button> 
<button
  id="manualLocationOff"
  class="hidden inline-flex items-center gap-2 px-4 py-2 bg-gray-100 text-gray-800 text-sm font-medium rounded-md border border-gray-300 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-400 transition-all duration-200 ease-in-out"
>
  <i class="fas fa-ban text-gray-600"></i>
  Turn Off Manual Location
</button>	
        <button id="useMyLocationButton" class="useLocation">
            <i class="fas fa-location"></i> 
        </button>
        <button onClick="myPane.moveToBreak('top');" class="searchLocation">
            <i class="fas fa-search"></i> 
        </button>
    </div>
       <div  id="cancelControls" class="useCancelControls" >
	 <button onclick="cancelPane.present({animate:true})" class="cancelControl" id="cancelBtn" > <i class="fas fa-ban"></i>
 <span id="minutes">15</span>:<span id="seconds">00</span>
           </button>    
       </div>	
</div> 
-->
    <!-- Statistics Overlay -->
    <div id="statistics-overlay" class="statistics-overlay">
        <div class="attribute" style="font-size:40px;">
            <i class="fa fa-calculator" aria-hidden="true"></i>
        </div>
        <div class="attribute">
            <span class="label">Distance</span>
            <span id="stat-distance" class="value"></span>
        </div>
        <div class="attribute">
            <span class="label">Add</span>
            <span id="stat-add" class="value"></span>
        </div>
        <div class="attribute">
            <span class="label">Total</span>
            <span id="stat-price" class="value"></span>
        </div>
    </div>

         

    <!-- Courier Count Notification -->
    <div id="courierCountContainer" class="courier-notification">
        <i class="fas fa-bicycle"></i> <!-- Courier icon -->
        <span style="background:black; color:white;" id="courierCount">0</span>
	<!--        <span id="pendingCourierCount">0</span> -->
    </div>

    <!-- Address Search -->
    <div id="findAddress" class="findAddress"></div>

    <!-- Navigation Button -->
    <button id="user-btn-id" class="open-btn" onclick="openNav();">
        <i class="fas fa-bars" aria-hidden="true"></i>
     </button>
    <div style="display:none;" class="flex-container33">
    </div>


    <!-- Map Container -->
    <div id="map"></div>
</div>        
<!-- MYPANE CONTENT -->
<!--
<div class="info-container" id="info">
        <div id="locationSearch" class="input-wrapper">
        <input type="text"  id="addressInput" placeholder="Enter Address" class="addressInput">
        <i id="search-icon" class="fas fa-search search-icon"></i>
         <button id="clearButton">×</button>
         <div id="suggestionsList" class="suggestions-box"></div>

 


      </div>    

<div id="mapTypeControl">
    <div class="control-group">
        <button id="mapBtn" class="control-button selected">Map</button>
        <button id="satelliteBtn" class="control-button">Satellite</button>
    </div> 
    <div class="control-group" id="terrainOption" style="display: none;">
        <input type="checkbox" id="terrainCheckbox">
        <label for="terrainCheckbox">Terrain</label>
    </div>    <div class="control-group" id="labelsOption" style="display: none;">
        <input type="checkbox" id="labelsCheckbox">
        <label for="labelsCheckbox">Labels</label>
    </div>
</div>


  <div class="pkdrContainer">
    <div class="connectorColumn">
      <div id="dropoffCircle" class="dropoff-circle"><i class="fa-solid fa-house"></i></div>
      <div class="vertical-line"></div>
      <div id="pickupCircle" class="pickup-circle"><i class="fa-solid fa-store"></i></div>
      <div class="vertical-line2"></div>
      <div
  id="courier-circle"
  class="fading-out relative inline-flex items-center justify-center w-10 h-10 rounded-full bg-black text-white shadow-md"
  style="margin-top: 0px;"
>
  <svg id="courier-spinner" class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
  </svg>

  <div
    id="pendingCourierCount"
    class="absolute top-0 left-0 transform -translate-x-1/2 -translate-y-1/2 bg-red-600 text-white text-xs font-bold px-2 py-0.5 rounded-full hidden"
  >
   0
  </div>
</div>
    </div>

    <div id="getStateLoaderContainer">
      <div id="getStateLoader" class="getStateLoader">
        <i class="fa-solid fa-spinner fa-spin" style="color:black; font-size:30px;"></i>
        <p id="getStateText" class="state-loading-text">Loading, please wait...</p>
      </div>
    </div>

    <div class="pkdrRows">
      <div id="dropContainer" class="row12">
        <div id="resize-trigger" class="clickDirectionText">
          <div class="pickup-header">
            <div class="pickup-left">
              <strong>Dropoff to</strong>
            </div>
	    <button
  onclick="openAddressPane();"
  id="changeAddress"
  class="inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-400"
>
  <i class="fas fa-exchange-alt text-white text-sm"></i>
  Change
</button>
<button
  onclick="openInstructionsPane();"
  id="changeInstructions"
  style="display: none;"
  class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400"
>
  <i class="fa-solid fas fa-clipboard text-white text-sm"></i>
  Your Instructions
</button>
          </div>
        </div>
        <div class="DDAddress">
<div id="addressOverlayAddress2LabelWrapper" class="flex items-center">		
          <div id="addressOverlayAddress2Label" style="font-weight:500;font-size:18px;"></div>
</div>
          <div id="addressOverlayAddress2"></div>
        </div>
      </div>

      <div id="bottomB" class="row12">
        <div id="resize-trigger" class="clickDirectionText">
          <div class="pickup-header">
            <div class="pickup-left">
              <strong>Pickup from</strong>
            </div>
	    <button
  id="chooseStoreButton"
  class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400"
>
  <i class="fas fa-plus text-white text-sm"></i>
  Add
</button>
          </div>
        </div>

        <div id="swiperPaginationStores" class="swiper-pagination-stores"></div>

        <div class="DDAddress" style="border-bottom: none;">
          <div id="selectedStoresContainerOverlay" class="selectedStoresContainerOverlay"></div>

          <div id="selectedStoresContainer" class="swiper-container">
            <div id="selectedStoresWrapper" class="swiper-wrapper">
            </div>
          </div>
        </div>

        <div class="selectedStoresNavigation">
          <div id="previous" class="swiper-button-prev">
            <i class="fas fa-chevron-left"></i>
          </div>
          <div class="slide-counter" id="slideCounter"></div>
          <div id="nextSlide" class="swiper-button-next">
            <i class="fas fa-chevron-right"></i>
          </div>
        </div>

        <span
          id="pickupOverlayAddress2"
          class="pickupOverlayAddress2"
          style="color: white; font-size: 18px;"
          tabindex="0">
        </span>
      </div>

      <div id="row12Courier" class="row12">
        <div id="pickupBy" class="clickDirectionText" style="display:none;">
          <strong>Courier Offers</strong>
	            <button  onclick="displayModal()" class="cancelControl" style="color:black; background:white;" id="pay-button" >Adjust Offer</button>
        </div>

        <div id="getStateLoaderContainerSwiper">
          <div id="getStateLoaderSwiper" class="getStateLoader">
            <i class="fa-solid fa-spinner fa-spin" style="color:black; font-size:30px;"></i>
            <p id="getStateTextSwiper" class="state-loading-text">Searching, please wait...</p>
          </div>
        </div>

        <div id="courierList" class="swiper courier-swiper">
          <div id="courier-wrapper" class="courier-wrapper swiper-wrapper">
           
          </div>
        </div>
              
	 <div style="width:58px" class="selectedStoresNavigation">
           <div id="courierPreviousSlide" class="swiper-button-prev">
              <i class="fas fa-chevron-left"></i>
            </div>
            <div class="slide-counter" id="courierPagination"></div>
            <div id="courierNextSlide" class="swiper-button-next">
              <i class="fas fa-chevron-right"></i>
            </div>
          </div>




      </div>
    </div> 
  </div> 

<div class="waitPay" id="waitPay" style="display: none;">
  <span id="minutes" style="display: none;">0</span>
  <span id="seconds" style="display: none;">0</span>
  <span id="hours" style="display: none;">0</span>
  <span id="days" style="display: none;">0</span>
</div>

</div> <!-- end .info-container -->
-->
<!-- END MYPANE CONTENT -->


<div id="labelLocationPane" class="label-modal-container">
  <div class="label-modal-header">
    <h3>Label This Location</h3>
  </div>

  <div class="label-modal-body">
    <input
      type="text"
      id="locationLabelInput"
      class="label-modal-input"
      placeholder="New Location"
      onkeydown="event.key === 'Enter' && event.preventDefault();"
    />
  </div>

  <div class="label-modal-footer">
	  <button class="label-modal-cancel" onclick="labelPane.destroy({animate:true})">Cancel</button>
    <button id="handleLabelSubmitButton" class="label-modal-confirm" onclick="handleLabelSubmit()">Continue</button>
  </div>
</div>






<div class="addressLookup">
	<!--
        <div id="locationSearch" class="input-wrapper">
        <input type="text"  id="addressInput" placeholder="Enter Address" class="addressInput">
        <i id="search-icon" class="fas fa-search search-icon"></i>
	 <button id="clearButton">×</button>
	 <div id="suggestionsList" class="suggestions-box"></div>

 


      </div> 	

<div id="mapTypeControl">
    <div class="control-group">
        <button id="mapBtn" class="control-button selected">Map</button>
        <button id="satelliteBtn" class="control-button">Satellite</button>
    </div> 
    <div class="control-group" id="terrainOption" style="display: none;">
        <input type="checkbox" id="terrainCheckbox">
        <label for="terrainCheckbox">Terrain</label>
    </div>    <div class="control-group" id="labelsOption" style="display: none;">
        <input type="checkbox" id="labelsCheckbox">
        <label for="labelsCheckbox">Labels</label>
    </div>
</div>
	-->
<!-- Instructional Section -->
<div id="locationInstructionsWrapper" class="location-instructions-wrapper">
  <div class="location-heading">Choose Dropoff Location</div>

  <ul class="location-option-list">
    <li>
      <i class="fa-solid fa-hand-pointer option-icon"></i>
      <span class="option-strong">Manual Select</span> Center Map Loaction
    </li>
    <li>
      <i class="fa-solid fa-location-crosshairs option-icon"></i>
      <span class="option-strong">Current Location</span> Use GPS location
    </li>
    <li>
      <i class="fa-solid fa-magnifying-glass option-icon"></i>
      <span class="option-strong">Search</span> Lookup Address
    </li>
  </ul>

  <p class="location-note">
    After confirming, you'll be able to add a custom label for this location.
  </p>
</div>
<!-- Dynamic Address Display Block -->
<div class="location-summary-wrapper">
  <div class="location-summary-container">
	  <div class="dropoff-circle">
    <i class="fa-solid fa-house location-icon"></i>
    </div>
    <div>
    <div id="addressOverlayAddress2Label2"style= "font-weight:600;font-size:17px;"></div>
    <div id="addressOverlayAddress3" class="location-address-text">
      <!-- Address content is injected here -->
    </div>
  </div>
  </div>
</div>


</div>

</div>
<!--
<div class="cancel-pane">
    <button id="deletePost"class="cancel-option">Remove Post</button>
    <button id="cancelAction"class="cancel-close">Go Back</button>
</div>
-->
<div class="cancel-pane bg-white p-6 rounded-xl shadow-lg max-w-sm mx-auto">
  <div class="flex flex-col items-center text-center space-y-6">
    <!-- Instructional Message -->
    <div>
      <h2 class="text-lg font-semibold text-gray-800">Cancel Delivery</h2>
      <p class="text-sm text-gray-600 mt-2">
        Are you sure you want to remove this delivery listing?
      </p>
    </div>

    <!-- Action Buttons -->
    <div class="w-full space-y-3">
      <button
        id="deletePost"
        class="cancel-option w-full px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-medium"
      >
        Remove Post
      </button>
      <button
        id="cancelAction"
        class="cancel-close w-full px-4 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition font-medium"
      >
        Go Back
      </button>
    </div>
  </div>
</div>
  <script>
let initialCoordinates; 
document.getElementById("deletePost").addEventListener("click", () => {
    console.log("Post deleted.");
    CancelDelivery(phone_number); 
});

document.getElementById("cancelAction").addEventListener("click", () => {
    cancelPane.destroy();
});


function simulateMapClick(lat, lng) {
    const geoJsonBounds = new google.maps.LatLngBounds();

    map.data.forEach(function(feature) {
        feature.getGeometry().forEachLatLng(function(latLng) {
            geoJsonBounds.extend(latLng);
        });
    });

    const location = new google.maps.LatLng(lat, lng);

    if (geoJsonBounds && geoJsonBounds.contains(location)) {
	myPane.moveToBreak('middle');
        // Simulate map click event
        google.maps.event.trigger(map.data, 'click', {
            latLng: location
        });
    } else {
        alert("The location is not within the designated delivery area.");
    }
}

document.getElementById('useMyLocationButton').addEventListener('click', function () {
  const button = this;
  const originalText = button.innerHTML;

  // Show loading spinner
button.innerHTML = '<i class="fa-solid fa-spinner fa-spin text-blue-500 text-sm"></i>';
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      function (position) {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        console.log({ lat, lng });

        const myLatLng = { lat, lng };

        // Move map and update marker
        map.panTo(myLatLng);
        initialMarker.position = myLatLng; // ✅ Keep this as-is

        // Reverse geocode to get address
        getClosestAddress(lat, lng, (address) => {
          if (address) {
            const streetName = extractStreetName(address);
            document.getElementById("addressOverlayAddress2").innerHTML = streetName;
            document.getElementById("addressOverlayAddress3").innerHTML = streetName;
            document.getElementById("addressOverlayAddress4").innerHTML = streetName;
       //     document.getElementById("storeDropoff").innerHTML = streetName;
          }
        });

        // Restore button text
        button.innerHTML = originalText;
      },
      function (error) {
        alert('Error occurred while retrieving location: ' + error.message);
        button.innerHTML = originalText;
      }
    );
  } else {
    alert('Geolocation is not supported by this browser.');
    button.innerHTML = originalText;
  }
});



function addPickupLocations() {
//document.getElementById("doneChooseStoreButton").classList.remove("hidden");
document.getElementById("chooseStoreButton").classList.add("hidden");
document.getElementById("confirmPickups").style.display ="block";  
document.getElementById("submitStores").style.display = "none"; 

showPickupOnly(); 
updateUncheckedStoreMarkers();

document.querySelectorAll('.checkbox-container input[type="checkbox"]').forEach(cb => {
  cb.removeEventListener('change', handleCheckboxChange); // Just in case
  cb.addEventListener('change', handleCheckboxChange);
});    
    allowMarkerUpdate = false; 
    
    const sendStores = document.getElementById('submitStores');
    const storeFormCheckboxes = $('#storeForm input[type="checkbox"]');            
    sendStores.removeEventListener('click', handleStoreSubmitWrapper);
    sendStores.addEventListener('click', handleStoreSubmitWrapper);
}






function handleSelectedAddress(selectedAddress) {
    fetch("/static/location_filtered.geojson")
        .then(response => response.json())
        .then(geojson => {
            const matchedFeature = geojson.features.find(feature => feature.properties.Add_St === selectedAddress);

            if (matchedFeature) {
                const [lng, lat] = matchedFeature.geometry.coordinates;
                console.log(lat, lng); 
                // Simulate map click like Google Autocomplete
            myLatLng = { lat: lat, lng: lng }; // Correctly store new coordinates
            map.panTo(myLatLng); // Move map to new location
            initialMarker.position = myLatLng; // Update marker position        

            getClosestAddress(lat, lng, (address) => {
                if (address) {
                    streetName = extractStreetName(address);
                    document.getElementById("addressOverlayAddress2").innerHTML = streetName;
                    document.getElementById("addressOverlayAddress3").innerHTML = streetName;
		    document.getElementById("addressOverlayAddress3").innerHTML = streetName;
		   document.getElementById("addressOverlayAddress4").innerHTML = streetName;	
		 //   document.getElementById("storeDropoff").innerHTML = streetName; 	
                }
            });
setTimeout(() => {
  addressPane.moveToBreak('bottom');
}, 150); // Delay in milliseconds (adjust as needed)		    
            } else {
                console.error("Address not found in GeoJSON:", selectedAddress);
            }
        });
}
async function loadAddressData() {
    try {
        const response = await fetch("/static/location_filtered.geojson");
        const geojson = await response.json();

        // Ensure the variable is correctly assigned
        window.filteredAddresses = geojson.features.map(feature => feature.properties.Add_St);
        console.log("Loaded Addresses:", window.filteredAddresses); // Debugging line
    } catch (error) {
        console.error("Error loading local address data:", error);
    }
}
document.getElementById('addressInput').addEventListener('input', async function(event) {
    const query = event.target.value.toLowerCase();
    const suggestionsBox = document.getElementById("suggestionsList");

    if (!query) {
        suggestionsBox.innerHTML = ""; // Clear if input is empty
        return;
    }

    // Ensure address data is available
    if (!window.filteredAddresses || window.filteredAddresses.length === 0) {
        await loadAddressData(); // Load addresses if not already set
    }

    console.log("Filtered Addresses Before Filtering:", window.filteredAddresses);

    // Check for invalid addresses
    window.filteredAddresses.forEach((address, index) => {
        console.log(`Index ${index}:`, address);
    });

    // Filter suggestions safely
    const suggestions = window.filteredAddresses
        .filter(address => typeof address === "string") // Ensure valid strings
        .filter(address => address.toLowerCase().includes(query));

    console.log("Filtered Suggestions:", suggestions);
	showSuggestions(suggestions); 
});
function showSuggestions(suggestions) {
    const suggestionsBox = document.getElementById("suggestionsList");
    suggestionsBox.innerHTML = ""; // Clear previous suggestions

    suggestions.forEach(address => {
        const item = document.createElement("div");
        item.textContent = address;
        item.classList.add("suggestion-item");
        item.addEventListener("click", function() {
            document.getElementById("addressInput").value = address;
            suggestionsBox.innerHTML = ""; // Hide suggestions

            // Get coordinates of the selected address
            handleSelectedAddress(address);
        });

        suggestionsBox.appendChild(item);
    });
}
// Clear input when button is clicked
document.getElementById('clearButton').addEventListener('click', function() {
    document.getElementById('addressInput').value = '';
    document.getElementById('suggestionsList').innerHTML = ''; // Hide suggestions
    this.style.display = 'none';
});

  </script>
<style>
.footer {
    display:none; 
    z-index: 99;
    height: 95px;
    bottom: 0;
    position: absolute;
    background: white;
    width: 100%;
    justify-content: center; 
    align-items: center;
    box-shadow: 0 -5px 10px rgba(0, 0, 0, 0.07);
    left: 50%;
    transform: translateX(-50%);

}
.box{
    padding-top:10px;
    padding-bottom:15px; 
    margin:6px;
//    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 -4px 6px rgba(0, 0, 0, 0.1);
//  margin-top:30px; 
}
.tracking-labels{
margin-bottom: 8px;
    font-size: 18px;
    font-weight:900;
    display;flex;
    justify-content:space-between;
}
.paySelectCourier{
    padding: 14px;
    background: #d73c3c;
    color: white;
    border: 0px solid;
    font-size: 18px;
    display: none;
    max-width: 350px;
    width: 100%;
    border-radius: 28px;	
}
.inactiveButton{
    padding: 14px;
    background: #ddd;
    color: #777;
    border: 0px solid #bbb;
    font-size: 18px;
    display: none;
    max-width: 350px;
    width: 60%;
    border-radius: 10px;

}


.selectPayCourier{
    background-color: rgb(45, 45, 45);
    color: white;
    border: none;
    padding: 12px 20px;
    font-size: 20px;
    font-weight: 600;
    border-radius: 8px;
    display: block;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    box-shadow: rgba(0, 0, 0, 0.15) 0px 4px 12px;
    margin-right:30px; 
}

.progress-fill{
    width: 0%;
    height: 9px;
    background: black;
    border-radius: 20px;
    position: fixed;
    transition: width 0.4s ease-in-out;
}
.delivery-done-button{
    color: white !important;
    font-size: 16px;
    text-shadow: 0px 0px 0px #000000;
    padding: 16px 36px;
    border-radius: 10px;
    border: none;
    background: #333333;
    white-space: normal;
    transition: color 0.3s ease, background 0.3s ease;
    width: 150px;
}
.tracker-header{
	font-size:22px;
	color:black;
	font-weight:700; 
}

.tracker-subtext{
	font-size:16px;
	color:#ddd';
	font-weight:500;
}
.tracker-container{
	display:flex;
	flex-direction:column;
	margin:20px 25px 25px 20px;
}

.highlighted-marker.courier-present::before {
  content: '';
  position: absolute;
  top: -6px;
  left: -6px;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: rgba(0, 123, 255, 0.3);
  animation: pulseGlow 1.5s infinite;
  z-index: 0;
}
.home-marker.courier-present::before {
  content: '';
  position: absolute;
  top: -6px;
  left: -6px;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: rgba(0, 0, 0, 0.5);
  animation: pulseGlow 1.5s infinite;
  z-index: 0;
}
 .courier-overlay-icon {
  display: none;
}

.courier-present .courier-overlay-icon {
  display: block;
} 

@keyframes pulseGlow {
  0% { transform: scale(1); opacity: 0.6; }
  50% { transform: scale(1.2); opacity: 0.3; }
  100% { transform: scale(1); opacity: 0.6; }
}

.highlighted-marker {
  position: relative; 
  display: flex;
  flex-direction: column;
  align-items: center;
  font-size: 12px;
  color: #2563eb; /* Tailwind blue-600 */
}

.highlighted-icon {
  position: relative;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: white;
  box-shadow: 0 0 8px 2px #4f46e5;
  padding: 2px;
  box-sizing: border-box;
}

.highlighted-logo {
  width: 100%;
  height: 100%;
  object-fit: contain;
  border-radius: 50%;
  border: 2px solid #4f46e5;
}

.arrow-down1{
  position: absolute;
  bottom: -10px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 10px;
  color: #4f46e5;
}

.highlighted-label {
  margin-top: 6px;
  font-weight: bold;
  color: #333;
  background: rgba(255, 255, 255, 0.85);
  padding: 2px 6px;
  border-radius: 4px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
}
.unhighlighted-marker {
  display: flex;
  flex-direction: column;
  align-items: center;
  color: #6b7280; /* Tailwind gray-500 */
  font-size: 12px;
}

.unhighlighted-icon {
  position: relative;
  width: 32px;
  height: 32px;
}

.unhighlighted-logo {
  width: 100%;
  height: 100%;
  object-fit: contain;
  border-radius: 50%;
  border: 1px solid #d1d5db; /* Tailwind gray-300 */
}

.arrow-down {
  position: absolute;
  bottom: -10px;
  left: 50%;
  transform: translateX(-50%);
  color: #9ca3af; /* Tailwind gray-400 */
  font-size: 10px;
}

.unhighlighted-label {
  margin-top: 6px;
  font-weight: normal;
  color: #6b7280;
}
@keyframes drop-in {
  from {
    transform: translateY(-20px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}
</style>
<div id="submitFooter" class="footer">


<button id="selectPayCourier" class="inactiveButton">
  <i class="fas fa-credit-card"></i>
  Pay Offer
</button>
	
<!--   <button class="inactiveButton" id="selectPayCourier">$0.00</button> -->

    <!-- From Uiverse.io by Peary74 -->
    <button
  id="submitAddress"
  class="hidden w-full max-w-[90%] mx-auto bg-indigo-600 text-white text-base font-semibold rounded-lg h-14 flex items-center justify-center"
>
 Done Selecting Dropoff
</button>
    <button
  id="confirmPickups"
  onClick="dismiss3()"
  class="hidden w-full max-w-[90%] mx-auto bg-yellow-500 text-white text-base font-semibold rounded-lg h-14 flex items-center justify-center"
>
  Done Selecting Pickups
</button>	    
    <button style="display: none;" class="custom-button" id="backToMerchant">Back</button>
    <button style="display: none;" class="custom-button" id="sendDeliveryAndInstructions">Submit</button>

    <button class="inactiveButton" id="submitStores">No Pick-ups Selected</button>

    <a id="payCall" href="" class="pending-courier-icon">
        <i class="fa-solid fa-phone"></i>
    </a>

    <a id="payText" href="" class="pending-courier-icon">
        <i class="fa-solid fa-comment-dots"></i>
    </a>
    <a id="payLocate" class="pending-courier-icon" onClick="">
       <i class="fa-solid fa-map-marker-alt"></i> 
     </a>
</div>


<div id="info-bar" class="info-bar">
    <div id="card">
        
        <!-- Tracker Button -->
<!--	
        <div class="tracker-container" id="tracker-button-container" style="display: flex; top: 10%;">
            <div class="tracker-header" id="tracker-button">Submit Order</div>
	    <div class="tracker-subtext" id="tracker-subtext">Click the Order Info Button for each pickup location and follow instructions</div>
        </div>

        <div class="tracking" style="display: none;">
            <div class="title">Tracking Order</div>
        </div>
	-->
        <!-- Progress Bar -->

        <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; display:flex; justify-content: center; width: 100%; height: 110px">
            <div class="progress-track">
                <ul id="progressbar">
                    <div id="progressFill" class="progress-fill" style="width: 95px"></div>
		
                    <li class="step0 text-left active" id="step1">
                        <div id="step1-text" class="step1-text">Payment</div>
                        <i class="fa fa-circle fastack1"></i>
                    </li>
                    <li class="step0 text-center" id="step2">
                        <div style="width:92px;"id="step2-text" class="step2-text">
                            Submit Orders <span id="submit-counter" class="counter-text"></span>  

			</div>
                        <i class="fa fa-circle fastack2"></i>
                    </li>
                    <li class="step0 text-center" id="step3">
                        <div id="step3-text" class="step3-text">
                            Picked-up <span id="pickup-counter" class="counter-text"></span>
			</div>
                        <i class="fa fa-circle fastack3"></i>
                    </li>
                    <li class="step0 text-right" id="step4">
                        <div id="step4-text" class="step4-text">Delivered</div>
                        <i class="fa fa-circle fastack4"></i>
                    </li>
                </ul>
            </div>
        </div>
    </div>
   
    <!-- Pick-up Section -->
    <div class="section box">
        <div class="tracking-labels">
            <i class="fa-solid fa-bicycle"></i> Pick-up by
        </div>
        <div style="display: flex; flex-direction: column; width: 100%;">
            <div class="courier-content">
                <div class="courier-contact-container">
                    <div class="courier-id" id="courier-id">
                        <div class="courier-name">James M</div>
                    </div>
                </div>
                <div id="courierProgress">
                    <a id="phoneLink" href="tel:+15551234567" class="contact-button">
                        <i class="fa-solid fa-phone"></i> Call
                    </a>
                    <a id="textLink" href="sms:+15551234567" class="contact-button">
                        <i class="fa-solid fa-message"></i> Message
                    </a>
                    <button id="mapCenterCourier" class="contact-button">
                        <i class="fa-solid fa-crosshairs"></i> Find
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Store Pick-up -->
    <div class="section box">
  <div class="tracking-labels">
    <i class="fas fa-store"></i> Pick-up from
  </div>

  <div id="selectedStoresContainerTracker" class="tracker-swiper-container">
    <div id="selectedStoresWrapperTracker" class="swiper-wrapper">
      <!-- Slides injected dynamically -->
    </div>
  </div>

  <div class="selectedStoresNavigation">
    <div id="previousTracker" class="swiper-button-prev">
      <i class="fas fa-chevron-left"></i>
    </div>
    <div class="slide-counter" id="slideCounterTracker"></div>
    <div id="nextSlideTracker" class="swiper-button-next">
      <i class="fas fa-chevron-right"></i>
    </div>
  </div>

  <div class="swiper-pagination-stores-tracker"></div>
</div>
    <!-- Drop-off Section -->
    <div class="section box">
        <div style="display:flex;"class="tracking-labels">
		<div><i class="fas fa-home"></i> Dropoff to</div>
		<div>                   
		<button onclick="openInstructionsPane();"
                 id="changeInstructions2"
                 style="display: inline-flex;"
                 class="inline-flex items-center gap-2 px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700 focus:outline-none                   focus:ring-2 focus:ring-green-400"
                  >
                 <i class="fa-solid fas fa-clipboard text-white text-sm"></i>
                 Delivery Info
               </button>
		</div>
        </div>
        <div style="display: flex; flex-direction: column; width: 100%;">
            <div class="courier-content">
                <div id="addressProgress" style="text-decoration: none;">
                    140 West Franklin St apt 316
                </div>
            </div>
        </div>
    </div>

    <!-- New Delivery Section -->
    <div class="section new-delivery-container" style="display:flex;align-items:center;border: none;">
        <button style="display: none;" class="delivery-done-button" id="newDelivery">Done</button>
    </div>
</div>




	<div class="instructions-overlay-container">

         
	 <div class="delivery-service-instructions">
     <button type="button" class="custom-button" onclick="closeOverlay();">Close</button>
  <h1>Downtown Delivery Service</h1>
  <p>No fees</p>
  <p>No tipping</p>

  <ol>
    <li>
      <strong>Choose your drop-off:</strong>
      <p>You can only choose within the designated area.</p>
    </li>
    <li>
      <strong>Choose a desired merchant to order Online Pick-up:</strong>
      <p>Merchant table is sortable by price and Merchant name by clicking on the table header.</p>
      <p>Choose as many merchants as you want.</p>
      <p>The total price is the base price + $2.50 per mile on the most optimized route starting from the first pick-up location.</p>
      <p>Please leave delivery instructions.</p>
    </li>
    <li>
      <strong>Wait for a courier to be assigned:</strong>
      <p>You will receive a text message if or when a courier accepts your delivery request.</p>
      <p>After 15 minutes, the delivery will expire if not assigned.</p>
    </li>
    <li>
      <strong>Make Secure Stripe Payment:</strong>
      <p>Make a secure payment to proceed or cancel delivery.</p>
      <p>You can cancel the delivery or make the payment ($2.00 cancellation fee after payment).</p>
    </li>
    <li>
      <strong>Place your Online Order and upload Order Screenshot:</strong>
      <p>After placing your Online Pick-up Order(s), upload the Order Screenshot or message the courier directly.</p>
      <p>Delivery updates are available in the app.</p>
      <p>Upon delivery, you will receive a receipt via text.</p>
    </li>
  </ol>
</div>




       </div>
       <!--       <div id="tracker-button-container"> <button type="button" id="tracker-button">Upload Order Screenshots</button></div> -->

    <script>
     
let wasFooterVisible = false;
function openNav(){
	sideNavPane.present({animate:true});
}
function closeNav() {
    // Hide the nav and restore footer visibility if it was previously visible
	sideNavPane.destroy({animate:true}); 

}
		function submitAndShowStores(state){
	    var infoContainer2 = document.getElementById('info-container2'); 		
//	infoContainer2.innerHTML = SubmitStoreDynamicContent; 
//      document.getElementById("submitStores").style.display="block"; 
        map.setMapTypeId(google.maps.MapTypeId.ROADMAP);    
        map.setOptions({
        disableDefaultUI: true	
	}); 

		}


function detectDevice() {
    const userAgent = navigator.userAgent || navigator.vendor || window.opera;

    if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
        return "iOS";
    }

    if (/android/i.test(userAgent)) {
        return "Android";
    }

    if (/windows/i.test(userAgent)) {
        return "Windows";
    }

    if (/macintosh|mac os x/i.test(userAgent)) {
        return "Mac";
    }

    return "Unknown";
}

const device = detectDevice();

const trackerButton = document.getElementById('tracker-button');
const trackerButtonContainer = document.getElementById('tracker-button-container');
const infoBar = document.getElementById('info-bar');
const uploadImageOverlay = document.getElementById('order-upload-overlay'); 
// Event listener for when the animation completes
trackerButton.addEventListener('click', (event) => {
trackerButtonContainer.addEventListener('transitionend', () => {
  // Show the info bar
//  infoBar.style.top = '10%';
 
}, { once: true });

  // Prevent the event from propagating to the document
  event.stopPropagation();

  // Toggle the position of the trackerButtonContainer
  if (trackerButtonContainer.style.top === '-10%') {
    trackerButtonContainer.style.top = '10%';
  } else {
    trackerButtonContainer.style.top = '-10%';
  }
});

// Event listener for clicks outside the info bar
const orderImg = document.getElementById("order-upload-overlay"); 
document.addEventListener('click', (event) => {
      if (!infoBar.contains(event.target) && !orderImg.contains(event.target)) {
    // Hide the info bar and transition to -60%
    //infoBar.style.top = '-100%';
    // Reset the button container position
    trackerButtonContainer.style.top = '10%';
 //   uploadImageOverlay.style='-100%'; 
    
  }
});

const overlayButton = document.getElementById('instructions2');
const instructionsOverlayContainer = document.querySelector('.instructions-overlay-container');

overlayButton.addEventListener('click', () => {
  instructionsOverlayContainer.style.right = '0'; // Show the overlay
});
function closeOverlay() {
     instructionsOverlayContainer.style.right = '-100%';
    // You can add other logic here if needed
}

document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
        setTimeout(() => { 
            const overlayElement = document.getElementsByClassName("overlay-container")[0];
            overlayElement.style.display = 'flex'; 
            const mapElement = document.getElementById("map");
            //const headerElement = document.getElementById("menu");
            const overlayImg = document.getElementById("loading-text");
            if (window.innerWidth > window.innerHeight) {
                // Landscape orientation
                overlayImg.innerHTML='Re-orient to Portrait';
                mapElement.style.display = "none"; // Set desired height
              //  headerElement.style.display = "none"; // Set desired width
               overlayElement.style.display = "flex";
            } else {
                // Portrait orientation
//                overlayImg.src = "/static/spinner.gif"; 
                mapElement.style.display = "block"; // Set desired height
         //       headerElement.style.display = "flex"; // Set desired width
               overlayElement.style.display = "none";
            }
        }, 500); // Delay of 1000 milliseconds (1 second)
    }
});



function orientationLoader() {
    if (navigator.userAgent.match(/(iPhone|iPod|iPad)/i)) {
        $(document).ready(function () {
            function reorient() {
                const overlayElement = document.getElementsByClassName("overlay-container")[0];
                overlayElement.style.display = 'flex';

                const mapElement = document.getElementById("map");
                const overlayImg = document.getElementById("loading-text");

                if (window.innerWidth > window.innerHeight) {
                    overlayImg.innerHTML = "Re-orient to Portrait";
                    mapElement.style.display = "none";
                    overlayElement.style.display = "flex";
                } else {
                    mapElement.style.display = "block";
                    overlayElement.style.display = "none";
                }
            }

            window.onorientationchange = reorient;
            window.setTimeout(reorient, 0);
        });
    }
}



function footerNoPane() {
    const splashScreen = document.querySelector('.overlay-container');
    const overlay = document.querySelector('.overlay');

    setTimeout(() => {
        if (smsSequence === 'CHOOSE_STORE') {
            refreshDeliveryUI();
            dynamicPricing(); 
            myPane.present({ animate: true });
            updateMapHeight(myPane);
            updateMapWidth(myPane);
            document.getElementById('swiperPaginationStores').innerHTML=`<p class="text-gray-500 flex items-center gap-2">
  <i class="fas fa-exclamation-triangle text-xl"></i>
  No stores selected          </p>` 
            setTimeout(() => {
	        document.getElementById('submitStores').style.display = 'block';	    
                document.getElementById('submitFooter').style.display = 'flex';
            }, 500);          
        }
        if (smsSequence === 'STORE_CHOSEN') {
            myPane.present({ animate: true });
            updateMapHeight(myPane);
            updateMapWidth(myPane);
                waitPage(infoWindow);
        }
        if (smsSequence === 'SEND_SCREENSHOT') {
           myPane.present({ animate: true });
            updateMapHeight(myPane);
            updateMapWidth(myPane);
		document.getElementById("submitFooter").style.display ="none"; 
		waitPage(infoWindow);

        }

window.addEventListener('resize', () => {
  setTimeout(() => {
    if (
      myPane &&
      myPane.isPanePresented() &&
      myPaneBreaks &&
      myPaneBreaks.top
    ) {
      myPaneBreaks.top.height = window.innerHeight;
      myPane.setBreakpoints(myPaneBreaks);

      const current = myPane.currentBreak;
      if (current && myPaneBreaks[current]?.enabled) {
        myPane.moveToBreak(current);
      }
    }
  }, 300);
});
window.addEventListener('resize', () => {
    setTimeout(() => {
        [ paneModal, orderPane, merchantPane].forEach(pane => {
            if (pane && pane.settings && pane.settings.breaks) {
                pane.setBreakpoints({
                    top: { enabled: true, height: window.innerHeight }, // ✅ Other panes adjust dynamically
                    middle: pane.settings.breaks.middle, 
                    bottom: pane.settings.breaks.bottom 
                });
                     const current = myPane.currentBreak;
      //          pane.moveToBreak(current); // Ensure the pane moves to updated height
            }
        });
  }, 500); 
 // ✅ Reduced delay for snappier updates
});	    
        window.addEventListener('resize', () => {
            setTimeout(() => {
                if (smsSequence === 'STORE_CHOSEN') {
                    updateMapHeight(myPane);
                }

                if (smsSequence === 'CHOOSE_STORE') {
                    updateMapHeight(myPane);
                }

                if (smsSequence === 'SEND_SCREENSHOT') {
                    updateMapHeight(myPane);
                }
            }, 500);
        });

        splashScreen.style.display = 'none';
        orientationLoader();
    }, 1000);
}















let smsSequence = '';

function getUserState(infoWindow, initialMarker, retries = 10) {
console.trace("getUserState was called");	
    return new Promise((resolve, reject) => {
        $.ajax({
            url: `/user_state/`,
            type: 'POST',
            data: { phone_number: phone_number },
            success: function (response) {
                document.querySelector('.pkdrRows').style.display = 'flex';
                document.getElementById('getStateLoaderContainer').style.display = 'none';

                smsSequence = response.sms_sequence;

                switch (smsSequence) {
                    case 'CHOOSE_STORE':
                        resolve();
                        break;

                    case 'STORE_CHOSEN':
                        resolve();
                        break;

                    case 'PAYMENT_LINK_SENT':
                        resolve();
                        break;

                    case 'SEND_SCREENSHOT':
		        resolve(); 		
                        break;

                    case 'PAYMENT_CANCELLED':
                        window.location.href = `/cancelled/${phone_number}`;
                        resolve();
                        break;

                    default:
                        if (smsSequence.startsWith('sequence')) {
                            window.location.href = `/${smsSequence}-url`;
                            resolve();
                        } else {
                            reject(new Error(`Unknown sms_sequence: ${smsSequence}`));
                        }
                }
            },

            error: function (error) {
                if (retries > 0) {
                    setTimeout(() => {
                        getUserState(infoWindow, initialMarker, retries - 1)
                            .then(resolve)
                            .catch(reject);
                    }, 5000);
                } else {
                    reject(error);
                    window.location.href = `/app/map/${phone_number}/`;
                }
            }
        });
    });
}







let initialMarker; 
let infoWindow;
let initialButton;
//let initialButtonListener;






function sortMerchant(){
	document.getElementById('sortMerchant').click();
	document.getElementById('sortPrice').click(); 
}






function openInExternalBrowser(url) {
    if (url.includes('appRemove')) {
        // Remove 'appRemove' from the URL
        url = url.replace('appRemove', '');
    // Attempt to open the app using window.location
    window.location = url;

    // Use a timeout to redirect to the app store if the app is not installed
    setTimeout(function() {
        // Check if the app was opened by checking the visibility state
        if (document.visibilityState === 'visible') {
            window.location.href = appStoreUrl;
        }
    }, 1500); // Adjust the timeout as needed
	}
	else {copyToClipboard(url);}
}



function getStoreLink(linkType, appleLink, androidLink, defaultLink) {
    var device = detectDevice();
    
    if (linkType === 'app') {
        if (device === 'iOS') {
            return appleLink+'appRemove';
        } else if (device === 'Android') {
            return androidLink+'appRemove';
        }
    }
    return defaultLink;
  
}
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        console.log('Copied to clipboard successfully!');
        alert('Merchant url copied to clipboard, view menu outside of App'); 
    }, function(err) {
        console.error('Could not copy text: ', err);

    });
}

let map;
let geoJsonBounds;
function changeHomeAddressDatabase(user, initialCoordinates, callback) {
  $.ajax({
    url: '/user_address/',
    type: 'POST',
    data: {
      user: phone_number,
      coordinates: initialCoordinates,
      label: destination_label
    },
    success: function (response) {
      console.log('Data sent successfully:', response);



      document.getElementById("addressOverlayAddress2Label2").textContent = destination_label;

      // Update label + edit button
      const wrapper = document.getElementById('addressOverlayAddress2LabelWrapper');
      wrapper.innerHTML = `
        <div id="addressOverlayAddress2Label" class="font-medium text-lg text-gray-800">
          ${destination_label}
        </div>
        <button
          type="button"
          onclick="labelPane.present({ animate: true })"
          class="ml-2 text-gray-500 hover:text-blue-600 focus:outline-none"
          aria-label="Edit label"
        >
          <i class="fas fa-pencil-alt text-sm"></i>
        </button>
      `;
      
      // Update breakpoints and move to middle
      if (typeof callback === 'function') {
        callback(); // ✅ Trigger follow-up logic
      }

	    
    },
    error: function (error) {
      console.error('Error sending data:', error);
    }
  });
}	
function updateInstructions(user) {
  const dropoffOptionInput = document.querySelector('input[name="dropoffMethod"]:checked');
  const accessInput = document.getElementById("accessCode");
  const aptInput = document.getElementById("apartmentNumber");
  const timeInput = document.getElementById("deliveryTime");
  const notesInput = document.getElementById("deliveryInstructions");
  const submitButton = document.querySelector(".submitNewInstructionsButton");

  const dropoffOption = dropoffOptionInput ? dropoffOptionInput.value : "Unspecified";
  const accessInstructions = accessInput ? accessInput.value.trim() : "";
  const apartmentNumber = aptInput ? aptInput.value.trim() : "";
  const deliveryTimePreference = timeInput ? timeInput.value : "";
  const notes = notesInput ? notesInput.value.trim() : "";

  const contactlessTag = dropoffOption === "Leave at Door"
    ? "Contactless Delivery"
    : "Meet Customer at Dropoff";

  const summaryDisplay = `
    <strong>${contactlessTag}</strong><br>
    Drop-Off: ${dropoffOption}<br>
    Apt: ${apartmentNumber || 'N/A'}<br>
    Access: ${accessInstructions || 'N/A'}<br>
    Time: ${deliveryTimePreference}<br>
    Notes: ${notes || 'None'}
  `;

  const originalButtonHTML = submitButton.innerHTML;

  // 🔒 Lock UI and show spinner
  document.body.classList.add('touch-lock');
  submitButton.disabled = true;
  submitButton.innerHTML = `
    <span class="button-loader">
      <i class="fas fa-spinner fa-spin"></i> Saving...
    </span>
  `;

  $.ajax({
    url: "/user_instructions/",
    type: "POST",
    contentType: "application/json",
    data: JSON.stringify({
      user: user,
      access_instructions: accessInstructions,
      apartment_number: apartmentNumber,
      dropoff_option: dropoffOption,
      delivery_time_preference: deliveryTimePreference,
      instructions: notes
    }),
    success: function (response) {
      console.log("Data sent successfully:", response);

      setTimeout(() => {
        document.body.classList.remove('touch-lock');
        submitButton.innerHTML = originalButtonHTML;
        submitButton.disabled = false;
        instructionsPane.destroy({animate:true}); 
      }, 1000); // slight delay just for UX smoothness
    },
    error: function (error) {
      console.error("Error sending data:", error);
      submitButton.innerHTML = originalButtonHTML;
      submitButton.disabled = false;
      document.body.classList.remove('touch-lock');
      alert("Something went wrong. Please try again.");
    }
  });
}


function clearGeoJsonBounds(map) {
    map.data.forEach(function(feature) {
        map.data.remove(feature);
    });
}










let InitialCoordinates;

function changeHomeLocation() {
    document.querySelector('.footer').style.display = "flex";
    const submitHomeAddressButton = document.getElementById("submitAddress");
   // submitHomeAddressButton.style.display = "inline";
//	submitHomeAddressButton.style.display = "inline-block";
      submitHomeAddressButton.classList.remove("hidden");
    // ✅ Remove previous event listener before adding a new one
    submitHomeAddressButton.removeEventListener("click", handleSubmitClick);
    submitHomeAddressButton.addEventListener("click", handleSubmitClick);

    // ✅ Load GeoJSON when `changeHomeLocation()` runs
    map.data.loadGeoJson('/static/map.geojson');

map.data.setStyle({
  fillColor: '#007bff',       // subtle fill color
  fillOpacity: 0.1,           // low opacity to keep map readable
  strokeColor: '#007bff',     // clearly outlined border
  strokeOpacity: 0.8,         // high opacity to emphasize the edge
  strokeWeight: 2,            // thin but visible border
  zIndex: 5                   // layer above the base map, below markers
});
/*
    const geoJsonListener = map.data.addListener('click', (event) => {
        allowMarkerUpdate = true;

        if (allowMarkerUpdate) {
	    const latitude = event.latLng.lat();
            const longitude = event.latLng.lng();
            myLatLng = { lat: latitude, lng: longitude }; // Correctly store new coordinates
            map.panTo(myLatLng); // Move map to new location
            initialMarker.position = myLatLng; // Update marker position	

            getClosestAddress(latitude, longitude, (address) => {
                if (address) {
                    streetName = extractStreetName(address);
                    document.getElementById("addressOverlayAddress2").innerHTML = streetName;
                    document.getElementById("addressOverlayAddress3").innerHTML = streetName;
		    document.getElementById("addressOverlayAddress4").innerHTML = streetName;	
                }
            });
        }
    });
*/	
}
let idleListener = null;
let dragStartListener = null;
let dragEndListener = null;

function enableCenterDotTracking() {
  const dot = document.getElementById("centerDot");
  dot.style.display = "none";

  if (!idleListener) {
    idleListener = map.addListener("idle", () => {
      const center = map.getCenter();
      const lat = center.lat();
      const lng = center.lng();

      myLatLng = { lat, lng };
      initialMarker.position = myLatLng;

      getClosestAddress(lat, lng, (address) => {
        if (address) {
          const streetName = extractStreetName(address);
        homeMarkerEl.querySelector("#destinationMarkerAddress").innerHTML = streetName; // will be updated below	
          document.getElementById("addressOverlayAddress2").innerHTML = streetName;
          document.getElementById("addressOverlayAddress3").innerHTML = streetName;
          document.getElementById("addressOverlayAddress4").innerHTML = streetName;		
       //   document.getElementById("storeDropoff").innerHTML = streetName; 		
        }
      });
    });
  }

  dragStartListener = map.addListener("dragstart", () => {
    dot.style.display = "block";
initialMarker.map = null;	  
  });

  dragEndListener = map.addListener("dragend", () => {
    setTimeout(() => {
      dot.style.display = "none";
	    initialMarker.map = map; // assuming `map` is your Google Maps instance

    }, 300);

  });
}

function disableCenterDotTracking() {
  const dot = document.getElementById("centerDot");
  dot.style.display = "none";

  if (idleListener) {
    google.maps.event.removeListener(idleListener);
    idleListener = null;
  }
  if (dragStartListener) {
    google.maps.event.removeListener(dragStartListener);
    dragStartListener = null;
  }
  if (dragEndListener) {
    google.maps.event.removeListener(dragEndListener);
    dragEndListener = null;
  }
}

function toggleManualButtons(isManualOn) {
  document.getElementById("manualLocation").style.display = isManualOn ? "none" : "inline-block";
  document.getElementById("manualLocationOff").style.display = isManualOn ? "inline-block" : "none";
  document.getElementById("useMyLocationButton").style.display = isManualOn ? "none" : "inline-block";
  document.getElementById("searchLocation").style.display = isManualOn ? "none" : "inline-block";
 positionControlsAbovePane(myPane);	
}

// Bind interactions
document.getElementById("manualLocation").addEventListener("click", () => {
  toggleManualButtons(true);
  enableCenterDotTracking();
});

document.getElementById("manualLocationOff").addEventListener("click", () => {
  toggleManualButtons(false);
  disableCenterDotTracking();
});	


function handleSubmitClick() {
sendLocationButton=document.getElementById("submitAddress");
  // Lock UI and show spinner
  document.body.classList.add('touch-lock');
  sendLocationButton.disabled = true;
  sendLocationButton.innerHTML = `
    <span class="button-loader">
      <i class="fas fa-spinner fa-spin"></i> Sending...
    </span>
  `;	
  // Turn off manual location if it's currently on
  const isManualVisible = document.getElementById("manualLocation").style.display === "none";
  if (isManualVisible) {
    toggleManualButtons(false);
    disableCenterDotTracking();
  }

  // Save coordinates for later use after label entry
  initialCoordinates = `${initialMarker.position.lat},${initialMarker.position.lng}`;

  // Show the label input modal
//  labelPane.present({ animate: true });
changeHomeAddressDatabase(phone_number, initialCoordinates, () => {

 document.getElementById("search-Controls").style.display = "none";
	
  // Delay after breakpoints
   myPaneBreaks =({
    top: { enabled: false, height: window.innerHeight, bounce: true },
    middle: { enabled: true, height: 480, bounce: true },
    bottom: { enabled: false, height: 100 }
  });
    myPane.setBreakpoints(myPaneBreaks);
	console.log('changing breakpoints'); 

  setTimeout(() => {
   
    myPane.moveToBreak('middle');

    const verticalLineMain = document.querySelector('.vertical-line');
    const bottomB = document.getElementById('bottomB');
    const pickupCircle = document.getElementById('pickupCircle');

    bottomB.classList.remove('fading-collapse');
    pickupCircle.classList.remove('fading-out');
    verticalLineMain.classList.remove('collapsing');
    pickupCircle.classList.remove('fading-collapse-tight');

    updateMapHeight(myPane);
    allowMarkerUpdate = false;
    clearGeoJsonBounds(map);
   document.getElementById('changeAddress').style.display = 'block';
sendLocationButton=document.getElementById("submitAddress");
  // Lock UI and show spinner
  document.body.classList.remove('touch-lock');
  sendLocationButton.disabled = false;
  sendLocationButton.innerHTML = `
    <span>
      Done Selecting Dropoff
    </span>
  `;
//   sendLocationButton.style.display="none";
	 sendLocationButton.classList.add("hidden");  
   document.getElementById("submitStores").style.display = "block"; 
  }, 1000);
});	
	
}

function handleLabelSubmit() {
 destination_label = document.getElementById("locationLabelInput").value.trim();	
  if (!destination_label) {
    alert("Please enter a label for this location.");
    return;
  }
	
  handleLabelSubmitButton=document.getElementById("handleLabelSubmitButton");
  document.body.classList.add('touch-lock');
  handleLabelSubmitButton.disabled = true;
  handleLabelSubmitButton.innerHTML = `
    <span class="button-loader">
      <i class="fas fa-spinner fa-spin"></i> Sending...
    </span>
  `;	


        homeMarkerEl.querySelector("#destinationMarkerLabel").textContent = destination_label;
     


   initialCoordinates = `${initialMarker.position.lat},${initialMarker.position.lng}`;
changeHomeAddressDatabase(phone_number, initialCoordinates, () => {
setTimeout(() => {
  handleLabelSubmitButton=document.getElementById("handleLabelSubmitButton"); 	
  document.body.classList.remove('touch-lock');
  handleLabelSubmitButton.disabled = false;
  handleLabelSubmitButton.innerHTML = "Continue";
  dismiss9(); 
},1000); 
});	
}












const submitButton = document.querySelector(".submitNewInstructionsButton");
submitButton.addEventListener("click", () => {
  updateInstructions(phone_number);
});










let homeMarkerEl;
let marker = null;
let myLatLng = { lat: 35.906102724086054, lng: -79.0669912804284 };

// Initate Map with drop-off location and get the user's state

async function initMap() {
    const {
        Map
    } = await google.maps.importLibrary("maps");
    const {
        AdvancedMarkerElement
    } = await google.maps.importLibrary("marker");
    const myLocation = {
        lat: 35.911479,
        lng: -79.057517
    };

    // Create a map centered at the specified location
    map = new google.maps.Map(document.getElementById("map"), {
        mapId: 'd78bed7cedcaf86',
        center: myLocation,
        fullscreenControl: false,
        streetViewControl: false,
        zoomControl: false,
        mapTypeControl: false,

        mapTypeControlOptions: {
            style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
            position: google.maps.ControlPosition.TOP_RIGHT
        },
        zoom: 15, // Adjust the zoom level as needed
        minZoom: 10, // Set your desired minimum zoom level
        maxZoom: 19 // Set your desired maximum zoom level

    });



    let allowMarkerUpdate = true;
const markerElement = document.createElement('div');
markerElement.innerHTML = `
<div class="home-marker group relative cursor-pointer flex flex-col items-center text-blue-600">
  <!-- Fixed Icon + Arrow Block -->
  <div class="relative z-10 flex flex-col items-center">
    <!-- Icon -->
    <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center shadow-md">
      <i class="fas fa-house text-blue-600 text-xl"></i>


    </div>

    <!-- Arrow (always fixed below icon) -->
	          <div class="courier-overlay-icon hidden">
    <i class="fas fa-bicycle"></i>
  </div>
    <div class="mt-0">
      <i class="fas fa-caret-down text-blue-600 text-lg"></i>
    </div>
  </div>

  <!-- Expanding Blue Container (grows upward above icon) -->
  <div class="absolute bottom-[56px] left-1/2 transform -translate-x-1/2 flex flex-col items-center text-center
              opacity-0 max-h-0 overflow-hidden transition-all duration-500 ease-in-out
              group-[.expanded]:opacity-100 group-[.expanded]:max-h-[200px] group-[.expanded]:w-[160px]
              group-[.expanded]:bg-blue-100 group-[.expanded]:rounded-lg group-[.expanded]:p-3 group-[.expanded]:shadow-md">
    
    <!-- Label -->
    <div id="destinationMarkerLabel" class="text-sm font-semibold mb-1">
     
    </div>

    <!-- Address -->
    <div id="destinationMarkerAddress" class="text-xs text-gray-700">
    </div>
  </div>
</div>	
`;

 homeMarkerEl = markerElement.querySelector('.home-marker');


 initialMarker = new google.maps.marker.AdvancedMarkerElement({
  map: map,
  position: myLatLng,
  content: homeMarkerEl,
  title: 'Initial Location'
});

homeMarkerEl.addEventListener('click', () => {
  homeMarkerEl.classList.toggle('expanded');
});

map.setCenter(initialMarker.position);
getUserState(infoWindow, myLatLng, initialMarker)
    .then(resolve => {
        if (smsSequence !== 'CHOOSE_STORE') {
            console.log('stopping other functions');
            return;
        }

        // Update external overlay label
        document.getElementById("addressOverlayAddress2Label2").textContent = destination_label;

        // Update marker content directly
        homeMarkerEl.querySelector("#destinationMarkerLabel").textContent = destination_label;
        homeMarkerEl.querySelector("#destinationMarkerAddress").textContent = ''; // will be updated below

        // Update external label wrapper
        const wrapper = document.getElementById('addressOverlayAddress2LabelWrapper');
        wrapper.innerHTML = `
          <div id="addressOverlayAddress2Label" class="font-medium text-lg text-gray-800">
            ${destination_label}
          </div>
          <button
            type="button"
            onclick="labelPane.present({ animate: true })"
            class="ml-2 text-gray-500 hover:text-blue-600 focus:outline-none"
            aria-label="Edit label"
          >
            <i class="fas fa-pencil-alt text-sm"></i>
          </button>
        `;

        getClosestAddress(latitude, longitude, (address) => {
            if (address) {
                console.log('updating instructions address');
                const streetName = extractStreetName(address);

                document.getElementById("addressOverlayAddress2").innerHTML = streetName;
                document.getElementById("addressOverlayAddress3").innerHTML = streetName;
                document.getElementById("addressOverlayAddress4").innerHTML = streetName;

                 homeMarkerEl.querySelector("#destinationMarkerAddress").innerHTML = streetName;
            } else {
                const streetName = "GeoServices turned off";

                document.getElementById("addressOverlayAddress2").innerHTML = streetName;
                document.getElementById("addressOverlayAddress3").innerHTML = streetName;
                document.getElementById("addressOverlayAddress4").innerHTML = streetName;

               homeMarkerEl.querySelector("#destinationMarkerAddress").textContent = streetName;
            }
        });
    })
    .catch((error) => {
        console.error('Error retrieving user state:', error);
    });
		
}


//END OF INITIATE MAP



document.getElementById('locateButton').addEventListener('click', () => {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(position => {
      const userLocation = {
        lat: position.coords.latitude,
        lng: position.coords.longitude
      };

      map.setCenter(userLocation); // Center the map on the user's location
	   console.log('centering user locaton'); 
    }, () => {
      alert("Geolocation failed or permission denied.");
    });
  } else {
    alert("Geolocation is not supported by this browser.");
  }
});

//window.onload = initMap;

function handleStoreSubmitWrapper(event) {
    handleStoreSubmit(event);
}

// Modify `initialButtonListener()`
function initialButtonListener() {
    myPane.moveToBreak('middle');
    map.panTo(myLatLng);
    map.setZoom(16);
    submitAndShowStores('CHOOSE_STORE');

    document.getElementById('info-container2').style.display = 'block';
//    document.getElementById("submitStoreContent").style.display = 'block';

//    myPane.destroy({ animate: true });
//    merchantPane.present({ animate: true });
  updateUncheckedStoreMarkers();

document.querySelectorAll('.checkbox-container input[type="checkbox"]').forEach(cb => {
  cb.removeEventListener('change', handleCheckboxChange); // Just in case
  cb.addEventListener('change', handleCheckboxChange);
});


    document.getElementById("submitFooter").style.display = "none";
    allowMarkerUpdate = false;

//    const address = document.getElementById('street_name_address');
//    address.innerHTML = streetName;

    const sendStores = document.getElementById('submitStores');
    const storeFormCheckboxes = $('#storeForm input[type="checkbox"]');

     

    // ✅ Remove using the persistent function reference
    sendStores.removeEventListener('click', handleStoreSubmitWrapper);
    sendStores.addEventListener('click', handleStoreSubmitWrapper);
}
//////////////////////////////////////////////////////////////////////////////////////////////



function handleSortClick() {
    const columnIndex = parseInt(this.getAttribute('data-sort-col'));
    sortTableWithChildRows(table, columnIndex, ascending);
    ascending = !ascending;
}

function handleStoreSubmit(event) {
  const sendStoresButton = document.getElementById('submitStores');
  const originalContent = sendStoresButton.innerHTML;

  // Collect selected stores
  const selectedStores = $('#storeForm input[type="checkbox"]:checked')
    .map(function () {
      return $(this).val();
    })
    .get();

  const instructions = document.getElementById('deliveryInstructions').value;

  // If nothing selected, abort
  if (selectedStores.length === 0) {
    alert('You must select at least 1 store.');
    return;
  }

  // Lock UI and show spinner
  document.body.classList.add('touch-lock');
  sendStoresButton.disabled = true;
  sendStoresButton.innerHTML = `
    <span class="button-loader">
      <i class="fas fa-spinner fa-spin"></i> Sending...
    </span>
  `;

  // Send AJAX request
  $.ajax({
    url: `/app/map/${phone_number}/`,
    type: 'POST',
    data: {
      instructions: instructions,
      selected_stores: selectedStores,
      phone_number: phone_number,
      form_submit: true
    },
    success: function (response) {
      console.log('Data sent successfully:', response);
        setTimeout(() => {
    waitPage(infoWindow);
    sendStoresButton.removeEventListener('click', handleStoreSubmit);
    sendStoresButton.style.display = 'none';
    document.body.classList.remove('touch-lock');
  }, 2000); // Delay in milliseconds (adjust as needed)

	    
    },
    error: function (error) {
      console.error('Error sending data:', error);
      sendStoresButton.innerHTML = originalContent;
      sendStoresButton.disabled = false;
      document.body.classList.remove('touch-lock');
    }
  });
}
function sortTableWithChildRows(table, columnIndex, ascending) {
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr:not(.child-row)'));
    const childRows = Array.from(tbody.querySelectorAll('tr.child-row'));

    rows.sort((a, b) => {
        const aValue = a.cells[columnIndex].textContent.trim();
        const bValue = b.cells[columnIndex].textContent.trim();
        const comparison = aValue.localeCompare(bValue, undefined, {
            numeric: true
        });

        // Reverse the order if descending
        return ascending ? comparison : -comparison;
    });

    tbody.innerHTML = ''; // Clear existing rows
    rows.forEach(row => {
        tbody.appendChild(row);
        const parentId = row.getAttribute('data-parent-id');
        const childRow = childRows.find(child => child.getAttribute('data-parent-id') === parentId);
        if (childRow) {
            tbody.appendChild(childRow);
        }
    });
}


 function displayModal(){
                     modifyPaymentPane.present({animate:true});  
                      }
function hideModal(){
		     modifyPaymentPane.destroy({animate:true}); 
                    
                      }



function initializeStoreSwiper(){
if (storeSwiper) {
  storeSwiper.destroy(true, true); // Properly destroy Swiper before reinitializing
}

const paginationEl = document.querySelector('.swiper-pagination-stores');
const slides = document.querySelectorAll('#selectedStoresWrapper .swiper-slide');
const totalSlides = slides.length;
const prevButton = document.getElementById('previous');
const nextButton = document.getElementById('nextSlide');



if (totalSlides === 0) {
  paginationEl.textContent = 'No stores selected';
  prevButton.style.display = 'none';
  nextButton.style.display = 'none';
} else {
  storeSwiper = new Swiper('#selectedStoresContainer', {
    slidesPerView: 1,
    spaceBetween: 10,
    grabCursor: true,
    freeMode: false,
    navigation: {
      nextEl: '#nextSlide',
      prevEl: '#previous'
    },
    pagination: {
      el: '.swiper-pagination-stores',
      type: 'custom',
      renderCustom: function (swiper, current, total) {
        if (total === 0) {
          prevButton.style.display = 'none';
          nextButton.style.display = 'none';
          return `No stores selected`;
        } else if (total === 1) {
          prevButton.style.display = 'none';
          nextButton.style.display = 'none';
    //      return `1 store selected`;
	  return ""
        } else {
          prevButton.style.display = 'flex';
          nextButton.style.display = 'flex';
    //      return `${total} stores selected (${current}/${total})`;
          return ""		
        }
      }
    },
  on: {
    init: function () {
      updateSlideCounter(this);
    },
    slideChange: function () {
      updateSlideCounter(this);
    }
  }	  
});
updateSlideCounter(storeSwiper);


function updateSlideCounter(storeSwiper) {
  const total = storeSwiper.slides.length;
  const counter = document.getElementById("slideCounter");

  if (total <= 1) {
    counter.style.display = "none";
  } else {
    const current = storeSwiper.realIndex + 1;
    counter.textContent = `${current}/${total}`;
    counter.style.display = "block";
  }
}

	
}

}
let storeSwiperTracker; 
function initializeTrackerStoreSwiper(){
if (storeSwiperTracker) {
  storeSwiperTracker.destroy(true, true); // Properly destroy Swiper before reinitializing
}

const paginationEl = document.querySelector('.swiper-pagination-stores-tracker');
const slides = document.querySelectorAll('#selectedStoresWrapperTracker .swiper-slide');
const totalSlides = slides.length;
const prevButton = document.getElementById('previousTracker');
const nextButton = document.getElementById('nextSlideTracker');



if (totalSlides === 0) {
  paginationEl.textContent = 'No stores selected';
  prevButton.style.display = 'none';
  nextButton.style.display = 'none';
} else {
  storeSwiperTracker = new Swiper('#selectedStoresContainerTracker', {
    slidesPerView: 1,
    spaceBetween: 50,
    grabCursor: true,
    freeMode: false,
    navigation: {
      nextEl: '#nextSlideTracekr',
      prevEl: '#previousTracker'
    },
    pagination: {
      el: '.swiper-pagination-stores-tracker',
      type: 'custom',
      renderCustom: function (swiper, current, total) {
        if (total === 0) {
          prevButton.style.display = 'none';
          nextButton.style.display = 'none';
          return `No stores selected`;
        } else if (total === 1) {
          prevButton.style.display = 'none';
          nextButton.style.display = 'none';
    //      return `1 store selected`;
          return ""
        } else {
          prevButton.style.display = 'flex';
          nextButton.style.display = 'flex';
    //      return `${total} stores selected (${current}/${total})`;
          return ""
        }
      }
    },
  on: {
    init: function () {
      updateSlideCounter(this);
    },
    slideChange: function () {
      updateSlideCounter(this);
    }
  }       
});
updateSlideCounter(storeSwiperTracker);

    
function updateSlideCounter(storeSwiperTracker) {
  const total = storeSwiperTracker.slides.length;
  const counter = document.getElementById("slideCounterTracker");

  if (total <= 1) {
    counter.style.display = "none";
  } else {
    const current = storeSwiperTracker.realIndex + 1;
    counter.textContent = `${current}/${total}`;
    counter.style.display = "block";
  }
} 

        
}   
 
}



function fadeAndMovePane(container) {
  if (typeof myPane !== 'undefined') {
    console.log('[Courier Click] Moving pane to bottom...');
    myPane.moveToBreak('bottom');
  } else {
    console.warn('[Courier Click] myPane is not defined.');
  }

  container.classList.remove('fading-in');
  container.classList.add('fading-out');

  console.log('[Courier Click] Container fading out.');
}




let abort;
function waitPage(infoWindow) {
document.getElementById("totalPrice").style.display = 'none'; 
document.getElementById("submitFooter").style.display = 'none'; 
setTimeout(() => {
document.getElementById('courierCountContainer').style.display = "flex";	
}, 8000); // waits 1 second (1000ms) before running	
	
document.getElementById("changeInstructions").style.display = "block";	
document.getElementById('selectPayCourier').style.display = 'block';
document.getElementById('courierCountContainer').onclick = function () {
  fadeAndMovePane(this);
};


//startSearchingAnimation();


map.setOptions({
  disableDefaultUI:false
});
document.getElementById('statistics-overlay').style.display='none';
//document.getElementById('guidanceDetails').style.display = 'block'; 
map.panTo(myLatLng);
map.setZoom(16);


const phone_number = '+19193609602';
let addressName;
// ✅ Use the converted `lat` and `lng` in `getClosestAddress()`
getClosestAddress(myLatLng.lat,myLatLng.lng, (address) => {
    console.log(address);


	console.log(address); 

        if (address) {
             streetName=extractStreetName(address)
	     document.getElementById("addressOverlayAddress2").innerHTML = streetName;
	     document.getElementById("addressOverlayAddress4").innerHTML = streetName;	
            } else {console.log('geoCoding failed');
             }
//});
fetch(`/tracker/${phone_number}`)
  .then(response => response.json())
  .then(data => {
    console.log(data);

    const orders = data.orders;
    const instructions = data.delivery.destination_unit;
    const payment = data.delivery.payment || '0.00';
        document.getElementById("pay-button").innerHTML = `
  <i class="fas fa-tag"></i>  $${payment}
`;
//    document.getElementById("waitPay").style.display = "block";
    const storesContainer = document.getElementById("selectedStoresWrapper");
    storesContainer.innerHTML = "";
const offerValue = payment; // Replace with your actual payment variable
document.getElementById('current-offer').textContent = `$${Number(offerValue).toFixed(2)}`;
orders.forEach(order => {
   createScreenshotUploadBlock(order, phone_number);
   orderID = normalizeStoreName(order.store_name);
   createForm(orderID);	

  const storeName = normalizeStoreName(order.store_name);
  const lat = order.lat;
  const lng = order.lng;
  console.log(lat, lng);

  const slide = document.createElement('div'); // This is now the swiper-slide
  slide.className = 'swiper-slide';
//  slide.style.width = '250px';
  slide.style.marginRight = '10px';

  const itemContainer = document.createElement('div');
  itemContainer.style.display = 'flex';
  itemContainer.style.justifyContent = 'space-between';
  itemContainer.style.alignItems = 'center';

  const nameAddressWrapper = document.createElement('div');
  nameAddressWrapper.style.display = 'flex';
  nameAddressWrapper.style.flexDirection = 'column';
  nameAddressWrapper.style.flex = '1';

  const storeLabel = document.createElement('span');
  storeLabel.textContent = storeName;
  storeLabel.style.fontSize = '18px';
  storeLabel.style.fontWeight = '500';

  const addressLabel = document.createElement('div');
  addressLabel.className = 'store-address';
  addressLabel.innerHTML = 'Looking up address...';

  nameAddressWrapper.appendChild(storeLabel);
  nameAddressWrapper.appendChild(addressLabel);

const buttonWrapper = document.createElement('div');
buttonWrapper.style.display = 'flex';
buttonWrapper.style.alignItems = 'center';
buttonWrapper.style.justifyContent = 'center';
buttonWrapper.className = 'storeOrderView';
buttonWrapper.style.padding = '5px'; 

const button = document.createElement("button");
button.className = "store-action-button";
button.dataset.storeName = storeName; 
button.style.cssText = `
  background-color: #007bff;
  color: white;
  border: none;
  padding: 6px 12px;
  margin-top: 8px;
  cursor: pointer;
  border-radius: 4px;
  display: flex;
  align-items: center;
  gap: 6px; /* Adds spacing between icon and text */
`;

const infoIcon = document.createElement('i');
infoIcon.className = 'fas fa-info-circle';
infoIcon.style.fontSize = '16px';

// Append icon first, then text
button.appendChild(infoIcon);
button.appendChild(document.createTextNode(" Order"));

buttonWrapper.appendChild(button);
  itemContainer.appendChild(nameAddressWrapper);
  itemContainer.appendChild(buttonWrapper);
  slide.appendChild(itemContainer); // append everything to swiper-slide div
  storesContainer.appendChild(slide); // and inject into swiper-wrapper



button.onclick = () => {
  myPane.hide();

  const normalizedID = normalizeStoreName(order.store_name);
  console.log("Normalized Store ID:", normalizedID);

  const trackerButtonContainer3 = document.getElementById("tracker-button-container");
  const orderUploadOverlay = document.getElementById("order-upload-image-new");
  const orderUploadOverlaySubmit = document.getElementById("order-upload-overlay");

  const orderImg = document.querySelector(`img[data-order-image="${normalizedID}IMG"]`);
  const orderImgId = document.getElementById(`${normalizedID}IMG`);
  const orderButton = document.getElementById(`${normalizedID}inputLabel`);
  const orderForm = document.querySelector(`form[data-upload-screenshot="${normalizedID}UP"]`);
  const detailForm = document.getElementById(`form-wrapper-${normalizedID}`);
  const dynamicForm = document.getElementById('dynamic-form-container');
  const uploadForm = document.getElementById(`${normalizedID}-container`);

  hideAllChildren(orderUploadOverlay);
  document.getElementById("closeIMG").style.display = "flex";
  hideAllChildren(orderUploadOverlaySubmit);
  hideAllChildren(dynamicForm);

  if (orderForm) orderForm.style.display = "block";
  if (orderButton) orderButton.style.display = "block";
  if (orderImg) orderImg.style.display = "block";
  if (detailForm) detailForm.style.display = "block";
  if (uploadForm) uploadForm.style.display = "block";

  paneModal.present({ animate: true });



                function waitForButtons() {
                  const orderUploadButtons = Array.from(document.querySelectorAll(".Order-Upload-Button"))
                    .filter(button => button.style.display !== "none");

                  if (orderUploadButtons.length > 0) {
                    processButtons(orderUploadButtons);
                  } else {
                    setTimeout(waitForButtons, 100);
                  }
                }

                function processButtons(buttons) {
                  const storeName = normalizeStoreName(order.store_name);
                  buttons.forEach(button => {
                    if (button.id === `${storeName}inputLabel`) {
                      button.innerHTML = `
                        <div style="position: relative; display: inline-block;">
                          <i class="fas fa-receipt" style="color:#007bff; font-size:100px;"></i>
                          <i class="fas fa-plus"
                             style="
                               position: absolute;
                               top: -45px;
                               right: -35px;
                               font-size: 35px;
                               color: #007bff;
                               background: none;
                               border-radius: 50%;
                               padding: 4px;
                             ">
                          </i>
                        </div>T
                      `;
                    }
                  });
                }

                waitForButtons();
              };











	// 🔧 Now using correct lat/lng fields
  getClosestAddress(lat, lng, (address) => {
    const streetname = extractStreetName(address);
    addressLabel.innerHTML = streetname || 'Address not found';
  });
});
    const storeNames2 = orders.map(order => order.store_name);	  
    plotDeliveryAfter(storeNames2);
    submitAndShowStores('store chosen');
    document.getElementById("changeAddress").style.display = "none";
    document.getElementById("chooseStoreButton").style.visibility = "hidden";

    console.log('wait page function initiated on reload');
  })
  .catch(error => {
    console.error('Error:', error);
  });
	
   
//    infoWindowListener=infoWindow.addListener("domready", function () {
//google.maps.event.removeListener(infoWindowListener); 
    // Assuming you have the remaining time in seconds
    const data = {'name': 'Created a Delivery', 'hours': 0, 'minutes': 15, 'seconds': 0}; // Safely embed the data
    console.log(data);
    let remainingTime = data.hours * 3600 + data.minutes * 60 + data.seconds;
   const daysElement = document.getElementById('days');
    const hoursElement = document.getElementById('hours');
    const minutesElement = document.getElementById('minutes');
    const secondsElement = document.getElementById('seconds');

    function updateTimer() {
        const days = Math.floor(remainingTime / (24 * 60 * 60));
        const hours = Math.floor((remainingTime % (24 * 60 * 60)) / 3600);
        const minutes = Math.floor((remainingTime % 3600) / 60);
        const seconds = remainingTime % 60;

       daysElement.textContent = days;
       hoursElement.textContent = hours;
        minutesElement.textContent = minutes;
        secondsElement.textContent = String(seconds).padStart(2, '0');

        // Update remainingTime every second
        remainingTime--;
        if (remainingTime >= 0) {

            setTimeout(updateTimer, 1000);
        }
    }

    updateTimer();
//    document.getElementById('countdown-timer').style.display='inline-flex';	     


let abort = false;

function pollSignalStatus() {
  fetch(`/check_signal_status/${phone_number}?abort=${abort}`)
    .then(response => response.json())
    .then(data => {
      console.log("Polling Data:", data);
      
      if (data.signal_triggered) {
        console.log("Courier Has Been Paid");
	 smsSequence = "SEND_SCREENSHOT"; 
         goToStep(true,true,false,false,false); 	
        const cancelControls = document.getElementById("cancelControls");
        if (cancelControls) cancelControls.style.display = "none";
        // Optional: trigger deliveryUpdates(initialMarker);
	  getCouriers("all");   
	  pollPaymentStatus(); 
	  document.getElementById("submitFooter").style.display ="none"; 
        return;
      }

      if (data.expired_triggered && smsSequence !== 'SEND_SCREENSHOT') {
        window.location.href = `/app/map/${phone_number}/`;
        return;
      }

      const totalSeconds = data.data.total_seconds;

      if (totalSeconds === 0) {
        // Show loading overlay
        const overlay = document.getElementById("overlay-container");
        if (overlay) overlay.style.display = "block";

        // Update loading text
        const loadingText = document.getElementById("loading-text");
        if (loadingText) {
          loadingText.textContent = "Delivery expired. Removing post...";
        }

        // Optional: trigger post-removal logic here
        return;
      }

      console.log("polling");
      remainingTime = totalSeconds;
      console.log("Total seconds:", totalSeconds);

      getCouriers("all");

      // Continue polling
	    if (smsSequence !== 'SEND_SCREENSHOT'){
  setTimeout(pollSignalStatus, 5000);
}
    })
    .catch(error => {
      console.error("Error checking signal status:", error);
    });
}	
  setTimeout(() => {
if (!storeSwiper) {
  initializeStoreSwiper();
}	  
  }, 1000)

pollSignalStatus();	  



});

  document.getElementById("modify-payment-form").addEventListener("submit", function (event) {
    event.preventDefault(); // Prevent the default form submission behavior

    // Get the new price from the input field
    const newPrice = parseFloat(document.getElementById("new-amount").value);

    // Assuming you have the phone_number variable available
console.log(phone_number);
    // Create an object with the data you want to send
    const dataToSend = {
      user: phone_number,
      newPrice: newPrice,
    };
console.log(dataToSend);
console.log(JSON.stringify(dataToSend));

    // Make a POST request to your backend
    fetch("/modify_price/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        // Add any other headers you need (e.g., authentication tokens)
      },
      body: JSON.stringify(dataToSend),
    })
      .then((response) => response.json())
      .then((result) => {
        console.log("Response from server:", result);
const formattedPrice = parseFloat(newPrice).toFixed(2);

document.getElementById('current-offer').innerHTML = `$${formattedPrice}`;
document.getElementById('pay-button').innerHTML = `
  <i class="fas fa-tag"></i> $${formattedPrice}
`;
              hideModal();
      })
      .catch((error) => {
        console.error("Error sending data:", error);
        // Handle the error (e.g., show an error message)
      });

  });

}



/* END OF WAIT PAGE FUNCTION */





function markOrderAsPickedUp(storeName) {
	
  const normalizedStore = storeName.replace(/\s+/g, '');
  const button = document.getElementById(`${normalizedStore}OrderInfoButton`);
  const label = document.getElementById(`${normalizedStore}OrderButtonLabel`);
  const icon = document.getElementById(`${normalizedStore}OrderIcon`);
  const uploadWrapper = document.getElementById(`${normalizedStore}UploadButton`);

  if (!button || !label || !icon || !uploadWrapper) return;
  if (label.textContent === "Picked Up" && icon.classList.contains("fa-truck")) return;

  uploadWrapper.style.visibility = "visible";
  button.style.display = "block";

  // 🎨 Update styles for "picked up" state
  button.classList.remove(
    "bg-yellow-100", "text-yellow-800", "border-yellow-400",
    "hover:bg-yellow-200", "focus:ring-yellow-300"
  );
  button.classList.add(
    "bg-blue-100", "text-blue-800", "border-blue-400",
    "hover:bg-blue-200", "focus:ring-blue-300", "scale-105"
  );

  // 🏁 Update label and icon
  label.textContent = "Picked Up";
  icon.classList.remove("fa-circle-exclamation", "text-yellow-600");
  icon.classList.add("fa-truck", "text-blue-600");

  // ✨ Optional micro animation
  setTimeout(() => {
    button.classList.remove("scale-105");
  }, 150);
	
}

function markOrderAsSubmitted(storeName) {
	
  const normalizedStore = storeName.replace(/\s+/g, '');
  const button = document.getElementById(`${normalizedStore}OrderInfoButton`);
  const label = document.getElementById(`${normalizedStore}OrderButtonLabel`);
  const icon = document.getElementById(`${normalizedStore}OrderIcon`);
  const uploadWrapper = document.getElementById(`${normalizedStore}UploadButton`);

  if (!button || !label || !icon || !uploadWrapper) return;
  if (label.textContent === "Submitted" && icon.classList.contains("fa-circle-check")) return;

  uploadWrapper.style.visibility = "visible";

  // 🎨 Style shift
  button.classList.remove(
    "bg-yellow-100", "text-yellow-800", "border-yellow-400",
    "hover:bg-yellow-200", "focus:ring-yellow-300"
  );
  button.classList.add(
    "bg-green-100", "text-green-800",
    "hover:bg-green-200", "focus:ring-green-300", "scale-105"
  );

  // 🏁 Label + icon update
  label.textContent = "Submitted";
  icon.classList.remove("fa-circle-exclamation", "text-yellow-600");
  icon.classList.add("fa-circle-check", "text-green-600");

  // ✨ Micro pop animation
  setTimeout(() => {
    button.classList.remove("scale-105");
  }, 150);
	
}

async function pollPaymentStatus() {
  const phoneNumber = phone_number;
  const endpoint = `/payment_status/?phone_number=${encodeURIComponent(phoneNumber)}`;
  const pollingInterval = 15000;
  const maxPollingIterations = 2000;

  let iterationCount = 0;

  while (iterationCount < maxPollingIterations) {
    try {
      const response = await fetch(endpoint);
      const data = await response.json();

      courierToStore(data);

      const trackerButton2 = document.getElementById("tracker-button");
      const trackerSubtext = document.getElementById("tracker-subtext");

      const delivery = JSON.parse(data.delivery);
      const courierPhone = delivery[0].fields.courier_phone;

      const { status, destination_latitude: lat, destination_longitude: long } = delivery[0].fields;

      if (!addressPopulated) {
        getClosestAddress(lat, long, (address) => {
          console.log(address, 'this is the address for the new geocoding from filtered locations');
          if (address) {
            addressPopulated = true;

            const streetName = extractStreetName(address);
            document.getElementById("addressProgress").innerHTML = `<div>${destination_label}</div> ${streetName}`;

            const phoneLink = document.getElementById("phoneLink");
            const textLink = document.getElementById("textLink");

            if (phoneLink) phoneLink.href = `tel:${courierPhone}`;
            if (textLink) textLink.href = `sms:${courierPhone}`;
          }
        });
      }

      // 🧭 Update delivery-level progress
      const resolvedStatus = resolveProgressStatus(status);
      updateProgressFill(resolvedStatus);

      if (status === "picked_up") {
        console.log("Order picked up");
        document.getElementById("step3").querySelector("svg path").style.fill = "black";
        updateProgressFill("picked_up");
      }

      if (status === "delivered") {
        console.log("Order delivered");

        ["step2", "step3", "step4"].forEach(step =>
          document.getElementById(step).querySelector("svg path").style.fill = "black"
        );

        trackerButton2.innerText = "Order Dropped Off";
        trackerSubtext.innerText = "See Dropoff section for courier notes";
        const updatedBreaks = {
          top: { enabled: true, height: window.innerHeight },
          middle: { enabled: false, height: 350, bounce: true },
          bottom: { enabled: false, height: 200 }
        };
       
 $(document).on('click', '#newDelivery', function() {
    StartNewDelivery(phone_number);
});

        trackerPane.setBreakpoints(updatedBreaks);
        trackerPane.present({ animate: true });
        trackerPane.moveToBreak("top");

        document.getElementById("newDelivery").style.display = "inline-block";
      }

      // 📦 Order-by-order updates
      const ordersArray = JSON.parse(data.orders);
      const modal = document.getElementById("paneModal");

      if (ordersArray?.length && (!modal || modal.style.display === "none")) {
        updateOrderForms(ordersArray);
      }

      console.log("this is the form data from pollingPaymentStatus function", data.orders);

      if (ordersArray?.length) {
        const totalOrders = ordersArray.length;
        let submittedCount = 0;
        let pickedUpCount = 0;

        ordersArray.forEach(order => {
          const store = order.fields.store_name;
          const hasScreenshot = order.fields.order?.trim() !== "";
          const hasPickup = order.fields.status !== false;




const normalizedName = normalizeStoreName(order.fields.store_name);
const uploadEl = document.querySelector(`.store-action-button[data-store-name="${normalizedName}"]`);

 //         const uploadEl = document.getElementById(`${store.replace(/\s+/g, '')}UploadButton`);
          const orderImage = document.querySelector(`img[data-order-image="${store}IMG"]`);

          if (hasScreenshot) {
            submittedCount++;

            try {
              orderImage.src = `https://dtchtransport.com/media/${order.fields.order}`;
              Object.assign(orderImage.style, {
                // height: "100%",
                // width: "auto",
                // maxHeight: "100%"
              });

              const normalizedID2 = normalizeStoreName(store);
              const viewButton = document.getElementById(`${normalizedID2}-view`);
              if (viewButton) {
                viewButton.style.display = "inline-block";
              }
            } catch {}

            if (!hasPickup) {
          //    markOrderAsSubmitted(store);

              const statusDiv = document.getElementById(`${store.replace(/\s+/g, '')}StatusDiv`);
              if (statusDiv) {
                statusDiv.innerHTML = `
                  <div class="inline-flex items-center gap-2 px-3 py-1 text-sm font-semibold bg-red-50 text-red-600 border border-red-300 rounded-md shadow-sm">
                    <i class="fas fa-times-circle text-red-500"></i>
                    <span>Awaiting Pickup Confirmation</span>
                  </div>
                `;
              }
            }
          } else {
            uploadEl.style.visibility = "visible";
          }

          if (hasPickup) {
            pickedUpCount++;
         //   markOrderAsPickedUp(store);

            const statusDiv = document.getElementById(`${store.replace(/\s+/g, '')}StatusDiv`);
            if (statusDiv) statusDiv.style.display = "none";
          }
        });

        // 🧮 Update counters
        const submitCounter = document.getElementById("submit-counter");
        const pickupCounter = document.getElementById("pickup-counter");
        if (submitCounter) submitCounter.textContent = `(${submittedCount}/${totalOrders})`;
        if (pickupCounter) pickupCounter.textContent = `(${pickedUpCount}/${totalOrders})`;

        // ✅ Progress logic
        if (submittedCount === totalOrders) {
          document.getElementById("step2").querySelector("svg path").style.fill = "black";
          updateProgressFill("submitted");

          if (trackerButton2.innerText !== "Order Dropped Off") {
            trackerButton2.innerText = "Heading to pickup";
            trackerSubtext.innerText = "Thanks for submitting order information";
          }

          if (pickedUpCount === totalOrders) {
            document.getElementById("step3").querySelector("svg path").style.fill = "black";
            updateProgressFill("picked_up");

            if (trackerButton2.innerText !== "Order Dropped Off") {
              trackerButton2.innerText = "Heading to dropoff";
              trackerSubtext.innerText = "See dropoff section for estimated time of arrival";
            }
          }
        }
      }

      iterationCount++;
      await new Promise(resolve => setTimeout(resolve, pollingInterval));
    } catch (error) {
      console.error("Error fetching payment status:", error);
    }
  }

  console.log("Polling completed.");
}






function createScreenshotUploadBlock(order, phone_number) {
  const storeName = order.store_name;
   const normalizedID = normalizeStoreName(storeName); 
  // 🔹 Create fullscreen overlay
  const overlay = document.createElement('div');
  overlay.className = 'order-upload-overlay fixed inset-0 bg-black bg-opacity-50 z-50 hidden';
  overlay.id = `${normalizedID}-overlay`;
  document.body.appendChild(overlay);

  // 🔹 Create upload card container
  const container = document.createElement('div');
  container.className = 'mb-6 p-4 bg-gray-50 border border-gray-200 rounded shadow-sm';
  container.id = `${normalizedID}-container`;
  container.style.width = "350px"; 

  // 🔹 Header
  const header = document.createElement('h3');
  header.className = 'text-lg font-medium text-gray-800 mb-2';
  header.textContent = `${storeName} Screenshot Upload`;
  container.appendChild(header);

  // 🔹 Description
  const description = document.createElement('p');
  description.className = 'text-sm text-gray-600 mb-4';
  description.textContent = 'Screenshot will be available to the courier and used for pickup.';
  container.appendChild(description);

  // 🔹 Form
  const formElement = document.createElement('form');
  formElement.id = storeName;
  formElement.dataset.uploadScreenshot = `${storeName}UP`;
  formElement.method = 'post';
  formElement.enctype = 'multipart/form-data';
  formElement.className = 'flex flex-col gap-4';

  // CSRF token
  const csrfInput = document.createElement('input');
  csrfInput.type = 'hidden';
  csrfInput.name = 'csrfmiddlewaretoken';
  csrfInput.value = 'your_csrf_token_here'; // Replace with actual token
  formElement.appendChild(csrfInput);

  // File input
  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.accept = 'image/*';
  fileInput.name = 'screenshot';
  fileInput.id = `${normalizedID}CH`;
  fileInput.dataset.storeChoose = `${storeName}CH`;
  fileInput.className = 'hidden'; // hide native input
  formElement.appendChild(fileInput);

  // Upload label (styled as button)
  const fileInputLabel = document.createElement('label');
  fileInputLabel.setAttribute('for', fileInput.id);
  fileInputLabel.id = `${storeName}inputLabel`;
  fileInputLabel.className = 'inline-block px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded hover:bg-blue-700 transition cursor-pointer';
  fileInputLabel.innerHTML = `<i class="fas fa-upload mr-2"></i> Upload Screenshot`;
  formElement.appendChild(fileInputLabel);

  // Hidden inputs
  const storeNameInput = document.createElement('input');
  storeNameInput.type = 'hidden';
  storeNameInput.name = 'store_name';
  storeNameInput.value = storeName;
  formElement.appendChild(storeNameInput);

  const phoneInput = document.createElement('input');
  phoneInput.type = 'hidden';
  phoneInput.name = 'phone_number';
  phoneInput.value = phone_number;
  formElement.appendChild(phoneInput);

  // Submit placeholder
  const submitButtonElement = document.createElement('p');
  submitButtonElement.dataset.storeSubmit = `${storeName}SB`;
  submitButtonElement.style.display = 'none';
  formElement.appendChild(submitButtonElement);

  container.appendChild(formElement);

  // 🔹 Image preview
  const previewImg = document.createElement('img');
  previewImg.className = 'order-info max-w-xs rounded border border-gray-300 shadow-sm hidden';
  previewImg.dataset.orderImage = `${storeName}IMG`;
  previewImg.id = `${storeName}IMG`;
  previewImg.alt = `Empty ${storeName} Screenshot`;
  previewImg.style.color = "black"; 	
  container.appendChild(previewImg);

  // 🔹 View button
  const viewButton = document.createElement('button');
  viewButton.id = `${normalizedID}-view`;
  viewButton.className = 'px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded hover:bg-blue-700 transition';
  viewButton.textContent = 'View Image';
  viewButton.style.display = 'none'; 
  container.appendChild(viewButton);



	

  // 🔹 Status indicators
  const orderStatusElement = document.createElement('p');
  orderStatusElement.className = 'order-info text-sm text-gray-500 hidden';
  orderStatusElement.dataset.orderStatus = `${storeName}SSS`;
  orderStatusElement.textContent = 'No Order Screenshot';
  container.appendChild(orderStatusElement);

  const pickupStatusElement = document.createElement('p');
  pickupStatusElement.className = 'order-info text-sm text-gray-500 hidden';
  pickupStatusElement.dataset.pickupStatus = `${storeName}PKS`;
  pickupStatusElement.textContent = 'Status: Not Picked Up';
  container.appendChild(pickupStatusElement);

  // 🔹 Append to parent container
  const parentElement = document.getElementById('order-upload-overlay');
  parentElement.appendChild(container);

  // 🔹 File input change handler
  fileInput.addEventListener('change', (event) => {
    event.preventDefault();
    const file = fileInput.files[0];
    if (!file) return;

    const fileExtension = file.name.split('.').pop();
    const uniqueFileName = `${phone_number}_${storeName}.${fileExtension}`;

    const formData = new FormData(formElement);
    formData.append('file', file, uniqueFileName);
    formData.append('phone_number', phone_number);
    formData.append('store_name', storeName);

    previewImg.src = URL.createObjectURL(file);
    previewImg.classList.remove('hidden');
    previewImg.style.height = "100x"; 

    fileInputLabel.innerHTML = `<i class="fa fa-spinner fa-spin text-white text-xl"></i>`;
    fileInputLabel.style.backgroundImage = 'none';


  if (viewButton) {
    viewButton.style.display = "inline-block"; // or "flex" if styled that way
  }



    fetch('/upload/', {
      method: 'POST',
      body: formData,
    })
      .then(response => response.json())
      .then(data => {
        console.log('Upload successful:', data);
//        fileInputLabel.style.backgroundImage = `url(${previewImg.src})`;
//        fileInputLabel.style.backgroundSize = 'contain';
//        fileInputLabel.style.backgroundPosition = 'center';
//        fileInputLabel.style.backgroundRepeat = 'no-repeat';
        fileInputLabel.innerHTML = `<i class="fas fa-upload mr-2"></i> Upload Screenshot`;
      })
      .catch(error => {
        console.error('Error uploading screenshot:', error);
      });
  });

  // 🔹 View button click handler
  viewButton.addEventListener('click', () => {
    if (previewImg.src) {
      overlay.innerHTML = `
        <div class="flex items-center justify-center h-full">
          <img src="${previewImg.src}" class="max-w-full max-h-full rounded shadow-lg" />
        </div>
      `;
      overlay.classList.remove('hidden');
    }
  });

  // 🔹 Overlay close on click
  overlay.addEventListener('click', () => {
    overlay.classList.add('hidden');
    overlay.innerHTML = '';
  });
}


var lastWindow = null;
let markers2={};
let hasExistingOrderData = null;

document.getElementById("closeIMG").addEventListener("click", function () {
      orderPane.destroy({animate: true}); // Close modal on click
});
document.getElementById("closeOrderInfo").addEventListener("click", function () {
      paneModal.destroy({animate: true}); // Close modal on click
    //  trackerPane.present({animate:true});
	  myPane.present({animate:true});
});	


function markOrderAsPickedUp(storeName) {
  const normalizedStore = storeName.replace(/\s+/g, '');
  const button = document.getElementById(`${normalizedStore}OrderInfoButton`);
  const label = document.getElementById(`${normalizedStore}OrderButtonLabel`);
  const icon = document.getElementById(`${normalizedStore}OrderIcon`);
  const uploadWrapper = document.getElementById(`${normalizedStore}UploadButton`);

if (label.textContent === "Picked Up" && icon.classList.contains("fa-truck")) return;

  uploadWrapper.style.visibility ="visible"; 
   button.style.display ="block"; 
  if (!button || !label || !icon) return;

  // 🎨 Update styles for "picked up" state
  button.classList.remove(
    "bg-yellow-100", "text-yellow-800", "border-yellow-400",
    "hover:bg-yellow-200", "focus:ring-yellow-300"
  );
  button.classList.add(
    "bg-blue-100", "text-blue-800", "border-blue-400",
    "hover:bg-blue-200", "focus:ring-blue-300", "scale-105"
  );

  // 🏁 Update label and icon
  label.textContent = "Picked Up";
  icon.classList.remove("fa-circle-exclamation", "text-yellow-600");
  icon.classList.add("fa-truck", "text-blue-600");

  // ✨ Optional micro animation
  setTimeout(() => {
    button.classList.remove("scale-105");
  }, 150);
}

function markOrderAsSubmitted(storeName) {
  const normalizedStore = normalizeStoreName(storeName);
  const button = document.getElementById(`${normalizedStore}OrderInfoButton`);
  const label = document.getElementById(`${normalizedStore}OrderButtonLabel`);
  const icon = document.getElementById(`${normalizedStore}OrderIcon`);
  const uploadWrapper = document.getElementById(`${normalizedStore}UploadButton`);
if (label.textContent === "Submitted" && icon.classList.contains("fa-circle-check")) return;

  uploadWrapper.style.visiblity= "visible"; 	
  if (!button || !label || !icon) return;

  // Style shift
  button.classList.remove(
    "bg-yellow-100", "text-yellow-800", "border-yellow-400",
    "hover:bg-yellow-200", "focus:ring-yellow-300"
  );
  button.classList.add(
    "bg-green-100", "text-green-800",
    "hover:bg-green-200", "focus:ring-green-300", "scale-105"
  );

  // Label + icon update
  label.textContent = "Submitted";
  icon.classList.remove("fa-circle-exclamation", "text-yellow-600");
  icon.classList.add("fa-circle-check", "text-green-600");

  // Micro pop animation
  setTimeout(() => {
    button.classList.remove("scale-105");
  }, 150);
}


function addOrderSubmissionButton(data){
  fetch(`/tracker/${phone_number}`)
    .then(response => response.json())
    .then(data => {
      deliveryData = data;
      console.log(data.orders);

      if (data.orders.length > 0) {
        hasExistingOrderData = data.orders[0];
      } else {
        hasExistingOrderData = null;
      }

      console.log(data, 'this is the data');

      const destination = {
        latitude: data.delivery.destination_latitude,
        longitude: data.delivery.destination_longitude
      };

      const pickupPoints = data.orders.map(order => ({
        latitude: order.lat,
        longitude: order.lng,
        store_name: order.store_name
      }));

      plotPickupMarkersOnly(destination, pickupPoints);

      for (const order of data.orders) {
        const storeMarkerImg = new google.maps.MarkerImage(
          "/static/bootstrap-icons/upload.png",
          null,
          null,
          null,
          new google.maps.Size(0, 0)
        );

        markers2[order.store_name] = new google.maps.Marker({
          position: { lat: order.lat, lng: order.lng },
          map: map,
          icon: storeMarkerImg,
          title: order.store_name
        });

        createScreenshotUploadBlock(order, phone_number);
        orderID = order.store_name;
   console.log(orderID); 
   createForm(orderID); 

        const storeSlides = document.querySelectorAll("#selectedStoresWrapper .swiper-slide");
        const normalizedStoreName = normalizeStoreName(order.store_name);
         
        storeSlides.forEach(slide => {
         
          const nameSpan = slide.querySelector("span");
          if (nameSpan && nameSpan.textContent.trim() === order.store_name.trim()) {
		  if (!slide.querySelector(`.store-action-button[data-store-name="${normalizedStoreName}"]`)) {
              const button = document.createElement("button");
              button.className = "store-action-button";
              button.dataset.storeName = normalizedStoreName;	    
              button.textContent = "Order Info"
              button.style.cssText = `
                background-color: #007bff;
                color: white;
                border: none;
                padding: 6px 12px;
                margin-top: 8px;
                cursor: pointer;
                border-radius: 4px;
              `;

              button.onclick = () => {
                myPane.hide();

                const storeName = normalizeStoreName(order.store_name);
                const normalizedID = normalizeStoreName(order.store_name)

                const trackerButtonContainer3 = document.getElementById("tracker-button-container");
                const orderUploadOverlay = document.getElementById("order-upload-image-new");
                const orderUploadOverlaySubmit = document.getElementById("order-upload-overlay");

                const orderImg = document.querySelector(`img[data-order-image="${storeName}IMG"]`);
                const orderImgId = document.getElementById(`${storeName}IMG`);
                const orderButton = document.getElementById(`${storeName}inputLabel`);
                const orderForm = document.querySelector(`form[data-upload-screenshot="${storeName}UP"]`);
                const detailForm = document.getElementById(`form-wrapper-${normalizedID}`);
                const dynamicForm = document.getElementById('dynamic-form-container');
                const uploadForm = document.getElementById(`${normalizedID}-container`);

                hideAllChildren(orderUploadOverlay);
                document.getElementById("closeIMG").style.display = "flex";
                hideAllChildren(orderUploadOverlaySubmit);
                hideAllChildren(dynamicForm);

                orderForm.style.display = "block";
                orderButton.style.display = "block";
                orderImg.style.display = "block";
                detailForm.style.display = "block";
                uploadForm.style.display = "block";

                function waitForButtons() {
                  const orderUploadButtons = Array.from(document.querySelectorAll(".Order-Upload-Button"))
                    .filter(button => button.style.display !== "none");

                  if (orderUploadButtons.length > 0) {
                    processButtons(orderUploadButtons);
                  } else {
                    setTimeout(waitForButtons, 100);
                  }
                }

                function processButtons(buttons) {
                  const storeName = normalizeStoreName(order.store_name);
                  buttons.forEach(button => {
                    if (button.id === `${storeName}inputLabel`) {
                      button.innerHTML = `
                        <div style="position: relative; display: inline-block;">
                          <i class="fas fa-receipt" style="color:#007bff; font-size:100px;"></i>
                          <i class="fas fa-plus"
                             style="
                               position: absolute;
                               top: -45px;
                               right: -35px;
                               font-size: 35px;
                               color: #007bff;
                               background: none;
                               border-radius: 50%;
                               padding: 4px;
                             ">
                          </i>
                        </div>T
                      `;
                    }
                  });
                }

                waitForButtons();
              };
              const storeOrderView = slide.querySelector(".storeOrderView");
              storeOrderView.appendChild(button);
            }
          }
        });
      }
    })
    .catch(error => {
      console.error('Error fetching delivery data:', error);
    });
}

let deliveryData;
let courierMarkerMap = new Map();
function deliveryUpdates(initialMarker){
 instructions3 = JSON.parse(document.getElementById("userInstructions").textContent);
updateMapHeight(myPane); 
// Now you can use the object directly
document.getElementById("apartmentNumber").value = instructions3.apartment_number || "";
document.getElementById("accessCode").value = instructions3.access_instructions || "";
document.getElementById("deliveryTime").value = instructions3.delivery_time_preference || "";
document.getElementById("deliveryInstructions").value = instructions3.instructions || ""; 
        // Reverse geocode to get address
const lat = initialMarker.lat;
const lng = initialMarker.lng;

        getClosestAddress(lat,lng, (address) => {
          if (address) {
            const streetName = extractStreetName(address);
            document.getElementById("addressOverlayAddress4").innerHTML = streetName;            
     //      document.getElementById("storeDropoff").innerHTML = streetName;
          }
        });	
document.getElementById('courierCountContainer').style.display = "none"; 	
document.getElementById('map').style.height='95%';
console.log('delivery update function running');
	console.log('checkoutPage Function running');
  fetch(`/tracker/${phone_number}`)
    .then(response => response.json())
    .then(data => {
      deliveryData=data; 
      console.log(data.orders);
            if (data.orders.length > 0) {
                hasExistingOrderData = data.orders[0]; // Store full order data
            } else {
                hasExistingOrderData = null; // No order found
            }
	    console.log(data, 'this is the data');

const destination = {
  latitude: data.delivery.destination_latitude,
  longitude: data.delivery.destination_longitude
};

const pickupPoints = data.orders.map(order => ({
  latitude: order.lat,
  longitude: order.lng,
  store_name: order.store_name // optional, but included if needed
}));
//plotPointsAndDrawRoute(destination, pickupPoints);
plotPickupMarkersOnly(destination, pickupPoints); 
//plotPointsAndDrawLine(destination, pickupPoints);	    
            console.log("Updated hasExistingOrderData:", hasExistingOrderData);
      for (const order of data.orders) {


const storeMarkerImg = new google.maps.MarkerImage(
  "/static/bootstrap-icons/upload.png", // Replace with your actual image URL
  null, // Size (null to use the original image size)
  null, // Origin (null to use the top-left corner)
  null, // Anchor (null to use the center of the image)
  new google.maps.Size(0,0)
);	
        markers2[order.store_name] = new google.maps.Marker({
          position: { lat: order.lat, lng: order.lng },
          map: map, // Replace with your actual map reference
	  icon: storeMarkerImg,

	  title:order.store_name,
          // Add other marker options if needed (e.g., icon, title, etc.)
        });


//////////////////
createScreenshotUploadBlock(order, phone_number);		      

orderID = order.store_name;
   console.log(orderID); 
   createForm(orderID); 


//let markersClicked = false;
    markers2[order.store_name].addListener("click", () => {
//    document.getElementById(`${storeName}UploadButton`).addEventListener("click", () => {
//    document.getElementById("viewIMG").style.display = "none";
//    markersClicked = true; // Set flag to indicate markers2 was clicked
    myPane.hide();

 const storeName = order.store_name;
  const normalizedID = storeName.replace(/\s/g, '');
    // Retrieve necessary elements

    // Retrieve necessary elements

// Retrieve necessary elements
const trackerButtonContainer3 = document.getElementById("tracker-button-container");
const orderUploadOverlay = document.getElementById("order-upload-image-new");
const orderUploadOverlaySubmit = document.getElementById("order-upload-overlay");

const orderImg = document.querySelector(`img[data-order-image="${storeName}IMG"]`);
const orderImgId = document.getElementById(`${storeName}IMG`);
const orderButton = document.getElementById(`${storeName}inputLabel`);
const orderForm = document.querySelector(`form[data-upload-screenshot="${storeName}UP"]`);
const detailForm = document.getElementById(`form-wrapper-${normalizedID}`);
const dynamicForm = document.getElementById('dynamic-form-container');
	const uploadForm = document.getElementById(`${normalizedID}-container`);


    // Hide overlays and set visibility for elements
    hideAllChildren(orderUploadOverlay);
    document.getElementById("closeIMG").style.display = "flex";
    hideAllChildren(orderUploadOverlaySubmit);
    hideAllChildren(dynamicForm); 

    orderForm.style.display = "block";
    orderButton.style.display = "block";
    orderImg.style.display = "block";
    detailForm.style.display = "block"; 
    uploadForm.style.display = "block"; 

    if (markers2[order.store_name].icon.url === "/static/bootstrap-icon/upload.png") {
        paneModal.present({ animate: true });
//        document.getElementById("viewIMG").style.display = "none";
        orderButton.style.backgroundImage.src = "";
        orderButton.style.backgroundColor = "transparent"; // Reset styling	    
    } else {
    //    document.getElementById("viewIMG").style.display = "block";
        paneModal.present({ animate: true });

        function waitForButtons() {
            const orderUploadButtons = Array.from(document.querySelectorAll(".Order-Upload-Button"))
                .filter(button => button.style.display !== "none");

            if (orderUploadButtons.length > 0) {
                processButtons(orderUploadButtons);
            } else {
                setTimeout(waitForButtons, 100); // Check again after 100ms
            }
        }
function processButtons(buttons) {
	const storeName = normalizeStoreName(order.store_name); 
    buttons.forEach(button => {
        // Ensure button matches the correct store before applying background image
        if (button.id === `${storeName}inputLabel`) {
          //button.innerHTML = `<i style="color:black; font-size:60px;" class="fa fa-spinner fa-spin"></i>`;
		button.innerHTML = `<i style="color:#007bff; font-size:26px;" class="fa fa-spinner fa-spin"></i>`;

            const testOrder = document.querySelector(`img[data-order-image="${order.store_name}IMG"]`);
            
            if (testOrder && testOrder.src) {
               // button.style.backgroundImage = `url(${testOrder.src})`;
                //button.style.backgroundSize = "contain";
               // button.style.backgroundPosition = "center";
               // button.style.backgroundRepeat = "no-repeat";
            } else {
              //  button.style.backgroundImage = "none"; // Explicitly clear background
              //  button.style.backgroundColor = "transparent"; // Reset styling
            }

           button.innerHTML = `
  <div style="position: relative; display: inline-block;">
    <i class="fas fa-receipt" style="color:#007bff; font-size:100px;"></i>
    <i class="fas fa-plus" 
       style="
         position: absolute;
         top: -45px;
         right: -35px;
         font-size: 35px;
         color: #007bff;
         background: none;
         border-radius: 50%;
         padding: 4px;
       ">
    </i>
  </div>
`;
	//     button.innerHTML = `<i style="color:#007bff; font-size:100px;" class="fas fa-receipt"></i>`;
     //       document.getElementById("viewIMG").style.display = "block";
        }
    });
}	    
        // Start checking for buttons
        waitForButtons();
    }
});




}
data.orders.forEach((order) => {
  const { store_name, lat, lng } = order;

  // Create slide
  const swiperSlide = document.createElement("div");
  swiperSlide.className = "swiper-slide";

  // Outer row container
  const storeOrderContainer = document.createElement("div");
  storeOrderContainer.classList.add("store-order-tracker");

  // Column for store name + address
  const nameAddressWrapper = document.createElement("div");
  nameAddressWrapper.classList.add("name-address");
  nameAddressWrapper.id = `${store_name.replace(/\s+/g, '')}AddressTrackerWrapper`; 

  const storeLabel = document.createElement("div");
  storeLabel.classList.add("store-name");
  storeLabel.textContent = store_name;

  const addressLabel = document.createElement("div");
  addressLabel.className = "store-address";
  addressLabel.innerHTML = `<span>Looking up address...</span>`;

  const statusDiv = document.createElement("div");
  statusDiv.className = "statusDiv";
  statusDiv.id = `${store_name.replace(/\s+/g, '')}StatusDiv`;	

  nameAddressWrapper.appendChild(storeLabel);
  nameAddressWrapper.appendChild(addressLabel);
  nameAddressWrapper.appendChild(statusDiv); 

  // Upload button
  const uploadButton = document.createElement("div");
  uploadButton.id = `${store_name.replace(/\s+/g, '')}UploadButton`;
//  uploadButton.className ="tracker-store-swiper";
normalizedStore= normalizeStoreName(store_name);
//  uploadButton.style.position = "absolute";
//  uploadButton.style.top = "-3px";
//  uploadButton.style.right = "0px";
    uploadButton.style.visibility = "hidden"; 

uploadButton.innerHTML = `
  <button
    id="${normalizedStore}OrderInfoButton"
    class="inline-flex items-center gap-2 px-4 py-2 bg-yellow-100 text-yellow-800 text-sm font-medium rounded-md border border-yellow-400 hover:bg-yellow-200 focus:outline-none focus:ring-2 focus:ring-yellow-300 transition-all duration-300 ease-out"
    style=" position: absolute; top: 0px; right: 0px;"
  >
    <i id="${normalizedStore}OrderIcon" class="fas fa-circle-exclamation text-yellow-600 transition-transform duration-300"></i>
    <span id="${normalizedStore}OrderButtonLabel">Submit Order</span>
  </button>
`;
	
  uploadButton.addEventListener("click", () => uploadOrder(store_name));

  // Assemble row
  storeOrderContainer.appendChild(nameAddressWrapper);
  
  storeOrderContainer.appendChild(uploadButton);
  swiperSlide.appendChild(storeOrderContainer);

  // Append slide to tracker wrapper
  document.getElementById("selectedStoresWrapperTracker").appendChild(swiperSlide);

  // Resolve address
  getClosestAddress(lat, lng, (address) => {
    const streetname = extractStreetName(address);
    addressLabel.innerHTML = streetname || "<span>Address not found</span>";
  });
});

initializeTrackerStoreSwiper(); 
//document.getElementById('order-upload-overlay').style.display = 'block';
/*
// Initialize Swiper
const trackerStoreSwiper = new Swiper('.tracker-store-swiper', {
  slidesPerView: 1,
  spaceBetween: 60,
  pagination: {
    el: '.tracker-store-swiper .swiper-pagination',
    clickable: true,
  },
});
*/

function uploadOrder(store) {
  console.log(store);
  const storeMarker=markers2[store];
 google.maps.event.trigger(storeMarker, 'click');
}

        })
        .catch(error => {
            console.error("Error fetching response_data:", error);
            // Handle the error (e.g., show an error message to the user)
        });





$(document).on('click', '#newDelivery', function() {
    StartNewDelivery(phone_number);
});



}
let currentProgressStage = "";

function resolveProgressStatus(status) {
  switch (status) {
    case "delivered":
      return "delivered";
    case "picked_up":
      return "picked_up";
    case "submitted":
      return "submitted";
    default:
      return "awaiting";
  }
}

function updateProgressFill(rawStatus) {
  // 1) turn raw into one of your four keys
  const status = resolveProgressStatus(rawStatus);

  // 2) old pixel-width bar
  const progressFill = document.getElementById("progressFill");
  if (progressFill) {
    const progressOrder = ["awaiting", "submitted", "picked_up", "delivered"];
    const widths = {
      awaiting:  "90px",
      submitted: "170px",
      picked_up: "270px",
      delivered: "350px"
    };

    if (
      !currentProgressStage ||
      progressOrder.indexOf(status) >
        progressOrder.indexOf(currentProgressStage)
    ) {
      progressFill.style.width = widths[status] || "0px";
      currentProgressStage = status;
    }
  }

  // 3) icon-stepper flags
  const booleanProgress = {
    awaiting:  [ true,  true, false, false, false ],
    submitted: [ true,  true,  true,  false, false ],
    picked_up: [ true,  true,  true,  true,  false ],
    delivered: [ true,  true,  true,  true,  true  ]
  };

  const flags = booleanProgress[status] || [false, false, false, false, false];

  // 4) pass all five flags into goToStep
  //    (assigned, paid, submitted, pickedUp, droppedOff)
  goToStep(flags[0], flags[1], flags[2], flags[3], flags[4]);
}
/*
let currentProgressStage = "";

function resolveProgressStatus(status) {
  switch (status) {
    case "delivered":
      return "delivered";
    case "picked_up":
      return "picked_up";
    case "submitted":
      return "submitted";
    default:
      return "awaiting";
  }
}

function updateProgressFill(status) {
  const progressFill = document.getElementById("progressFill");
  if (!progressFill) return;

  const progressOrder = ["awaiting", "submitted", "picked_up", "delivered"];
  const widths = {
    awaiting:  "90px",
    submitted: "170px",
    picked_up: "270px",
    delivered: "350px"
  };

  // Map each step to a 4-flag array for goToStep
  const booleanProgress = {
    awaiting:  [ true,  true, false, false, false ],
    submitted: [ true,  true,  true, false, false ],
    picked_up: [ true,  true,  true,  true, false ],
    delivered: [ true,  true,  true,  true, true  ]
  };

  // 1) Advance the old width bar only if we’ve moved forward
  if (
    !currentProgressStage ||
    progressOrder.indexOf(status) >
      progressOrder.indexOf(currentProgressStage)
  ) {
    progressFill.style.width = widths[status] || "0px";
    currentProgressStage = status;
  }

  // 2) Always drive the 4-icon stepper
  const flags = booleanProgress[status] || [false, false, false, false];
  goToStep(flags[0], flags[1], flags[2], flags[3]);
}

*/
let data;
let delivery;
let addressPopulated = false;
/*
async function pollPaymentStatus() {
  const phoneNumber = phone_number;
  const endpoint = `/payment_status/?phone_number=${encodeURIComponent(phoneNumber)}`;
  const pollingInterval = 15000;
  const maxPollingIterations = 2000;

  let iterationCount = 0;

  while (iterationCount < maxPollingIterations) {
    try {
      const response = await fetch(endpoint);
      data = await response.json();
      courierToStore(data);
      const trackerButton2 = document.getElementById("tracker-button");
      const trackerSubtext = document.getElementById("tracker-subtext");
			     

      delivery = JSON.parse(data.delivery);
      const courierPhone = delivery[0].fields.courier_phone;
      getCouriers(courierPhone);			       
      const { status, destination_latitude: lat, destination_longitude: long } = delivery[0].fields;
if (!addressPopulated) {
  getClosestAddress(lat, long, (address) => {
    console.log(address, 'this is the address for the new geocoding from filtered locations');
    if (address) {
      addressPopulated = true; // ✅ Prevent it from firing again

      const streetName = extractStreetName(address);
	    document.getElementById("addressProgress").innerHTML =`<div>${destination_label}</div> ${streetName}`;


      const phoneLink = document.getElementById("phoneLink");
      const textLink = document.getElementById("textLink");

      if (phoneLink) phoneLink.href = `tel:${courierPhone}`;
      if (textLink) textLink.href = `sms:${courierPhone}`;
    }
  });
}



      // 🧭 Update delivery-level progress
      const resolvedStatus = resolveProgressStatus(status);
      updateProgressFill(resolvedStatus);


      if (status === "picked_up") {
        console.log("Order picked up");
        document.getElementById("step3").querySelector("svg path").style.fill = "black";
	updateProgressFill('picked_up'); 
      }

      if (status === "delivered") {
        console.log("Order delivered");

        ["step2", "step3", "step4"].forEach(step =>
          document.getElementById(step).querySelector("svg path").style.fill = "black"
        );
	console.log(trackerButton2, trackerSubtext); 
        trackerButton2.innerText = "Order Dropped Off";
        trackerSubtext.innerText = "See Dropoff section for courier notes";
	       const updatedBreaks = {
                   top: { enabled: true, height: window.innerHeight },
          middle: { enabled: false, height: 350, bounce: true },
          bottom: { enabled: false, height: 200 }		       
    };

    trackerPane.setBreakpoints(updatedBreaks);
    trackerPane.present({ animate: true });      
        trackerPane.moveToBreak('top');
        document.getElementById("newDelivery").style.display = "inline-block";
      }
// 📦 Order-by-order updates
const ordersArray = JSON.parse(data.orders);
const modal = document.getElementById("paneModal");
if (ordersArray?.length && (!modal || modal.style.display === "none")) {
  updateOrderForms(ordersArray);
}
console.log('this is the form data from pollingPaymentStatus function', data.orders); 
if (ordersArray?.length) {
  const totalOrders = ordersArray.length;
  let submittedCount = 0;
  let pickedUpCount = 0;

  ordersArray.forEach(order => {
    const store = order.fields.store_name;
    const hasScreenshot = order.fields.order?.trim() !== "";
    const hasPickup = order.fields.status !== false;

    const marker = markers2[store];
    const uploadEl = document.getElementById(`${store.replace(/\s+/g, '')}UploadButton`);
    const orderImage = document.querySelector(`img[data-order-image="${store}IMG"]`);

    if (hasScreenshot) {
      submittedCount++;

      try {
        orderImage.src = `https://dtchtransport.com/media/${order.fields.order}`;
        Object.assign(orderImage.style, {
       //   height: "100%",
       //   width: "auto",
       //   maxHeight: "100%"
        });
	   const normalizedID2 = normalizeStoreName(store);
  const viewButton = document.getElementById(`${normalizedID2}-view`);
    
      
  if (viewButton) { 
    viewButton.style.display = "inline-block"; // or "flex" if styled that way
  }   
      } catch {}

      if (!hasPickup && marker.icon?.url !== "/static/bootstrap-icons/store_check.png") {
        const uncheck = new google.maps.MarkerImage("/static/bootstrap-icons/store_uncheck.png", new google.maps.Size(0, 0));
        marker.setIcon(uncheck);
   //     uploadEl.querySelector("img").src = "/static/bootstrap-icons/store_uncheck.png";
	      markOrderAsSubmitted(store);  
const statusDiv = document.getElementById(`${store.replace(/\s+/g, '')}StatusDiv`);

	      
   statusDiv.innerHTML = `
  <div class="inline-flex items-center gap-2 px-3 py-1 text-sm font-semibold bg-red-50 text-red-600 border border-red-300 rounded-md shadow-sm">
    <i class="fas fa-times-circle text-red-500"></i>
    <span>Awaiting Pickup Confirmation</span>
  </div>
`; 
      }
    }else {uploadEl.style.visibility ="visible";} 

    if (hasPickup) {
      pickedUpCount++;

      const checkIcon = new google.maps.MarkerImage("/static/bootstrap-icons/store_check.png", new google.maps.Size(0, 0));
      marker.setIcon(checkIcon);
markOrderAsPickedUp(store);
const statusDiv = document.getElementById(`${store.replace(/\s+/g, '')}StatusDiv`);
if (statusDiv) statusDiv.style.display = "none";	    
    }
  });

  // 🧮 Update counters
  const submitCounter = document.getElementById("submit-counter");
  const pickupCounter = document.getElementById("pickup-counter");
  if (submitCounter) submitCounter.textContent = `(${submittedCount}/${totalOrders})`;
  if (pickupCounter) pickupCounter.textContent = `(${pickedUpCount}/${totalOrders})`;

  // ✅ Progress logic
  if (submittedCount === totalOrders) {
    document.getElementById("step2").querySelector("svg path").style.fill = "black";
    updateProgressFill("submitted");
if (trackerButton2.innerText !== "Order Dropped Off") {
  trackerButton2.innerText = "Heading to pickup";
  trackerSubtext.innerText = "Thanks for submitting order information";
}
    if (pickedUpCount === totalOrders) {
      document.getElementById("step3").querySelector("svg path").style.fill = "black";
      updateProgressFill("picked_up");
if (trackerButton2.innerText !== "Order Dropped Off") {
    trackerButton2.innerText = "Heading to dropoff";
    trackerSubtext.innerText = "See dropoff section for estimated time of arrival";
}
    }
  }
}
      iterationCount++;
      await new Promise(resolve => setTimeout(resolve, pollingInterval));
    } catch (error) {
      console.error("Error fetching payment status:", error);
    }
  }

  console.log("Polling completed.");
}
//pollPaymentStatus();

*/

//////////////////End of Delivery Updates

/*
function getRowForCheckbox(checkbox) {
  if (!checkbox || !checkbox.id) return null;
  const parentId = checkbox.id.replace("store-checkbox-", "");
  return document.querySelector(`tr[data-parent-id="${parentId}"]`);
}
let lastTotalPrice = 0;

function animatePriceChange(targetAmount) {
  const totalPriceEl = document.getElementById("totalPrice");
  const duration = 600;
  const stepTime = 15;
  const steps = Math.ceil(duration / stepTime);
  const increment = (targetAmount - lastTotalPrice) / steps;

  let currentValue = lastTotalPrice;
  let step = 0;

  const interval = setInterval(() => {
    step++;
    currentValue += increment;

    if (step >= steps) {
      currentValue = targetAmount;
      clearInterval(interval);

      // 💫 Pulse AFTER counter is complete
      totalPriceEl.classList.remove("updated");
      totalPriceEl.classList.add("updated");
      setTimeout(() => {
        totalPriceEl.classList.remove("updated");
      }, 300); // match your pulse duration
    }

    totalPriceEl.textContent = `Total: $${currentValue.toFixed(2)}`;
  }, stepTime);

  lastTotalPrice = targetAmount;
}
function dynamicPricing() {
  let touchLocked = false;

  const checkedItemsContainer = document.querySelector(".checked-items");
  const checkedContainer = document.getElementById("checkedContainer");
  const tableBody = document.querySelector(".storeForm tbody");
  const checkboxes = document.querySelectorAll(".storeForm input[type='checkbox']");

  checkboxes.forEach((checkbox) => {
    checkbox.addEventListener("change", function () {
      const parent = checkbox.closest(".checkbox-container");
      if (touchLocked || !parent) return;

      touchLocked = true;
      document.body.classList.add('touch-lock');

      const submitStores = document.getElementById('submitStores');
      const changeAddress = document.getElementById('changeAddress');
      const changeInstructions = document.getElementById('changeInstructions');

      setTimeout(() => {
        parent.classList.add("moving");

        setTimeout(() => {
          if (checkbox.checked) {
            checkedItemsContainer.appendChild(parent);
          } else {
            const row = getRowForCheckbox(checkbox);
            if (row) {
              const td = row.querySelector("td");
              if (td) td.appendChild(parent);
              row.style.display = "table-row";
            }
          }

          parent.classList.remove("moving");

          const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
          if (checkedCount > 0) {
            checkedContainer.classList.add('show');
            checkedItemsContainer.style.display = 'block';
            changeAddress.style.display = 'none';
            changeInstructions.style.display = 'block';
       //     submitStores.style.display = 'block';
          } else {
            checkedContainer.classList.remove('show');
            checkedItemsContainer.style.display = 'none';
            changeAddress.style.display = 'block';
            changeInstructions.style.display = 'none';
            submitStores.style.display = 'none';
          }
        }, 350); // allow move animation
      }, 100); // buffer after click

      const checkedCheckboxes = Array.from(checkboxes).filter(cb => cb.checked);
      const storeNames = checkedCheckboxes.map(cb => cb.getAttribute("name"));

      fetch("/dynamic/", {
        method: "POST",
        body: JSON.stringify({ storeNames, phone_number }),
        headers: { "Content-Type": "application/json" },
      })
        .then(response => response.json())
        .then(data => {
          const { distance, store_prices } = data;
          const totalPriceFromPrices = store_prices.reduce((acc, price) => acc + parseFloat(price), 0);
          const additionalCost = distance * 2.50;
          const totalPrice = totalPriceFromPrices + additionalCost;

          document.getElementById("stat-price").textContent = `$${totalPrice.toFixed(2)}`;
          document.getElementById("stat-distance").textContent = `${distance.toFixed(2)} mi`;
          document.getElementById("stat-add").textContent = `+ $${additionalCost.toFixed(2)} =`;

          animatePriceChange(totalPrice);

          const statisticsOverlay = document.getElementById('statistics-overlay');
          statisticsOverlay.style.display = totalPrice > 0 && totalPrice !== 'n/a' ? 'flex' : 'none';

          return plotPointsAndDrawRoute(data.destination_point, data.pickup_points);
        })
        .then(() => {
          updateButtonsFromMarkers(markers3, checkbox);
        })
        .catch(error => {
          console.error("Error sending data to the server:", error);
        })
        .finally(() => {
          setTimeout(() => {
            document.body.classList.remove('touch-lock');
            touchLocked = false;
          }, 400);
        });
    });
  });
}
*/
function toRad(degrees) {
  return degrees * Math.PI / 180;
}

function haversineDistance([lat1, lon1], [lat2, lon2]) {
  const R = 6371; // Earth radius in km
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat / 2) ** 2 +
            Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
            Math.sin(dLon / 2) ** 2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

function findNearestNeighbor(start, points) {
  return points.reduce((nearest, point) => {
    const d = haversineDistance(start, point);
    return d < nearest.distance ? { point, distance: d } : nearest;
  }, { point: null, distance: Infinity }).point;
}

function buildOptimizedRoute(destination, coords) {
  const route = [destination];
  const remaining = [...coords];

  while (remaining.length) {
    const next = findNearestNeighbor(route[route.length - 1], remaining);
    route.push(next);
    remaining.splice(remaining.findIndex(p => p[0] === next[0] && p[1] === next[1]), 1);
  }

  return route;
}

function calculateTotalDistance(points) {
  return points.reduce((sum, point, i) => {
    if (i === 0) return 0;
    return sum + haversineDistance(points[i - 1], point);
  }, 0);
}

function getRowForCheckbox(checkbox) {
  if (!checkbox || !checkbox.id) return null;
  const parentId = checkbox.id.replace("store-checkbox-", "");
  return document.querySelector(`tr[data-parent-id="${parentId}"]`);
}
function updateStoreUI(storeName, totalPrice) {
  const row = Array.from(document.querySelectorAll("tr[data-parent-id]")).find(tr => {
    const input = tr.querySelector("input[type='checkbox']");
    return input?.getAttribute("name")?.toLowerCase() === storeName.toLowerCase();
  });

  if (!row) return;

  const storeId = row.getAttribute("data-parent-id");
  const expandButton = document.getElementById(`${storeId}Button`);
  if (expandButton) expandButton.textContent = `$${totalPrice.toFixed(2)}`;

  const priceCell = row.querySelector(".store-price");
  if (priceCell) priceCell.textContent = `$${totalPrice.toFixed(2)}`;
}
let lastTotalPrice = 0;

function animatePriceChange(targetAmount) {
  const totalPriceEl = document.getElementById("totalPrice");
  const duration = 600;
  const stepTime = 15;
  const steps = Math.ceil(duration / stepTime);
  const increment = (targetAmount - lastTotalPrice) / steps;

  let currentValue = lastTotalPrice;
  let step = 0;

  const interval = setInterval(() => {
    step++;
    currentValue += increment;

    if (step >= steps) {
      currentValue = targetAmount;
      clearInterval(interval);

      totalPriceEl.classList.remove("updated");
      totalPriceEl.classList.add("updated");
      setTimeout(() => totalPriceEl.classList.remove("updated"), 300);
    }

    totalPriceEl.textContent = `Total: $${currentValue.toFixed(2)}`;
  }, stepTime);

  lastTotalPrice = targetAmount;
}

function applyDynamicPricing() {
  const allStores = jsOpenStores.map(store => ({
    ...store,
    latitude: parseFloat(store.store_latitude),
    longitude: parseFloat(store.store_longitdue),
    basePrice: parseFloat(store.delivery_price)
  }));

  const { lat: userLatitude, lng: userLongitude } = initialMarker.position;
  const destination = [userLatitude, userLongitude];

  const checkboxes = document.querySelectorAll(".storeForm input[type='checkbox']");
  const checkedNames = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.name);

  if (checkedNames.length === 0) {
    allStores.forEach(store => {
      const storeCoord = [store.latitude, store.longitude];
      const distanceMi = haversineDistance(storeCoord, destination) * 0.6214;
      const distanceFee = distanceMi * 2.5;
      const totalPrice = store.basePrice + distanceFee;
      updateStoreUI(store.store_name, totalPrice);
    });

    document.getElementById("stat-price").textContent = "$0.00";
    document.getElementById("stat-distance").textContent = "0.00 mi";
    document.getElementById("stat-add").textContent = "+ $0.00 =";
    document.getElementById("statistics-overlay").style.display = "none";
    animatePriceChange(0);
    return;
  }

  const selectedStores = allStores.filter(store => checkedNames.includes(store.store_name));
  const selectedCoords = selectedStores.map(s => [s.latitude, s.longitude]);
  const route = buildOptimizedRoute(destination, selectedCoords);
  const routeKm = calculateTotalDistance(route);
const pickupPoints = selectedStores.map(store => ({
  latitude: store.latitude,
  longitude: store.longitude,
  store_name: store.store_name
}));	
const destinationObj = {
  latitude: destination[0],
  longitude: destination[1]
};
plotPointsAndDrawRoute(destinationObj, pickupPoints)
  .then(() => {
    updateButtonsFromMarkers(); // or pass storeCheckbox if needed
  })
  .catch(error => {
    console.error("Route drawing failed:", error);
  });


	
  const routeMi = routeKm * 0.6214;
  const totalDistanceFee = routeMi * 2.5;
  const perStoreFee = totalDistanceFee / selectedStores.length;

  selectedStores.forEach(store => {
    const totalPrice = store.basePrice + perStoreFee;
    updateStoreUI(store.store_name, totalPrice);
  });

  const uncheckedStores = allStores.filter(store => !checkedNames.includes(store.store_name));
  uncheckedStores.forEach(store => {
    const storeCoord = [store.latitude, store.longitude];
    const distanceMi = haversineDistance(storeCoord, destination) * 0.6214;
    const distanceFee = distanceMi * 2.5;
    const totalPrice = store.basePrice + distanceFee;
    updateStoreUI(store.store_name, totalPrice);
  });

  const grandTotal = selectedStores.reduce((sum, store) => sum + store.basePrice + perStoreFee, 0);
  animatePriceChange(grandTotal);

  document.getElementById("stat-price").textContent = `$${grandTotal.toFixed(2)}`;
  document.getElementById("stat-distance").textContent = `${routeMi.toFixed(2)} mi`;
  document.getElementById("stat-add").textContent = `+ $${totalDistanceFee.toFixed(2)} =`;
  document.getElementById("statistics-overlay").style.display = grandTotal > 0 ? "flex" : "none";
}

function refreshDeliveryUI() {
  const checkboxes = document.querySelectorAll(".storeForm input[type='checkbox']");
  const checkedNames = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.name);

  const allStores = jsOpenStores.map(store => ({
    ...store,
    latitude: parseFloat(store.store_latitude),
    longitude: parseFloat(store.store_longitdue),
    basePrice: parseFloat(store.delivery_price)
  }));

  const selectedStores = allStores.filter(store => checkedNames.includes(store.store_name));
  const uncheckedStores = allStores.filter(store => !checkedNames.includes(store.store_name));

  const destination = {
    latitude: initialMarker.position.lat,
    longitude: initialMarker.position.lng
  };

  if (selectedStores.length === 0) {
    // ⛔ No selections — wipe route & markers
    if (routePolyline) {
      routePolyline.setMap(null);
      routePolyline = null;
    }
    markers3.forEach(marker => marker.setMap(null));
    markers3 = [];

    uncheckedStores.forEach(store => {
      const storeCoord = [store.latitude, store.longitude];
      const distanceMi = haversineDistance(storeCoord, [destination.latitude, destination.longitude]) * 0.6214;
      const distanceFee = distanceMi * 2.5;
      const totalPrice = store.basePrice + distanceFee;
      updateStoreUI(store.store_name, totalPrice);
    });

    document.getElementById("stat-price").textContent = "$0.00";
    document.getElementById("stat-distance").textContent = "0.00 mi";
    document.getElementById("stat-add").textContent = "+ $0.00 =";
    document.getElementById("statistics-overlay").style.display = "none";
    animatePriceChange(0);

    updateButtonsFromMarkers(); // clears Swiper
    return;
  }

  // 🛣️ Generate route
  const selectedCoords = selectedStores.map(s => [s.latitude, s.longitude]);
  const pickupPoints = selectedStores.map(store => ({
    latitude: store.latitude,
    longitude: store.longitude,
    store_name: store.store_name
  }));

  const route = buildOptimizedRoute([destination.latitude, destination.longitude], selectedCoords);
  const routeKm = calculateTotalDistance(route);
  const routeMi = routeKm * 0.6214;
  const totalDistanceFee = routeMi * 2.5;
  const perStoreFee = totalDistanceFee / selectedStores.length;

  selectedStores.forEach(store => {
    const totalPrice = store.basePrice + perStoreFee;
    updateStoreUI(store.store_name, totalPrice);
  });

  uncheckedStores.forEach(store => {
    const storeCoord = [store.latitude, store.longitude];
    const distanceMi = haversineDistance(storeCoord, [destination.latitude, destination.longitude]) * 0.6214;
    const distanceFee = distanceMi * 2.5;
    const totalPrice = store.basePrice + distanceFee;
    updateStoreUI(store.store_name, totalPrice);
  });

  const grandTotal = selectedStores.reduce((sum, store) => sum + store.basePrice + perStoreFee, 0);
  animatePriceChange(grandTotal);
  document.getElementById("stat-price").textContent = `$${grandTotal.toFixed(2)}`;
  document.getElementById("stat-distance").textContent = `${routeMi.toFixed(2)} mi`;
  document.getElementById("stat-add").textContent = `+ $${totalDistanceFee.toFixed(2)} =`;
  document.getElementById("statistics-overlay").style.display = grandTotal > 0 ? "flex" : "none";

  // 📍 Draw route + update Swiper
  plotPointsAndDrawRoute(destination, pickupPoints).then(() => {
    updateButtonsFromMarkers();
  });
}	
function dynamicPricing() {
  let touchLocked = false;

  const checkedItemsContainer = document.querySelector(".checked-items");
  const checkedContainer = document.getElementById("checkedContainer");
  const tableBody = document.querySelector(".storeForm tbody");
  const checkboxes = document.querySelectorAll(".storeForm input[type='checkbox']");

  checkboxes.forEach((checkbox) => {
    checkbox.addEventListener("change", function () {
      const parent = checkbox.closest(".checkbox-container");
      if (touchLocked || !parent) return;

      touchLocked = true;
      document.body.classList.add('touch-lock');

      const submitStores = document.getElementById('submitStores');
      const changeAddress = document.getElementById('changeAddress');
      const changeInstructions = document.getElementById('changeInstructions');

      setTimeout(() => {
        parent.classList.add("moving");

        setTimeout(() => {
          if (checkbox.checked) {
            checkedItemsContainer.appendChild(parent);
	     parent.classList.add("checked"); 
          } else {
	      parent.classList.remove("checked"); 
            const row = getRowForCheckbox(checkbox);
            if (row) {
              const td = row.querySelector("td");
              if (td) td.appendChild(parent);
              row.style.display = "table-row";
            }
          }

          parent.classList.remove("moving");

          const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
          if (checkedCount > 0) {
            checkedContainer.classList.add('show');
            checkedItemsContainer.style.display = 'block';
            changeAddress.style.display = 'none';
            changeInstructions.style.display = 'block';
       //     submitStores.style.display = 'block';
          } else {
            checkedContainer.classList.remove('show');
            checkedItemsContainer.style.display = 'none';
            changeAddress.style.display = 'block';
            changeInstructions.style.display = 'none';
            submitStores.style.display = 'none';
          }
            refreshDeliveryUI();

          // 🔄 Compute and apply pricing updates
        }, 350);
      }, 100);

      setTimeout(() => {
        document.body.classList.remove('touch-lock');
        touchLocked = false;
      }, 300);
    });
  });
}
	

	    function plotDeliveryAfter(storeNames){
	    
	    const serverUrl2 = "/dynamic/";
            fetch(serverUrl2, {
                method: "POST",
                    body: JSON.stringify({storeNames, phone_number}),
                headers: {
                    "Content-Type": "application/json",
                },
            })
                .then((response) => response.json())
                .then((data) => {
                    // Handle the server response if needed.
                    console.log("Server response:", data);
                    console.log('this is the selected store data');
                    console.log(data);
                 //plotPointsAndDrawLine(data.destination_point, data.pickup_points)
	          plotPointsAndDrawRoute(data.destination_point, data.pickup_points)		
                })
                .catch((error) => {
                    console.error("Error sending data to the server:", error);
                });

	    }

let markers3 = [];
let markers4 = []; 
let polyline;
let count = 0;
let animationInterval;
let storeSwiper;
function updateButtonsFromMarkers() {




    const container = document.getElementById('selectedStoresContainer');
    if (!container) {
        console.error('selectedStoresContainer not found.');
        return;
    }

    // Ensure Swiper wrapper exists
    let wrapper = container.querySelector('.swiper-wrapper');
    if (!wrapper) {
        wrapper = document.createElement('div');
        wrapper.className = 'swiper-wrapper';
        container.appendChild(wrapper);
    }

    // Clear previous slides
    wrapper.innerHTML = '';

markers3.forEach((marker, index) => {



    const storeName = marker.title || `Store ${index + 1}`;
    const { lat, lng } = marker.position;


const matchedStore = jsOpenStores.find(store => store.store_name === storeName);
const imageUrl = matchedStore?.link_image
  ? `/media/${matchedStore.link_image}`
  : matchedStore?.external_image_link || null;

// Container for each item
const itemContainer = document.createElement('div');
itemContainer.style.display = 'flex';
itemContainer.style.alignItems = 'center';
itemContainer.style.gap = '5px'; // spacing between image and text

// 🖼️ Left side: store image
const imageWrapper = document.createElement('div');
imageWrapper.style.display = 'flex';
imageWrapper.style.alignItems = 'center';
imageWrapper.style.justifyContent = 'center';
imageWrapper.style.width = '50px';
imageWrapper.style.height = '50px';
imageWrapper.style.flexShrink = '0';

const storeImg = document.createElement('img');
storeImg.src = imageUrl || '/static/default-store.png'; // fallback
storeImg.alt = storeName;
storeImg.style.width = '100%';
storeImg.style.height = '100%';
storeImg.style.objectFit = 'cover';
storeImg.style.borderRadius = '50%'; // circular image
storeImg.style.border = '2px solid #2563eb'; // optional blue border

imageWrapper.appendChild(storeImg);

// 📄 Middle: name and address
const nameAddressWrapper = document.createElement('div');
nameAddressWrapper.style.display = 'flex';
nameAddressWrapper.style.flexDirection = 'column';
nameAddressWrapper.style.width ="220px"


const storeLabel = document.createElement('span');
storeLabel.textContent = storeName;
storeLabel.style.fontSize = '18px';
storeLabel.style.fontWeight = '500';

const addressLabel = document.createElement('div');
addressLabel.className = 'store-address';
addressLabel.innerHTML = 'Looking up address...';

nameAddressWrapper.appendChild(storeLabel);
nameAddressWrapper.appendChild(addressLabel);

// 🗑️ Right side: delete button
const buttonWrapper = document.createElement('div');
buttonWrapper.style.display = 'flex';
buttonWrapper.style.alignItems = 'center';
buttonWrapper.style.justifyContent = 'center';

const button = document.createElement('button');
button.className = 'delete-store';
button.setAttribute('data-store', storeName);
button.style.background = 'transparent';
button.style.border = 'none';
button.style.cursor = 'pointer';
button.style.padding = '10px'

const closeIcon = document.createElement('i');
closeIcon.className = 'fa fa-trash';
button.appendChild(closeIcon);
buttonWrapper.appendChild(button);

// 📦 Assemble the container
itemContainer.appendChild(imageWrapper);
itemContainer.appendChild(nameAddressWrapper);
itemContainer.appendChild(buttonWrapper);


button.addEventListener('click', () => {
  const checkbox = document.querySelector(`input[type="checkbox"][value="${storeName}"]`);
  if (checkbox) checkbox.click();

  const footerElement = document.querySelector('.footer');
  const submitStores = document.getElementById('submitStores');
  const swiperPaginationStores = document.getElementById("swiperPaginationStores");
  const dropContainer = document.getElementById("dropContainer"); // ✅ ensure this exists

  const observer = new MutationObserver(() => {
    const hasStores = wrapper.children.length > 0;
    observer.disconnect();

    footerElement.style.display = 'flex';

    if (hasStores) {
      submitStores.innerHTML = '<i class="fa fa-paper-plane"></i> Post Delivery';
      submitStores.className = "w-full max-w-[90%] mx-auto bg-green-500 text-white text-base font-semibold rounded-lg h-14 flex items-center justify-center";
    } else {
      submitStores.innerHTML = 'No Pick-ups Selected';
      submitStores.className = 'inactiveButton';
      swiperPaginationStores.className = "swiper-pagination-stores";
      swiperPaginationStores.innerHTML = `
        <p class="text-gray-500 flex items-center gap-2">
          <i class="fas fa-exclamation-triangle text-xl"></i>
          No stores selected
        </p>
      `;

      setTimeout(() => {
        swiperPaginationStores.classList.remove('swiper-pagination-lock');
      }, 1000);
    }

    // ✅ Handle dropContainer collapse state
    setTimeout(() => {
      const dropCollapsed = dropContainer?.classList.contains('fading-collapse');
      submitStores.style.display = dropCollapsed ? 'none' : 'block';
    }, 800);
  });

  observer.observe(wrapper, { childList: true });
});

    // Final assembly
    itemContainer.appendChild(nameAddressWrapper);
    itemContainer.appendChild(buttonWrapper);

    const slide = document.createElement('div');
    slide.className = 'swiper-slide';
    slide.appendChild(itemContainer);
    wrapper.appendChild(slide);

    // Address fetch with HTML injection
    getClosestAddress(lat, lng, (address) => {
        const streetname = extractStreetName(address); // returns raw HTML
        addressLabel.innerHTML = streetname || 'Address not found';
    });
});

    // Initialize or update Swiper
initializeStoreSwiper();	
}
let routePolyline = null;
 function plotPointsAndDrawRoute(destination, pickupPoints) {
  return new Promise((resolve) => {
    // Always clear existing polyline and markers
    if (routePolyline) {
      routePolyline.setMap(null);
      routePolyline = null;
    }

    clearMarkers3();
    pickupPoints.forEach(point => {

  const matchedStore = jsOpenStores.find(store => store.store_name === point.store_name);
  const imageUrl = matchedStore?.link_image
    ? `/media/${matchedStore.link_image}`
    : matchedStore?.external_image_link || null;

 if (!imageUrl) return done(null);


      if (point?.latitude && point?.longitude) {
        addMarker({ lat: point.latitude, lng: point.longitude }, point.store_name, imageUrl);
      }
    });




		  

    // Skip routing if there are fewer than 2 valid points
    const pickupCoords = pickupPoints
      .filter(p => p && p.longitude && p.latitude)
      .map(p => [p.longitude, p.latitude]);

    const destinationCoord = [destination.longitude, destination.latitude];
    const allCoords = [...pickupCoords, destinationCoord];

    if (allCoords.length < 2) {
      console.log("Not enough points to draw a route.");
      resolve("No route drawn");
      return;
    }

    const coordString = allCoords.map(coord => coord.join(',')).join(';');
    const url = `https://router.project-osrm.org/route/v1/driving/${coordString}?overview=full&geometries=geojson`;

    fetch(url)
      .then(res => res.json())
      .then(data => {
        if (data.code !== 'Ok' || !data.routes?.[0]) {
          throw new Error("Invalid OSRM response");
        }

        const routeCoords = data.routes[0].geometry.coordinates;
        if (!routeCoords || !routeCoords.length) {
          throw new Error("Empty route geometry");
        }

        const latLngPath = routeCoords.map(([lng, lat]) => ({ lat, lng }));
/*
        routePolyline = new google.maps.Polyline({
          path: latLngPath,
          geodesic: true,
          strokeColor: '#007bff',
          strokeOpacity: 0.8,
          strokeWeight: 4,
          map: map
        });
*/
routePolyline = new google.maps.Polyline({
  path: latLngPath,
  geodesic: true,
  strokeColor: '#333333', // modern dark gray
  strokeOpacity: 0.85,     // slightly translucent for depth
  strokeWeight: 5,         // slightly thicker for clarity
  zIndex: 2,               // ensure it sits above map roads
  map: map,
});

	      
        const totalDistance = data.routes[0].distance / 1000;
        console.log("Route Distance:", totalDistance.toFixed(2) + " km");

        resolve("Route drawn successfully");
      })
      .catch(err => {
        console.warn("OSRM fallback due to error:", err.message);
        plotPointsAndDrawLine(destination, pickupPoints).then(resolve);
      });
  });
}




function plotPickupMarkersOnly(destination, pickupPoints) {
  return new Promise((resolve) => {
    // Clear existing markers
    clearMarkers3();

    // Prepare LatLng for the destination
    const destinationLatLng = { lat: destination.latitude, lng: destination.longitude };

    // Prepare pickup locations with store names
    const pickupLatLngs = pickupPoints.map(point => ({
      lat: point.latitude,
      lng: point.longitude,
      store_name: point.store_name
    }));

    // Add markers for each pickup point
    pickupLatLngs.forEach(point => {
	   const matchedStore = jsOpenStores.find(store => store.store_name === point.store_name);
  const imageUrl = matchedStore?.link_image
    ? `/media/${matchedStore.link_image}`
    : matchedStore?.external_image_link || null;

 if (!imageUrl) return done(null);
   
      addMarker({ lat: point.lat, lng: point.lng }, point.store_name, imageUrl);
    });

    // Optionally add destination marker if desired
    // addMarker(destinationLatLng, 'Destination');

    // Auto-fit bounds to include all points
    const bounds = new google.maps.LatLngBounds();
    pickupLatLngs.forEach(point => bounds.extend(point));
    bounds.extend(destinationLatLng); // Optional: include destination in bounds
    map.fitBounds(bounds);

    setTimeout(() => {
      resolve('Pickup markers placed');
    }, 100);
  });
}
function plotPointsAndDrawLine(destination, pickupPoints) {
console.log('testintinginidgnskdnkajfklajflkad'); 
return new Promise((resolve) => {
	
    // Convert destination and pickup points to LatLngLiteral objects
      const destinationLatLng = { lat: destination.latitude, lng: destination.longitude };	
//      const pickupLatLngs = pickupPoints.map(point => ({ lat: point.latitude, lng: point.longitude}));
      const pickupLatLngs = pickupPoints.map(point => ({
        lat: point.latitude,
        lng: point.longitude,
        store_name: point.store_name // Include store_name
    }));	
    // Remove existing markers and polyline
    clearMarkers3();
    if (polyline) {
        polyline.setMap(null);
    }

    // Add the destination marker again
//      addMarker(destinationLatLng);
    // Add markers for pickup points
//    pickupLatLngs.forEach(point => {
//        addMarker(point);
//    });
    // Add the destination marker again
//    addMarker(destinationLatLng, 'destination'); // Use a generic image for the destination if needed

    // Add markers for pickup points
    pickupLatLngs.forEach(point => {
        addMarker({ lat: point.lat, lng: point.lng }, point.store_name);
    });

	
    const path = [destinationLatLng, ...pickupLatLngs];


// Function to calculate distance between two lat/lng points using Haversine formula
function getDistance(lat1, lng1, lat2, lng2) {
  const R = 6371; // Radius of Earth in km
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLng = (lng2 - lng1) * Math.PI / 180;
  const a =
    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLng / 2) * Math.sin(dLng / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c * 1000; // Convert to meters
}

// Calculate distances between consecutive points
let cumulativeDistances = [0]; // Start at zero distance
for (let i = 1; i < path.length; i++) {
  const prev = path[i - 1];
  const curr = path[i];
  const dist = getDistance(prev.lat, prev.lng, curr.lat, curr.lng);
  cumulativeDistances.push(cumulativeDistances[i - 1] + dist);
}

// Get total distance of the path
const totalDistance = cumulativeDistances[cumulativeDistances.length - 1];

// Generate icons with accurate percentage offsets
const icons = path.map((point, index) => ({
  icon: {
    path: google.maps.SymbolPath.CIRCLE,
    scale: 5,
    strokeColor: "#000000",
    fillColor: "#000000",
    fillOpacity: 1,
  },
  offset: `${(cumulativeDistances[index] / totalDistance) * 100}%`, // Distance-based placement
}));
/*
 polyline = new google.maps.Polyline({
  path: path,
  geodesic: true,
  strokeColor: "#000000",
  strokeOpacity: 1.0,
  strokeWeight: 4,
  zIndex: 1,
  icons: icons,
});

polyline.setMap(map);




// Fit the map bounds to include the entire polyline
    const bounds = new google.maps.LatLngBounds();
    path.forEach(point => {
        bounds.extend(point);
    });
    map.fitBounds(bounds);

        setTimeout(() => {
            resolve('First function complete'); // Resolving the Promise
        }, 100); 	
})

*/

 polyline = new google.maps.Polyline({
  path: path,
  geodesic: true,
  strokeOpacity: 0, // hide base stroke
  strokeWeight: 4,
  zIndex: 1,
  icons: [{
    icon: {
      path: 'M 0,-1 0,1', // dash pattern
      strokeOpacity: 1,
      strokeColor: '#333333', // modern dark gray
      scale: 4,
    },
    offset: '0',
    repeat: '20px',
  }],
});

polyline.setMap(map);

// Fit the map bounds to include the entire polyline
const bounds = new google.maps.LatLngBounds();
path.forEach(point => bounds.extend(point));
map.fitBounds(bounds);

// Animate the dash flow
let offset = 0;
const animateDash = () => {
  offset = (offset + 1) % 200;
  polyline.set('icons', [{
    icon: {
      path: 'M 0,-1 0,1',
      strokeOpacity: 1,
      strokeColor: '#333333',
      scale: 4,
    },
    offset: `${offset}px`,
    repeat: '20px',
  }]);
  requestAnimationFrame(animateDash);
};
animateDash();

// Resolve after short delay
setTimeout(() => {
  resolve('First function complete');
}, 100);		
})
}	
function clearMarkers3() {
    console.log("Clearing markers:", markers3.length);
    markers3.forEach(marker => {
        marker.setMap(null);
    });
    markers3 = [];
    console.log("Markers after clearing:", markers3.length);
    console.log("Clearing markers:", markers3.length);
    markers4.forEach(marker => {
        marker.setMap(null);
    });
    markers4 = [];
    console.log("Markers after clearing:", markers4.length);	
}

async function addMarker(location, storeName, linkImage) {
  if (!storeName || !location || !linkImage) return;

  // Load required library
  const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");

  const markerContent = buildHighlightedMarkerContent(storeName, linkImage);

  const marker = new google.maps.marker.AdvancedMarkerElement({
    map,
    content: markerContent,
    position: location,
    title: storeName,
    zIndex: 2,
  });

  markers3.push(marker);
}
function buildHighlightedMarkerContent(storeName, linkImage) {
  const container = document.createElement("div");
  container.classList.add("highlighted-marker");

  container.innerHTML = `
    <div class="highlighted-icon">
      <img class="highlighted-logo" src="${linkImage}" alt="${storeName}" />

            <div class="arrow-down1 mt-20">
      <i class="fas fa-caret-down text-blue-600 text-lg"></i>
    </div>
    </div>
    <div class="highlighted-label">${storeName}</div>
              <div class="courier-overlay-icon hidden">
          <i class="fas fa-bicycle"></i> 
           </div>


	
  `;

  return container;
}
/*
async function addMarker(location, storeName, linkImage) {
  if (!storeName || !location || !linkImage) return;

  const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");

  // Generate custom canvas icon
  createMarkerIcon(linkImage, (dataURL) => {
    const markerContent = buildMarkerContent(storeName, dataURL);

    const marker = new AdvancedMarkerElement({
      map,
      content: markerContent,
      position: location,
      title: storeName,
      zIndex: 2,
    });

    markers3.push(marker);
  });
}
*/
function toTitleCase(str) {
  return str.toLowerCase().replace(/\b\w/g, char => char.toUpperCase());
}

function extractStreetName(fullAddress) {
  console.log("Raw Address:", fullAddress);

  const parts = fullAddress.split(", ");

  if (parts.length >= 3) {
    return `
      <div class="street-name">${toTitleCase(parts[0])}</div>
      <div class="address-details">${parts[1].toUpperCase()}, ${parts[2].toUpperCase()}</div>
    `;
  } else {
    return `
      <div class="street-name">${toTitleCase(fullAddress)}</div>
      <div class="address-details">UNKNOWN LOCATION</div>
    `;
  }
}

if ('serviceWorker' in navigator && 'PushManager' in window) {
  window.addEventListener('load', function () {

    navigator.serviceWorker.ready.then(function (registration) {

      const modal = document.getElementById('notification-modal');
      const enableBtn = document.getElementById('enable-notifications');

      if (!enableBtn) {
        return;
      }

      const currentPermission = Notification.permission;
      const localOverride = localStorage.getItem('pushPermissionGranted');
      const serverPermission = false; // or dynamically fetch from API if needed
      console.log('🔍   Current notification permission: ' + currentPermission);

      const shouldPrompt =
        currentPermission === 'default' &&
        !localOverride &&
        !serverPermission;

      if (shouldPrompt && modal) {
        modal.classList.remove('hidden');
      } else {
        subscribeUser(registration);
      }

      enableBtn.addEventListener('click', function () {
        if (Notification.permission === 'default') {
          Notification.requestPermission().then(function (permission) {
            if (permission === 'granted') {
              localStorage.setItem('pushPermissionGranted', 'true');
              subscribeUser(registration);
            }
            if (modal) modal.classList.add('hidden');
          });
        } else if (Notification.permission === 'granted') {
          localStorage.setItem('pushPermissionGranted', 'true');
          subscribeUser(registration);
          if (modal) modal.classList.add('hidden');
        } else {
          if (modal) modal.classList.add('hidden');
        }
      });
    }).catch(function (error) {
      console.error('ServiceWorker not ready:', error);
    });
  });
}
/*
function subscribeUser(registration) {
    registration.pushManager.getSubscription().then(function(subscription) {
        if (subscription === null) {
            // Subscribe the user
            return registration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: urlBase64ToUint8Array('BKg-N9EzZT9vkq3lv8jg1012FDCGosPyeyHIEdyJLI4rI9ntBEks3upZFmO3u6MUjBUzKWq7wcuygsfkhD6tXhU')
            });
        }
        return subscription; // Already subscribed
    }).then(function(subscription) {
        if (subscription) {
            console.log('Subscription successful: ', subscription);
            // Save subscription details to your server
            fetch('/subscribe/', {
                method: 'POST',
                body: JSON.stringify({
                    phone_number: phone_number, // Replace with actual user's phone number
                    subscription_info: subscription
                }),
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken') // Include CSRF token if needed
                }
            }).then(function(response) {
                if (response.ok) {
                    console.log('Subscription saved successfully.');
                } else {
                    console.error('Failed to save subscription.');
                }
            }).catch(function(error) {
                console.error('Error saving subscription: ', error);
            });
        } else {
            console.error('Subscription is null after subscribing.');
        }
    }).catch(function(error) {
        console.log('Subscription failed: ', error);
    });
}

function urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding)
        .replace(/\-/g, '+')
        .replace(/_/g, '/');

    const rawData = window.atob(base64);
    const outputArray = new Uint8Array(rawData.length);

    for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
    }
    return outputArray;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}




*/

function subscribeUser(registration) {
  registration.pushManager.getSubscription().then(function (subscription) {
    if (!subscription) {
      return registration.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(
          'BKg-N9EzZT9vkq3lv8jg1012FDCGosPyeyHIEdyJLI4rI9ntBEks3upZFmO3u6MUjBUzKWq7wcuygsfkhD6tXhU'
        ),
      });
    }
    return subscription;
  }).then(function (subscription) {
    if (!subscription) {
      console.error('❌ Subscription is null after subscribing.');
      return;
    }

    console.log('✅ Subscription successful:', subscription);

    // Extract device info (optional, customize as needed)
    const deviceInfo = navigator.userAgent;

    // Send to backend
    fetch('/subscribe/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken'),
      },
      body: JSON.stringify({
	phone_number: phone_number,      
        subscription: subscription.toJSON(), // clean JSON format
        device_info: deviceInfo,
      }),
    }).then(function (response) {
      if (response.ok) {
        console.log('📬 Subscription saved successfully.');
      } else {
        console.error('❌ Failed to save subscription. Status:', response.status);
      }
    }).catch(function (error) {
      console.error('❌ Error sending subscription:', error);
    });
  }).catch(function (error) {
    console.error('❌ Subscription failed:', error);
  });
}

function urlBase64ToUint8Array(base64String) {
  const padding = '='.repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding)
    .replace(/-/g, '+')
    .replace(/_/g, '/');

  const rawData = window.atob(base64);
  const outputArray = new Uint8Array(rawData.length);

  for (let i = 0; i < rawData.length; ++i) {
    outputArray[i] = rawData.charCodeAt(i);
  }
  return outputArray;
}
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === name + '=') {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}	   








function CancelDelivery(phoneNumber) {
    cancelPane.destroy();  
    document.getElementById('loading-text').innerHTML = 'Canceling Delivery';
    document.getElementById('overlay-container').style.display = 'flex';

setTimeout(function() {    
	$.ajax({
        url: '/reset/',
        type: 'POST',
        data: { phone_number: phoneNumber },
        success: function(response) {
            // Handle success (e.g., show a success message)
            console.log('Database updated successfully:', response);
            // Redirect to another page (if needed)
            window.location.href = '/app/map/' + phoneNumber;
        },
        error: function(xhr, status, error) {
            // Handle error (e.g., show an error message)
            console.error('Error updating database:', error);
        }
    });
	}, 2000);
}




function StartNewDelivery(phoneNumber) {
document.getElementById('loading-text').innerHTML='Starting New Delivery';
document.getElementById('overlay-container').style.display = 'flex'; 
       $.ajax({
        url: '/reset/',
        type: 'POST',
        data: { phone_number: phoneNumber },
        success: function(response) {
            // Handle success (e.g., show a success message)
            console.log('Database updated successfully:', response);
            // Redirect to another page (if needed)
            window.location.href = '/app/map/' + phoneNumber;
        },
        error: function(xhr, status, error) {
            // Handle error (e.g., show an error message)
            console.error('Error updating database:', error);
        }
    });
}


var markers = []; // Define the markers array at the global level
var customOverlays = []; // Define the custom overlay array

function moveMarker(marker, newLat, newLng) {
    const deltaLat = (newLat - marker.getPosition().lat()) / 100;
    const deltaLng = (newLng - marker.getPosition().lng()) / 100;
    let i = 0;

    function animateMarker() {
        if (i < 100) {
            marker.setPosition({
                lat: marker.getPosition().lat() + deltaLat,
                lng: marker.getPosition().lng() + deltaLng
            });
            i++;
            requestAnimationFrame(animateMarker);
        }
    }

    animateMarker();
}




function getDistanceInFeet(lat1, lng1, lat2, lng2) {
  const R = 6371000; // meters
  const toRad = deg => deg * (Math.PI / 180);

  const dLat = toRad(lat2 - lat1);
  const dLng = toRad(lng2 - lng1);

  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
    Math.sin(dLng / 2) ** 2;

  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  const meters = R * c;

  return meters * 3.28084;
}



function checkCourierProximity(courier) {
  const store = markers3?.[0];
  const destination = initialMarker;

  if (!store || !courier || !destination) return;

  const courierPos = courier.position;
  const storePos = store.position;
  const destinationPos = destination.position;

  const storeDistance = getDistanceInFeet(
    storePos.lat, storePos.lng,
    courierPos.lat(), courierPos.lng()
  );

  const destinationDistance = getDistanceInFeet(
    destinationPos.lat, destinationPos.lng,
    courierPos.lat(), courierPos.lng()
  );

  const zoom = map.getZoom();
  const shouldHide = zoom < 15 && (storeDistance <= 600 || destinationDistance <= 600);

  const marker = advancedMarkers[0]; // assumes this is the courier's AdvancedMarkerElement

  if (shouldHide) {
    console.log(`🚫 Courier within ${Math.round(Math.min(storeDistance, destinationDistance))}ft — hiding marker`);
    marker.element.classList.add('hidden');

    if (storeDistance <= 600 && store.content) {
      store.content.classList.add('courier-present');
    }

    if (destinationDistance <= 600 && destination.content) {
      destination.content.classList.add('courier-present');
    }
  } else {
    // Unhide if zoomed in or courier is far enough
    marker.element.classList.remove('hidden');

    if (store.content) {
      store.content.classList.remove('courier-present');
    }

    if (destination.content) {
      destination.content.classList.remove('courier-present');
    }
  }
}








let courierMarkers = []; // Store standard Google Maps markers for clustering
let  advancedMarkers = []; // Store AdvancedMarkerElements separately
let markerCluster; // Global variable to hold cluster instance
function getCouriers(targetPhone = "all") {
  const homeMarkerPosition = initialMarker.position;
  const customRenderer = {
    render: function({ count, position }) {
      const zoomLevel = map.getZoom();
      const distance = google.maps.geometry.spherical.computeDistanceBetween(position, homeMarkerPosition);

      const offsetLatLng = (distance < 100 || zoomLevel < 12)
        ? new google.maps.LatLng(position.lat() + 0.001, position.lng() + 0.001)
        : position;

      const clusterElement = document.createElement('div');
      clusterElement.className = 'custom-cluster';
      clusterElement.innerText = `${count}`;

      return new google.maps.marker.AdvancedMarkerElement({
        position: offsetLatLng,
        content: clusterElement
      });
    }
  };
  $.ajax({
    url: '/active/',
    type: 'POST',
    data: { customer_number: phone_number },
    success: function(response) {
      console.log('Courier data received:', response);
      const couriers = response.couriers;

      setTimeout(() => {
        const totalCount = couriers.length;
        const pendingCount = couriers.filter(c => c.pending).length;
        updateCourierCount(totalCount);
        updatePendingCourierCount(pendingCount, totalCount);
      }, 1000);

      // 🧩 Swiper UI logic
      if (smsSequence === "SEND_SCREENSHOT") {
	

	 targetPhone = couriers.find(c => c.courier_phone === response.delivery.courier_phone).courier_phone;
}
        console.log('this is the targetPhone', targetPhone); 
        if (!swiper) initializeCourierSwiper();

        const swiperContainer = document.getElementById('courierList');
        const swiperWrapper = swiperContainer.querySelector(".swiper-wrapper");
        const pendingCouriers = couriers.filter(c => c.pending);




if (swiperWrapper) {
const existingSlides = swiperWrapper.querySelectorAll(".swiper-slide");

existingSlides.forEach(slide => {
  if (slide.classList.contains("no-courier-slide")) return;

  const courierID = slide.getAttribute("data-courier-id");
  const stillPending = couriers.some(c => String(c.courier_id) === courierID && c.pending);	

  if (!stillPending) {
    slide.remove();
  }
});	
  const isPaid = response.delivery && response.delivery.status !== "unpaid";
  document.getElementById('courierPagination').style.display = isPaid ? 'none' : 'block';

  if (isPaid) {
    // ✅ PAID COURIER SLIDE
    const matchedCourier = couriers.find(c => c.courier_id === response.delivery.matched_courier_id);
    if (matchedCourier) {
const alreadyExists = swiperWrapper.querySelector(`[data-courier-id="${matchedCourier.courier_id}"]`);
const matchedCourierContent = alreadyExists?.querySelector("#matchedCourierContent");

if (alreadyExists && matchedCourierContent) {
  console.log("Paid courier slide already exists and is complete:", matchedCourier.courier_id);
  return;
}

      const courierSlide = document.createElement("div");
      courierSlide.classList.add("swiper-slide");
      courierSlide.setAttribute("data-courier-id", matchedCourier.courier_id);
      courierSlide.innerHTML = `
	 <div style="display: flex; flex-direction: row; gap: 20px; align-items: flex-start;">
  <!-- Left Column: Name, ID, Badges -->
  <div style="display: flex; flex-direction: column; flex: 1;">
    <span style="font-size: 18px; font-weight: 500;">James Morrow</span>
    <div class="store-address">
      <div class="street-name">CourierID: ${matchedCourier.courier_id}</div>
    </div>
  </div>

  <!-- Right Column: Call, Text, Locate, Pay -->
  <div id="matchedCourierContent" style="display: flex; flex-direction: column; align-items: flex-start; gap: 10px;">
    <div style="display: flex; flex-direction: row; gap: 10px;">
      <a href="tel:${response.delivery.courier_phone}" class="pending-courier-icon">
        <i class="fa-solid fa-phone"></i> Call
      </a>
      <a href="sms:${response.delivery.courier_phone}" class="pending-courier-icon">
        <i class="fa-solid fa-comment-dots"></i> Text
      </a>
    </div>
    <a href="#" data-lat="${matchedCourier.courier_latitude}" data-lng="${matchedCourier.courier_longitude}" class="pending-courier-locate">
      <i class="fa-solid fa-map-marker-alt"></i> Locate
    </a>
  </div>
</div>   
      `;
      swiperWrapper.appendChild(courierSlide);
	document.getElementById('courierList').style.opacity = '1';

    }
  } else {
    // ✅ PENDING COURIER SLIDES
    const pendingCouriers = couriers.filter(c => c.pending);
    let noCourierSlide = document.querySelector(".no-courier-slide");

    if (pendingCouriers.length === 0) {
     goToStep(false, false, false, false, false);

	    
      if (!noCourierSlide) {
        noCourierSlide = document.createElement("div");
        noCourierSlide.classList.add("swiper-slide", "no-courier-slide");
        noCourierSlide.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
            <div style="display: flex; flex-direction: column; flex: 1 1 0%;">
              <span>0 Pending</span>
              <div class="store-address">
                <div>
                  <div class="street-name">${couriers.length} Active</div>
                  <div class="address-details">OFFER NOTIFICATIONS SENT VIA SMS</div>
                </div>
              </div>
            </div>
          </div>
        `;
        swiperWrapper.appendChild(noCourierSlide);
	document.getElementById('courierList').style.opacity = '1';

      
      }
    } else {
      if (noCourierSlide) noCourierSlide.remove();

      pendingCouriers.forEach(courier => {
	     const alreadyExists = swiperWrapper.querySelector(`[data-courier-id="${courier.courier_id}"]`);
	      if (alreadyExists){ 

document.getElementById('courierList').style.opacity = '1';

	      return; 
	      }
	  const courierSlide = document.createElement("div"); 
    
        courierSlide.classList.add("swiper-slide", "hidden-slide");
        courierSlide.setAttribute("data-courier-id", courier.courier_id);
        courierSlide.innerHTML = `
          <div style="display: flex; flex-direction: column; flex: 1 1 0%;">
            <span style="font-size: 18px; font-weight: 500;">James Morrow</span>
            <div class="store-address">
              <div class="street-name">CourierID: ${courier.courier_id}</div>
              <div class="courierRowOffer">
                <div class="courierSequence">
                  <span class="address-details" id="courier${courier.courier_id}StatusText"></span>
                  <span class="status" id="courier${courier.courier_id}StatusBadge"></span>
                </div>
                <div class="courierOffer">
                  <span class="address-details" id="courier${courier.courier_id}OfferText"></span>
                  <span class="status" id="courier${courier.courier_id}OfferBadge"></span>
                </div>
              </div>
              <div style="display: none;">
                <div style="display: flex; flex-direction: column; align-items: center; gap: 5px;">
                  <a href="tel:${courier.courier_phone}" class="pending-courier-icon">
                    <i class="fa-solid fa-phone"></i> Call
                  </a>
                  <a href="sms:${courier.courier_phone}" class="pending-courier-icon">
                    <i class="fa-solid fa-comment-dots"></i> Text
                  </a>
                </div>
                <a href="#" data-lat="${courier.courier_latitude}" data-lng="${courier.courier_longitude}" class="pending-courier-locate">
                  <i class="fa-solid fa-map-marker-alt"></i> Locate
                </a>
                <button style="display: block;" data-phone="${courier.courier_phone}" class="payButton" id="submitBtn">
                  Pay ${courier.courier_id}
                </button>
              </div>
            </div>
          </div>
        `;
        swiperWrapper.appendChild(courierSlide);

        setTimeout(() => {
          const status = courier.sms_sequence;
          const badge = courierSlide.querySelector(`#courier${courier.courier_id}StatusBadge`);
          const badgeText = courierSlide.querySelector(`#courier${courier.courier_id}StatusText`);
          const offer = courier.counter_offer;
          const badge2 = courierSlide.querySelector(`#courier${courier.courier_id}OfferBadge`);
          const badge2Text = courierSlide.querySelector(`#courier${courier.courier_id}OfferText`);

          badge.classList.add(status === 'UPDATE' ? 'idle' : 'busy');
          badge.innerHTML = status === 'UPDATE'
            ? '<i class="fas fa-check-circle"></i> Ready Now'
            : '<i class="fas fa-clock"></i> On Delivery';
          badgeText.textContent = status;

          badge2.classList.add(offer === null ? 'idle' : 'busy');
          badge2.innerHTML = offer === null
            ? '<i class="fas fa-check-circle"></i> Offer Accepted'
            : `<i class="fa-solid fa-tags"></i> Counter Offer: $${offer}`;
          badge2Text.textContent = offer === null ? 'Accepted' : `$${offer}`;
        }, 1000);
      });
    }
  

  // ✅ Final Swiper update

	 
  setTimeout(() => {
    if (swiperWrapper && swiper) {
      swiper.off("touchEnd", updatePayButton);
      swiper.on("touchEnd", updatePayButton);
      swiper.update();
      goToStep(true, false, false, false, false);	    
      document.getElementById("cancelControls").style.display = "flex";
      document.querySelectorAll(".hidden-slide").forEach(slide => slide.classList.remove("hidden-slide"));
      updatePayButton();
      document.getElementById('getStateLoaderContainerSwiper').style.display = 'none';
      document.getElementById('courierList').style.opacity = '1';
      console.log("Swiper updated.");
    } else {
      console.error("Swiper is not initialized!");
    }
  }, 1000);
	  
 
  }
}







if (targetPhone !== "all") {

    checkCourierProximity(courierMarkers[0]);
  }
	    

      // 🗺️ Marker logic
      courierMarkers = []; // Reset marker array
       let existingMarkers = new Set();

/*

      const targetCouriers = targetPhone === "all"
        ? couriers
        : couriers.filter(c => c.courier_phone === targetPhone);

*/
	    
let targetCouriers;

if (response.delivery && response.delivery.status === "paid") {
  document.getElementById('submitFooter').style.display = "none"; 	
  // ✅ Only show the paid courier
targetCouriers = couriers.filter(c => c.courier_id === response.delivery.matched_courier_id);	
} else {
  // ✅ Show all or filtered pending couriers
  targetCouriers = targetPhone === "all"
    ? couriers.filter(c => c.pending)
    : couriers.filter(c => c.courier_phone === targetPhone && c.pending);
}
      targetCouriers.forEach((courier, index) => {
        const { courier_id, courier_latitude, courier_longitude, courier_phone } = courier;
        const newPosition = new google.maps.LatLng(courier_latitude, courier_longitude);



          // ✅ Create or update classic marker for clustering
  if (courierMarkers[index]) {
    courierMarkers[index].setPosition(newPosition);
    existingMarkers.add(courierMarkers[index]);
  } else {
    const standardMarker = new google.maps.Marker({
      position: newPosition,
      map: map,
      title: `Courier ${courier_phone}`
    });
    standardMarker.setOpacity(0); // Invisible but clusterable
    courierMarkers.push(standardMarker);
    existingMarkers.add(standardMarker);
  }





        if (courierMarkerMap.has(courier_id)) {
          const marker = courierMarkerMap.get(courier_id);
          marker.position = newPosition;
          marker.map = map;
          console.log("Updated marker for:", courier_phone);
        } else {
          const markerElement = document.createElement('div');
          markerElement.className = 'courier-marker';
	/*	
          markerElement.innerHTML = `
            <div class="icon-background pulsate"></div>
            <div class="icon">
              <span style="display:none; font-size:16px;" class="courier-id">${courier_id}</span>
              <span class="bicycle-icon"><i class="fa-solid fa-bicycle"></i></span>
            </div>
            
            <div class="details">
              <div class="courierName">${courier_phone}</div>
            </div>
          `;
		*/
		markerElement.innerHTML = `
  <div class="courier-rocker">
    <div class="courier-pulse">
      <div class="icon-background"></div>
      <div class="courier-icon">
        <i class="fas fa-bicycle"></i>
      </div>
    </div>
  </div>
`

          const advancedMarker = new google.maps.marker.AdvancedMarkerElement({
            map: map,
            position: newPosition,
            content: markerElement,
            title: `Courier ${courier_phone}`
          });
           advancedMarker.map = null; // Initially hidden 
          courierMarkerMap.set(courier_id, advancedMarker);
          advancedMarkers.push(advancedMarker); // ✅ Add to clustering array
          console.log("Created new marker for:", courier_phone);
        }

        // Optional: update center button for last courier
        const centerButton = document.getElementById("mapCenterCourier");
        if (centerButton && targetPhone !== "all") {
          centerButton.onclick = () => centerMap(courier_latitude, courier_longitude);
        }
      });

      // 🧠 Cluster logic
      if (markerCluster) {
        markerCluster.clearMarkers();
        markerCluster.addMarkers(courierMarkers);
      } else {
        markerCluster = new markerClusterer.MarkerClusterer({
          map: map,
          markers: courierMarkers,
          ignoreHiddenMarkers: true,
          renderer: customRenderer
        });
      }
// 🔄 Sync visibility of advanced markers
google.maps.event.clearListeners(markerCluster, 'clusteringend');
google.maps.event.addListener(markerCluster, 'clusteringend', function() {
  advancedMarkers.forEach((advancedMarker, index) => {
    const isHidden = courierMarkers[index]?.getMap() === null;
    advancedMarker.map = isHidden ? null : map;
  });
});

    },
    error: function(xhr, status, error) {
      console.error('Error getting Courier Data:', error);
    }
  });
}
/*
function getCouriers(targetPhone = "all") {
courierMarker= document.getElementById("courier-circle"); 	
    const homeMarkerPosition = initialMarker.position; // Get home marker position
    const customRenderer = {
        render: function({ count, position }) {
            const zoomLevel = map.getZoom();
            const distance = google.maps.geometry.spherical.computeDistanceBetween(position, homeMarkerPosition);

            if (distance < 100 || zoomLevel < 12) {
                const offsetLatLng = new google.maps.LatLng(
                    position.lat() + (zoomLevel < 12 ? 0.002 : 0.001),
                    position.lng() + (zoomLevel < 12 ? 0.002 : 0.001)
                );

                const clusterElement = document.createElement('div');
                clusterElement.className = 'custom-cluster';
                clusterElement.innerText = `${count}`;

                return new google.maps.marker.AdvancedMarkerElement({
                    position: offsetLatLng,
                    content: clusterElement
                });
            }

            const clusterElement = document.createElement('div');
            clusterElement.className = 'custom-cluster';
            clusterElement.innerText = `${count}`;

            return new google.maps.marker.AdvancedMarkerElement({
                position: position,
                content: clusterElement
            });
        }
    };


  $.ajax({    
    url: '/active/',
    type: 'POST',
    data: { customer_number: phone_number },
    success: function(response) {
        console.log('Courier data received:', response);
        const couriers = response.couriers;

        setTimeout(() => {
            const totalCount = couriers.length;
            const pendingCount = couriers.filter(courier => courier.pending).length;

            updateCourierCount(totalCount);
            updatePendingCourierCount(pendingCount, totalCount);
        }, 5000); // You can adjust the delay if needed

 
if (smsSequence === "CHOOSE_STORE" || smsSequence === "STORE_CHOSEN") {
if (!swiper) {
  initializeCourierSwiper();
}	
const swiperContainer = document.getElementById('courierList'); 
let swiperWrapper =swiperContainer.querySelector(".swiper-wrapper");
if (swiperWrapper) {
    let existingSlides = swiperWrapper.querySelectorAll(".swiper-slide");
    let noCourierSlide = document.querySelector(".no-courier-slide");
    let pendingCouriers = couriers.filter(courier => courier.pending);
 
    // ✅ Remove outdated courier slides (EXCEPT placeholder)
    existingSlides.forEach(slide => {
        if (slide.classList.contains("no-courier-slide")) return; // ✅ Skip placeholder slide
        let courierID = slide.getAttribute("data-courier-id");
        if (!couriers.some(courier => courier.courier_id == courierID && courier.pending)) {
            slide.remove();
        }
    });

    // ✅ Ensure "No Couriers Available" placeholder stays until real couriers exist
    if (pendingCouriers.length === 0) {
        console.log("No Pending Couriers...");

        if (!noCourierSlide) {
		document.getElementById('courierPagination').style.display= 'none'; 
            noCourierSlide = document.createElement("div");
            noCourierSlide.classList.add("swiper-slide", "no-courier-slide");
            noCourierSlide.innerHTML = `

		<div style="display: flex; justify-content: space-between; align-items: center; width: 100%;"><div style="display: flex; flex-direction: column; flex: 1 1 0%;">
		<span style="font-size: 18px; font-weight: 500;">0 Pending Couriers</span><div class="store-address">
			<div><div class="street-name">${couriers.length} Active Couriers <div id="noCourierCount"></div></div>
                <div class="address-details">OFFER NOTIFICATIONS SENT VIA SMS</div>
                 </div>
		                   


            `;
            swiperWrapper.appendChild(noCourierSlide);
            console.log("Placeholder slide added.");
        }
    } else {
	    document.getElementById('courierPagination').style.display= 'block';
        console.log("Couriers available, removing placeholder...");
        setTimeout(() => {
            if (noCourierSlide) {
                noCourierSlide.remove();
                console.log("Placeholder slide removed.");
            }
        }, 1000); // ✅ Longer delay ensures placeholder isn't removed prematurely

        // ✅ Add new pending couriers that aren't already in Swiper
        pendingCouriers.forEach(courier => {
            if (!swiperWrapper.querySelector(`[data-courier-id="${courier.courier_id}"]`)) {
                const courierSlide = document.createElement("div");
		courierSlide.classList.add("swiper-slide", "hidden-slide");
	        courierSlide.id = 'swiper-slide';
                courierSlide.setAttribute("data-courier-id", courier.courier_id);
                courierSlide.innerHTML = `
<div style="display: flex; flex-direction: column; flex: 1 1 0%;">
  <span style="font-size: 18px; font-weight: 500;">James Morrow</span>

  <div class="store-address">
    <div class="street-name">CourierID: ${courier.courier_id}</div>
			    <div class="courierRowOffer">
    <div class="courierSequence">
      <span class="address-details" id="courier${courier.courier_id}StatusText"></span>
      <span class="status" id="courier${courier.courier_id}StatusBadge"></span>
    </div>

    <div class="courierOffer">
      <span class="address-details" id="courier${courier.courier_id}OfferText"></span>
      <span class="status" id="courier${courier.courier_id}OfferBadge"></span>
    </div>
    </div>
    <div style="display: none;">
<!-- Contact Buttons -->
<div style="display: flex; flex-direction: column; align-items: center; gap: 5px;">
  <a href="tel:${courier.courier_phone}" class="pending-courier-icon">
    <i class="fa-solid fa-phone"></i> Call
  </a>
  <a href="sms:${courier.courier_phone}" class="pending-courier-icon">
    <i class="fa-solid fa-comment-dots"></i> Text
  </a>
</div>

		    
      <a href="#" data-lat="${courier.courier_latitude}" data-lng="${courier.courier_longitude}" class="pending-courier-locate">
        <i class="fa-solid fa-map-marker-alt"></i> Locate
      </a>
      <button style="display: block;" data-phone="${courier.courier_phone}" class="payButton" id="submitBtn">
        Pay ${courier.courier_id}
      </button>
    </div>
  </div>
</div>
                `;
                swiperWrapper.appendChild(courierSlide);
            
setTimeout(() => {
    const status = courier.sms_sequence;
const badge = courierSlide.querySelector(`#courier${courier.courier_id}StatusBadge`);
const text = courierSlide.querySelector(`#courier${courier.courier_id}StatusText`);
    if (status === 'UPDATE') {
      badge.classList.add('idle');
      badge.innerHTML = '<i class="fas fa-check-circle"></i> Ready Now';
//      text.textContent = 'idle';
    } else {
      badge.classList.add('busy');
      badge.innerHTML = '<i class="fas fa-clock"></i> On Delivery';
  //    text.textContent = 'on_delivery';
    }
     offer = courier.counter_offer;
const badge2 = courierSlide.querySelector(`#courier${courier.courier_id}OfferBadge`);
const text2 = courierSlide.querySelector(`#courier${courier.courier_id}OfferText`);
    if (offer === null) {
      badge2.classList.add('idle');
      badge2.innerHTML = '<i class="fas fa-check-circle"></i> Offer Accepted';
//      text2.textContent = 'idle';
    } else {
      badge2.classList.add('busy');
	    badge2.innerHTML = `<i class="fa-solid fa-tags"></i> Counter Offer: $${offer}`;
  //    text2.textContent = 'on_delivery';
    }	



},2000); 

}
        });
    }
	
setTimeout(() => {

    // ✅ Ensure Swiper updates **AND REBINDS event listeners**
    if (swiperWrapper && swiper) {
swiper.off("touchEnd", updatePayButton);
swiper.on("touchEnd", updatePayButton);	    
swiper.update();
 document.getElementById("cancelControls").style.display = "flex";	    
        document.querySelectorAll(".hidden-slide").forEach(slide => {
        slide.classList.remove("hidden-slide");
	})
	    
        updatePayButton(); // ✅ Rebind event listeners
        console.log("Swiper updated with event bindings.")
	document.getElementById('getStateLoaderContainerSwiper').style.display = 'none';     
	document.getElementById('courierList').style.opacity='1'; 
    } 


	else {
        console.error("Swiper is not initialized!");
     }}, 1000);

}


}




            let existingMarkers = new Set();

const courier = couriers.find(c => c.courier_phone === targetPhone);
if (!courier) return;

const { courier_id, courier_latitude, courier_longitude, courier_phone } = courier;
const newPosition = new google.maps.LatLng(courier_latitude, courier_longitude);

// Update or create marker
if (courierMarkerMap.has(courier_id)) {
  const marker = courierMarkerMap.get(courier_id);
  marker.position = newPosition;
  marker.map = map;
  console.log("Updated marker for:", courier_phone);
} else {
  const markerElement = document.createElement('div');
  markerElement.className = 'courier-marker';
  markerElement.innerHTML = `
    <div class="icon-background pulsate"></div>
    <div class="icon">
      <span style="display:none; font-size:16px;" class="courier-id">${courier_id}</span>
      <span class="bicycle-icon"><i class="fa-solid fa-bicycle"></i></span>
    </div>
    <div class="details">
      <div class="courierName">${courier_phone}</div>
    </div>
  `;

  const advancedMarker = new google.maps.marker.AdvancedMarkerElement({
    map: map,
    position: newPosition,
    content: markerElement,
    title: `Courier ${courier_phone}`
  });

  courierMarkerMap.set(courier_id, advancedMarker);
  console.log("Created new marker for:", courier_phone);
}

// ✅ Update center button click handler with latest location
const centerButton = document.getElementById("mapCenterCourier");
if (centerButton) {
  centerButton.onclick = () => centerMap(courier_latitude, courier_longitude);
}
            courierMarkers = courierMarkers.filter(marker => existingMarkers.has(marker));

            if (markerCluster) {
                markerCluster.clearMarkers();
                markerCluster.addMarkers(courierMarkers);
            } else {
                markerCluster = new markerClusterer.MarkerClusterer({
                    map: map,
                    markers: courierMarkers,
                    ignoreHiddenMarkers: true,
                    renderer: customRenderer
                });
            }

            google.maps.event.clearListeners(markerCluster, 'clusteringend');

            google.maps.event.addListener(markerCluster, 'clusteringend', function() {
                advancedMarkers.forEach((advancedMarker, index) => {
                    let isHidden = courierMarkers[index].getMap() === null;
                    advancedMarker.map = isHidden ? null : map;
                });
            });
        },
        error: function(xhr, status, error) {
            console.error('Error getting Courier Data:', error);
        }
    });
}





*/






	function clearMarkers() {
    markers.forEach(function(item) {
        if (item.marker) {
            item.marker.setMap(null);
        }
        if (item.div && item.div.parentNode) {
            item.div.parentNode.removeChild(item.div);
        }
        if (item.overlay) {
            item.overlay.setMap(null); // This will also trigger onRemove
        }
    });
    markers = []; // Clear the array

    // Clear custom overlays
    customOverlays.forEach(function(overlay) {
        if (overlay.getMap()) {
            overlay.setMap(null);
        }
    });
    customOverlays = []; // Clear the array
}
function logout() {
    const confirmed = window.confirm('Are you sure you want to log out?');
    if (confirmed) {
        // Call your logout function here
        deleteTokenFromStore('user');
    } else {
        // User canceled the logout
        // You can handle this case or simply do nothing
    }
}



async function deleteTokenFromStore(id) {
    try {
        const db = await openDatabase();
        const transaction = db.transaction('tokens', 'readwrite');
        const store = transaction.objectStore('tokens');
        store.delete(id);
        await transaction.complete; // Wait for the transaction to complete
	location.href = '/app';
    } catch {
        console.log('nothing to delete');
    }
}

function openDatabase() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open('my-token-db', 1);

        request.onupgradeneeded = event => {
            const db = event.target.result;
            db.createObjectStore('tokens', { keyPath: 'id' });
        };

        request.onsuccess = event => {
            resolve(event.target.result);
        };

        request.onerror = event => {
            reject(event.target.error);
        };
    });
}
function hideAllChildren(parentElement) {
	console.log('hiding all children'); 
    const children = parentElement.children;
    console.log(children); 
    for (let i = 0; i < children.length; i++) {
        children[i].style.display = 'none';
    }
}


function hideAllChildren(parentElement) {
	console.log('hiding all children'); 
    const children = parentElement.children;
    console.log(children); 
    for (let i = 0; i < children.length; i++) {
        children[i].style.display = 'none';
    }
}
const progress = document.getElementById("progress2");
const prev = document.getElementById("prev");
const next = document.getElementById("next");
const circles = document.querySelectorAll(".circle");

let currentActive = 1;

next.addEventListener("click", () => {
  currentActive++;
  if (currentActive > circles.length) currentActive = circles.length;
  update();
});

prev.addEventListener("click", () => {
  currentActive--;
  if (currentActive < 1) currentActive = 1;
  update();
});

const update = () => {
  circles.forEach((circle, index) => {
    if (index < currentActive) circle.classList.add("active");
    else circle.classList.remove("active");
  });
  const actives = document.querySelectorAll(".active");
  progress.style.width =
    ((actives.length - 1) / (circles.length - 1)) * 100 + "%";
  if (currentActive === 1) prev.disabled = true;
  else if (currentActive === circles.length) next.disabled = true;
  else {
    prev.disabled = false;
    next.disabled = false;
  }
};



let courierRouteLine = null;
let courierMarker = null;
let lastDestinationKey = null;
function courierToStore(data) {
  const courier = JSON.parse(data.courier)[0];
  const orders = JSON.parse(data.orders);
  const delivery = JSON.parse(data.delivery)[0];

  const pendingOrders = orders.filter(order => !order.fields.status);

  const origin = {
    lat: courier.fields.courier_latitude,
    lng: courier.fields.courier_longitude
  };

  let destination;
  if (pendingOrders.length === 0) {
    destination = {
      lat: delivery.fields.destination_latitude,
      lng: delivery.fields.destination_longitude
    };
  } else {
    const closestStore = getClosestStore(courier, pendingOrders);
    if (!closestStore) return;

    destination = {
      lat: closestStore.fields.store_latitude,
      lng: closestStore.fields.store_longitude
    };
  }

  const destinationKey = `${destination.lat},${destination.lng}`;

  // ✅ Always update courier marker
  if (!courierMarker) {
    courierMarker = new google.maps.Marker({
      position: origin,
      map: map,
      icon: "/static/bootstrap-icons/courier_icon.png"
    });
  } else {
    courierMarker.position=origin;
  }

  // ❌ Skip route redraw if destination hasn't changed
  if (destinationKey === lastDestinationKey) {
    return;
  }

  lastDestinationKey = destinationKey;

  // Clear previous route
  if (courierRouteLine) {
    courierRouteLine.setMap(null);
    courierRouteLine = null;
  }

  const coordString = `${origin.lng},${origin.lat};${destination.lng},${destination.lat}`;
  const url = `https://router.project-osrm.org/route/v1/driving/${coordString}?overview=full&geometries=geojson`;

  fetch(url)
    .then(res => res.json())
    .then(data => {
      if (data.code !== 'Ok' || !data.routes?.[0]) throw new Error("Invalid OSRM response");

      const routeCoords = data.routes[0].geometry.coordinates;
      const latLngPath = routeCoords.map(([lng, lat]) => ({ lat, lng }));

      courierRouteLine = new google.maps.Polyline({
        path: latLngPath,
        geodesic: true,
        strokeColor: '#007bff',
        strokeOpacity: 0.8,
        strokeWeight: 4,
        map: map
      });

      console.log("Courier route updated.");
    })
    .catch(err => {
      console.warn("Courier route fetch failed:", err.message);
    });
}
/*
let courierLine = null;

function courierToStore(data) {
  const courier = JSON.parse(data.courier)[0];
  const orders = JSON.parse(data.orders);
  const delivery = JSON.parse(data.delivery)[0];

  const pendingOrders = orders.filter(order => !order.fields.status);

  let origin, destination;

  if (pendingOrders.length === 0) {
    // No pending stores — route to final delivery
    origin = {
      lat: courier.fields.courier_latitude,
      lng: courier.fields.courier_longitude
    };
    destination = {
      lat: delivery.fields.destination_latitude,
      lng: delivery.fields.destination_longitude
    };
  } else {
    const closestStore = getClosestStore(courier, pendingOrders);
    if (!closestStore) {
      console.error("No store found.");
      return;
    }
    origin = {
      lat: courier.fields.courier_latitude,
      lng: courier.fields.courier_longitude
    };
    destination = {
      lat: closestStore.fields.store_latitude,
      lng: closestStore.fields.store_longitude
    };
  }

  // Remove previous line
  if (courierLine) {
    courierLine.setMap(null);
  }

  // Generate a smooth curved path
  const curvedPath = createSmoothArc(origin, destination);

  // Draw the polyline on the map
  courierLine = new google.maps.Polyline({
    path: curvedPath,
    geodesic: false,
    strokeColor: "#007bff",
    strokeOpacity: 0.9,
    strokeWeight: 3,
    map: map
  });
}
*/
// 📍 Creates a smooth, visible arc from origin to destination
function createSmoothArc(start, end, resolution = 30, curvature = 0.3) {
  const points = [];

  for (let i = 0; i <= resolution; i++) {
    const t = i / resolution;

    // Basic linear interpolation
    const lat = (1 - t) * start.lat + t * end.lat;
    const lng = (1 - t) * start.lng + t * end.lng;

    // Offset curve perpendicular to the direction vector
    const dx = end.lng - start.lng;
    const dy = end.lat - start.lat;
    const normalLat = -dx;
    const normalLng = dy;

    const offsetScale = Math.sin(Math.PI * t) * curvature;

    const curvedLat = lat + normalLat * offsetScale;
    const curvedLng = lng + normalLng * offsetScale;

    points.push({ lat: curvedLat, lng: curvedLng });
  }

  return points;
}

// 📦 Finds the closest store (by Haversine distance) from courier
function getClosestStore(courier, orders) {
  let closest = null;
  let minDistance = Infinity;

  orders.forEach(order => {
    const lat = order.fields.store_latitude;
    const lng = order.fields.store_longitude;
    const distance = getDistance(
      courier.fields.courier_latitude,
      courier.fields.courier_longitude,
      lat,
      lng
    );
    if (distance < minDistance) {
      minDistance = distance;
      closest = order;
    }
  });

  return closest;
}

// 🌍 Haversine formula
function getDistance(lat1, lng1, lat2, lng2) {
  const R = 6371; // km
  const toRad = Math.PI / 180;
  const dLat = (lat2 - lat1) * toRad;
  const dLng = (lng2 - lng1) * toRad;
  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(lat1 * toRad) * Math.cos(lat2 * toRad) *
    Math.sin(dLng / 2) ** 2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}


















/*
let  directionsService, directionsRenderer;

function courierToStore(data) {
   if (!directionsService) {



        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers: true, preserveViewport: true,suppressBicyclingLayer: true
 });
        directionsRenderer.setMap(map);
    }

    function getClosestStore(courier, orders) {
        let closestStore = null;
        let minDistance = Infinity;

        orders.forEach(order => {
            if (!order.fields.status) { // Only consider stores where status is false
                let storeLat = order.fields.store_latitude;
                let storeLng = order.fields.store_longitude;
                let distance = getDistance(
                    courier.fields.courier_latitude,
                    courier.fields.courier_longitude,
                    storeLat,
                    storeLng
                );

                if (distance < minDistance) {
                    minDistance = distance;
                    closestStore = order;
                }
            }
        });

        return closestStore;
    }

    function getDistance(lat1, lng1, lat2, lng2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * (Math.PI / 180);
        const dLng = (lng2 - lng1) * (Math.PI / 180);
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
                  Math.sin(dLng / 2) * Math.sin(dLng / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    const courier = JSON.parse(data.courier)[0];
    const orders = JSON.parse(data.orders);
    const delivery = JSON.parse(data.delivery)[0];

    // Get all stores with status=false
    const pendingOrders = orders.filter(order => !order.fields.status);

    let origin;

    if (pendingOrders.length === 0) {
        // If all statuses are true, route from courier to destination
        origin = { lat: courier.fields.courier_latitude, lng: courier.fields.courier_longitude };
        destination = { lat: delivery.fields.destination_latitude, lng: delivery.fields.destination_longitude };
    } else {
        // Otherwise, find the closest store where status = false
        const closestStore = getClosestStore(courier, pendingOrders);
        if (!closestStore) {
            console.error("No store found.");
            return;
        }
        origin = { lat: courier.fields.courier_latitude, lng: courier.fields.courier_longitude };
        destination = { lat: closestStore.fields.store_latitude, lng: closestStore.fields.store_longitude };
    }

    const request = {
        origin: origin,
        destination: destination,
        travelMode: 'BICYCLING'
    };
directionsService.route(request, function(response, status) {
    if (status === 'OK') {
        directionsRenderer.setDirections(response);

        // Get route distance
        let totalDistance = response.routes[0].legs[0].distance.text;
        console.log("Route Distance:", totalDistance);
    } else {
        console.error('Directions request failed due to ' + status);
    }
});

	

    directionsRenderer.setDirections({ routes: [] });

    directionsService.route(request, function(response, status) {
        if (status === 'OK') {
            directionsRenderer.setDirections(response);
        } else {
            console.error('Directions request failed due to ' + status);
        }
    });
}
*/
	
function updateCourierCount(count) {
    const courierCountElement = document.getElementById("courierCount");

    if (!courierCountElement) return;  // ✅ Prevent errors if element is missing

    if (count > 0) {
        courierCountElement.innerText = count;
        courierCountElement.classList.remove("searching"); // ✅ Stop pulsing effect
    } else {
        courierCountElement.innerText = "Searching...";
        courierCountElement.classList.add("searching"); // ✅ Start pulsing animation
    }
}


/*
function updatePendingCourierCount(pendingCount, count) {
	console.log(pendingCount, count); 
    const pendingCountElement = document.getElementById("pendingCourierCount");
    const noCourierCountElement = document.getElementById("noCourierCount");
    if (!pendingCountElement) return; // ✅ Prevent errors if element is missing

    if (pendingCount > 0) {
        noCourierCountElement.innerHTML = count; 	     
        pendingCountElement.classList.remove("searching"); // ✅ Stop pulsing effect
    } else {
	    
        pendingCountElement.innerText = "0";
	noCourierCountElement.innerHTML = count; 
        pendingCountElement.classList.add("searching"); // ✅ Start pulsing animation
    }
}

function updatePendingCourierCount(pendingCount, count) {
  const courierCircle = document.getElementById("courier-circle");
  const courierSpinner = document.getElementById("courier-spinner");
  const courierCountBadge = document.getElementById("pendingCourierCount");

  if (!courierCircle || !courierSpinner || !courierCountBadge) return;

  if (pendingCount > 0) {
    // Switch to black circle with bicycle icon
    courierCircle.classList.remove("bg-white");
    courierCircle.classList.add("bg-black");

    // Replace spinner with bicycle icon
    courierSpinner.style.display = "none";
    courierCircle.innerHTML = `
      <i class="fas fa-bicycle text-white text-lg"></i>
      <div
        id="pendingCourierCount"
        class="absolute top-0 left-0 transform -translate-x-1/2 -translate-y-1/2 bg-green-600 text-white text-xs font-bold px-2 py-0.5 rounded-full"
      >
        ${pendingCount}
      </div>
    `;
  } else {
    // Switch back to spinner
   // courierCircle.classList.remove("bg-black");
  //  courierCircle.classList.add("bg-black", "animate-pulse");

    courierCircle.innerHTML = `
      <svg id="courier-spinner" class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
      </svg>
      <div
        id="pendingCourierCount"
        class="absolute top-0 left-0 transform -translate-x-1/2 -translate-y-1/2 bg-red-600 text-white text-xs font-bold px-2 py-0.5 rounded-full"
      >
        0
      </div>
    `;
  }
}
*/
function updatePendingCourierCount(pendingCount, count) {
  const courierCircle = document.getElementById("courier-circle");
  const courierSpinner = document.getElementById("courier-spinner");
  const courierCountBadge = document.getElementById("pendingCourierCount");

  if (!courierCircle || !courierSpinner || !courierCountBadge) return;

  if (pendingCount > 0) {
    // Switch to black circle with bicycle icon
    courierCircle.classList.remove("bg-white");
    courierCircle.classList.add("bg-black");

    // Hide spinner and show bicycle icon
    courierSpinner.style.display = "none";

    // Inject bicycle icon if not already present
    if (!courierCircle.querySelector(".fa-bicycle")) {
      const bikeIcon = document.createElement("i");
      bikeIcon.className = "fas fa-bicycle text-white text-lg";
      courierCircle.prepend(bikeIcon);
    }

    // Update badge count and style
    courierCountBadge.textContent = pendingCount;
    courierCountBadge.classList.remove("hidden");
    courierCountBadge.classList.remove("bg-red-600");
    courierCountBadge.classList.add("bg-green-600");

    // Animate badge
    courierCountBadge.classList.add("transition", "duration-300", "scale-105");
    setTimeout(() => {
      courierCountBadge.classList.remove("scale-105");
    }, 300);
  } else {
    // Show spinner again
    courierSpinner.style.display = "block";

    // Remove bicycle icon if present
    const bikeIcon = courierCircle.querySelector(".fa-bicycle");
    if (bikeIcon) bikeIcon.remove();

    // Update badge count and style
    courierCountBadge.textContent = "0";
    courierCountBadge.classList.remove("bg-green-600");
    courierCountBadge.classList.add("bg-red-600");
    courierCountBadge.classList.add("hidden");
  }
}	
function centerMap(lat, lng) {
    console.log("Centering map to:", lat, lng);
    myPane.moveToBreak('middle');
    // Example logic (replace with actual map API logic)
    map.panTo({ lat: lat, lng: lng });
        setTimeout(() => {
        map.setZoom(16);
    }, 600); 	
}
function getActiveCourierPhone() {
  const wrapper = document.getElementById("courier-wrapper");
  if (!wrapper) return null;

  const activeSlide = wrapper.querySelector(".swiper-slide.swiper-slide-active");
  if (!activeSlide) return null;

  const phoneLink = activeSlide.querySelector('a[href^="tel:"]');
  return phoneLink ? phoneLink.getAttribute("href").replace("tel:", "").trim() : null;
}

function getActiveCourierLocation() {
  const wrapper = document.getElementById("courier-wrapper");
  if (!wrapper) return null;

  const activeSlide = wrapper.querySelector(".swiper-slide.swiper-slide-active");
  if (!activeSlide) return null;

  const locateLink = activeSlide.querySelector(".pending-courier-locate");
  if (!locateLink) return null;

  const lat = parseFloat(locateLink.dataset.lat);
  const lng = parseFloat(locateLink.dataset.lng);

  if (isNaN(lat) || isNaN(lng)) return null;

  return [lat, lng];
}
function updatePayButton() {
  const wrapper = document.getElementById("courier-wrapper");
  if (!wrapper) return null;

  const activeSlide = wrapper.querySelector(".swiper-slide.swiper-slide-active");
  if (!activeSlide) return null;	
    const selectPayCourier = document.getElementById("selectPayCourier");
    const courierPhone = getActiveCourierPhone();
    const courierLocation= getActiveCourierLocation(); 
    const callButton = document.getElementById('payCall');
    const textButton = document.getElementById('payText');
    const locateButton = document.getElementById('payLocate'); 
    console.log(courierPhone, 'this is the courier phone');

    if (activeSlide && courierPhone) {
        // Update pay button styling and text
        selectPayCourier.className = "selectPayCourier";

        // Show call & text buttons
        callButton.style.display = "inline-flex";
        textButton.style.display = "inline-flex";
	locateButton.style.display = "inline-flex"; 

        // Set href for contact buttons
        callButton.href = `tel:${courierPhone}`;
        textButton.href = `sms:${courierPhone}`;
	    console.log(courierLocation); 
locateButton.onclick = () => {
  if (courierLocation && courierLocation.length === 2) {
    centerMap(courierLocation[0], courierLocation[1]);
  }
};

	    

        // Attach event listener safely
     //   addPayButtonListener(phone_number, courierPhone);
    //  addPayButtonListener(); 
        console.log('courier phone:', courierPhone);

        // Apply background color from active slide's inner div
        const activeSlideDiv = activeSlide.querySelector("div");
        if (activeSlideDiv) {
           // selectPayCourier.style.backgroundColor = window.getComputedStyle(activeSlideDiv).backgroundColor;
           //  selectPayCourier.style.backgroundColor = "black";		
            //selectPayCourier.style.width = "150px";
        }
    } else {
        // Reset pay button for inactive state
//        selectPayCourier.innerHTML = "$0.00";
        selectPayCourier.className = "inactiveButton";
        selectPayCourier.style.backgroundColor = "";
 //       selectPayCourier.style.width = "100%";

        // Hide call & text buttons
        callButton.style.display = "none";
        textButton.style.display = "none";
    }
}

function addPayButtonListener(){
document.getElementById("selectPayCourier").addEventListener("click", function () {
  const button = this;
  const originalContent = button.innerHTML;

  button.disabled = true;
  document.body.classList.add("touch-lock");
  button.innerHTML = `
    <span class="button-loader">
      <i class="fas fa-spinner fa-spin"></i> Loading...
    </span>
  `;

  resetUI();

  const courierPhone = getActiveCourierPhone();
  if (!courierPhone) {
    console.error("No active courier selected.");
    cleanup();
    return;
  }

  initialize(courierPhone);

  setTimeout(() => {
    cleanup();
    paymentPane.present({ animate: true });
  }, 500);

  function cleanup() {
    button.innerHTML = originalContent;
    button.disabled = false;
    document.body.classList.remove("touch-lock");
  }
});
}	

/*
function addPayButtonListener(deliveryID, courierPhone) {
  console.log(deliveryID);

  fetch("/config/")
    .then((result) => result.json())
    .then((data) => {
      const stripe = Stripe(data.publicKey);
      const selectPayCourier = document.getElementById("selectPayCourier");

      // Replace button to clear previous listeners
      selectPayCourier.replaceWith(selectPayCourier.cloneNode(true));
      const newSelectPayCourier = document.getElementById("selectPayCourier");
      const originalContent = newSelectPayCourier.innerHTML;

      newSelectPayCourier.addEventListener("click", async function () {
        // 🌀 UI lock + spinner
        newSelectPayCourier.disabled = true;
        document.body.classList.add("touch-lock");
        newSelectPayCourier.innerHTML = `
          <span class="button-loader">
            <i class="fas fa-spinner fa-spin"></i> Loading...
          </span>
        `;

        try {
          console.log("Proceeding with payment...");
          console.log("Delivery ID:", deliveryID);

          const response = await fetch(`/create-checkout-session/`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ deliveryID, courierPhone })
          });

          const sessionData = await response.json();
          console.log("Session:", sessionData);

          // ✅ Revert button before redirect
          setTimeout(() => {
          newSelectPayCourier.innerHTML = originalContent;
          newSelectPayCourier.disabled = false;
          document.body.classList.remove("touch-lock");
          }, 1000); // 1000 milliseconds = 1 second	  

          const { error } = await stripe.redirectToCheckout({
            sessionId: sessionData.sessionId,
          });

          if (error) {
            console.error("Stripe redirect error:", error);
            alert("Something went wrong. Try restarting the app.");
          }
        } catch (err) {
          console.error("Checkout session error:", err);
          alert("Unable to start payment. Please try again.");

          // 🔁 Recover button
          newSelectPayCourier.innerHTML = originalContent;
          newSelectPayCourier.disabled = false;
          document.body.classList.remove("touch-lock");
        }
      });
    });
}
*/
function normalizeStoreName(name) {
  return name.toLowerCase().replace(/[\s']/g, "");
}
function createForm(OrderID) {
  const normalizedID = normalizeStoreName(OrderID);
  const formContainer = document.getElementById("dynamic-form-container");

  // Remove existing wrapper if present
  const existing = document.getElementById(`form-wrapper-${normalizedID}`);
  if (existing) existing.remove();

  // Create and append wrapper
  const wrapper = document.createElement("div");
  wrapper.id = `form-wrapper-${normalizedID}`;
  formContainer.appendChild(wrapper);

  // Render the editable form inside it
  createEditableForm(OrderID, wrapper);
}
const orderDataByStore = {};

function updateOrderForms(ordersArray) {
  ordersArray.forEach(order => {
    const { store_name, first_name, last_name, order_number, pickup_time } = order.fields;
    const normalizedID = normalizeStoreName(store_name);

    // Store data for later use
    orderDataByStore[store_name] = {
      first_name,
      last_name,
      order_number,
      pickup_time
    };

    const wrapper = document.getElementById(`form-wrapper-${normalizedID}`);
    if (!wrapper) {
      console.warn(`Missing wrapper for store: ${store_name}`);
      return;
    }

    const updates = {
      "first-name": { value: first_name, label: "First Name" },
      "last-name": { value: last_name, label: "Last Name" },
      "order-number": { value: order_number, label: "Order Number" },
      "pickup-time": { value: pickup_time, label: "Estimated Pickup Time" }
    };

    Object.entries(updates).forEach(([id, { value, label }]) => {
      const referenceEl = wrapper.querySelector(`#${id}-reference`);
      if (!referenceEl) return;

      const cleanedValue = value?.trim().toLowerCase();
      const isMissing = !value || cleanedValue === "" || cleanedValue === "null" || cleanedValue === "undefined";

      const displayValue = isMissing
        ? '<span class="text-gray-400 italic">Not Available</span>'
        : value;

      const checkColor = isMissing ? "text-red-500" : "text-green-500";
      const checkIcon = isMissing ? "fa-times" : "fa-check";

      referenceEl.innerHTML = `
        <span class="font-medium">${label}:</span> 
        ${displayValue}
        <span class="${checkColor} ml-1"><i class="fas ${checkIcon}"></i></span>
      `;
    });
  });
}
function createEditableForm(OrderID, wrapper) {
  const normalizedID = normalizeStoreName(OrderID);
  wrapper.innerHTML = "";

  const orderData = orderDataByStore[OrderID];
  const fallback = `<span class="text-gray-400 italic">Not Available</span>`;

  const storeLabel = document.createElement("h2");
  storeLabel.textContent = `${OrderID} Order Form`;
  storeLabel.className = "text-center mb-4 text-xl font-semibold text-gray-800";
  wrapper.appendChild(storeLabel);

  const form = document.createElement("form");
  form.id = `form-${normalizedID}`;
  form.dataset.orderAdd = OrderID;

  const nameContainer = document.createElement("div");
  nameContainer.className = "grid grid-cols-2 gap-6 mb-6";

  const nameFields = [
    { id: "first-name", label: "First Name", reference: orderData?.first_name || fallback },
    { id: "last-name", label: "Last Name", reference: orderData?.last_name || fallback }
  ];

  nameFields.forEach(({ id, label, reference }) => {
    const field = document.createElement("div");
    field.className = "flex flex-col";

    const referenceEl = document.createElement("p");
    referenceEl.id = `${id}-reference`;
    referenceEl.dataset.label = label;
    referenceEl.className = "text-xs text-gray-500 mb-1";
    referenceEl.innerHTML = `<span class="font-medium">${label}:</span> ${reference}`;

    const input = document.createElement("input");
    input.id = id;
    input.name = id;
    input.type = "text";
    input.placeholder = `Enter ${label}`;
    input.className = "text-xs mt-1 p-2 border rounded";

    field.appendChild(referenceEl);
    field.appendChild(input);
    nameContainer.appendChild(field);
  });

  form.appendChild(nameContainer);

  const orderFields = [
    { id: "order-number", label: "Order Number", type: "text", reference: orderData?.order_number || fallback },
    { id: "pickup-time", label: "Estimated Pickup Time", type: "datetime-local", reference: orderData?.pickup_time || fallback }
  ];

  const orderContainer = document.createElement("div");
  orderContainer.className = "grid grid-cols-2 gap-6 mb-6";

  orderFields.forEach(({ id, label, type, reference }) => {
    const field = document.createElement("div");
    field.className = "flex flex-col";

    const referenceEl = document.createElement("p");
    referenceEl.id = `${id}-reference`;
    referenceEl.dataset.label = label;
    referenceEl.className = "text-xs text-gray-500 mb-1";
    referenceEl.innerHTML = `<span class="font-medium">${label}:</span> ${reference}`;

    const input = document.createElement("input");
    input.id = id;
    input.name = id;
    input.type = type;
    input.placeholder = `Enter ${label}`;
    input.className = "mt-1 p-2 border rounded";

    field.appendChild(referenceEl);
    field.appendChild(input);
    orderContainer.appendChild(field);
  });

  form.appendChild(orderContainer);

  const submit = document.createElement("button");
  submit.type = "submit";
  submit.textContent = "Submit";
  submit.className = "px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition";
  form.appendChild(submit);
  wrapper.appendChild(form);

  form.addEventListener("submit", (e) => {
    e.preventDefault();

    const phoneNumber = phone_number?.trim();
    if (!phoneNumber) {
      alert("Phone number is missing.");
      return;
    }

    const formData = new FormData();
    formData.append("phone_number", phoneNumber);
    formData.append("store_name", OrderID);
    formData.append("first_name", document.getElementById("first-name").value.trim());
    formData.append("last_name", document.getElementById("last-name").value.trim());
    formData.append("order_number", document.getElementById("order-number").value.trim());
    formData.append("pickup_time", document.getElementById("pickup-time").value);

    fetch('/uploadManual/', {
      method: "POST",
      body: formData
    })
      .then(res => res.json())
      .then(data => {
        alert(data.message);
        if (data.message === "Order updated successfully") {
          orderDataByStore[OrderID] = {
            first_name: formData.get("first_name"),
            last_name: formData.get("last_name"),
            order_number: formData.get("order_number"),
            pickup_time: formData.get("pickup_time")
          };
          createEditableForm(OrderID, wrapper); // re-render with updated reference values
        }
      })
      .catch(err => {
        console.error("Submission failed:", err);
      });
  });
}
// Always show editable form with reference values above inputs
async function getClosestAddress(latitude, longitude, callback) {
    try {
        // Load local filtered GeoJSON file
        const response = await fetch("/static/location_filtered.geojson");
        const geojson = await response.json();

        let closestLocation = null;
        let minDistance = Infinity;

        // Iterate through the filtered address points
        geojson.features.forEach(feature => {
            const [lng, lat] = feature.geometry.coordinates;
            const address = feature.properties.Add_St; // Full street address
            const city = feature.properties.MailingCity; // City
            const state = feature.properties.State; // State

            // Ensure all values exist before constructing the full address
            const fullAddress = `${address}, ${city}, ${state}`;

            const distance = getDistance(latitude, longitude, lat, lng);

            if (distance < minDistance) {
                minDistance = distance;
                closestLocation = fullAddress;
            }
        });

        callback(closestLocation);
    } catch (error) {
        console.error("Error loading location data:", error);
        callback(null);
    }
}

// Haversine formula to calculate distance between two points (latitude/longitude)
function getDistance(lat1, lng1, lat2, lng2) {
    const R = 6371; // Earth radius in km
    const dLat = (lat2 - lat1) * (Math.PI / 180);
    const dLng = (lng2 - lng1) * (Math.PI / 180);
    const a = Math.sin(dLat / 2) ** 2 +
              Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
              Math.sin(dLng / 2) ** 2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}
 </script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDnkk5lsaz0M9WT_dnzvSUt1cCYCbQN-5U&libraries=places,geometry&callback=initMap" defer></script>
</body>
<footer>
    © 2024 DTCH Transport. All rights reserved.
</footer>
</html>

